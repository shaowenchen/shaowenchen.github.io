<!doctype html><html lang=zh dir=ltr><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>使用 DLRover 托管作业进行弹性、容错训练 – 陈少文的网站</title><script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script>
<script defer src=/js/helper/getParents.min.086022fb02d7a1517e33c2670bffb976b3e80bcacd9caeee0c6a586064f20e42.js></script>
<script defer src=/js/helper/fadeinout.min.3ce954c8aea3b69cc5e6f734d8273ba4cd48d3a7987dbdca145849bc4b8fc296.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(e,t){"use strict";if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return t===void 0&&(t=0),this.indexOf(e,t)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(e){if(!e.length)throw new Error("DOM Exception 8");if(e.length===1)return typeof e[0]=="string"?document.createTextNode(e[0]):e[0];for(var t,n=document.createDocumentFragment(),o=e.length,s=-1;++s<o;)t=e[s],n.appendChild(typeof t=="string"?document.createTextNode(t):t);return n}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),document.addEventListener("DOMContentLoaded",function(){var e,t,n,s,o,i,a,r,c,l,d,u,h,m,f,p,v,b,j,y,_,w,O,x,C,k,A,S,M,F,T,z,D,N,L,R,P,H,I,B,V,$,W,U,K,q,Y,G,E=document.querySelector(".navbar__burger"),ie,ae,re,ce,ue,de,le,oe,se,ne,te,pe,fe,he;E?E.addEventListener("click",function(){var n,t=document.querySelector(".navbarm__collapse");t&&(n=t.getAttribute("data-open"),n==="true"?(t.setAttribute("data-open","false"),t.style.maxHeight=0,E.classList.remove("is-active")):(t.setAttribute("data-open","true"),t.style.maxHeight=t.scrollHeight+"px",E.classList.add("is-active")))}):null,q=document.querySelectorAll(".single__contents > table");for(let e=0;e<q.length;e++)M=q[e],F=document.createElement("div"),F.className="table-wrapper",M.parentElement.replaceChild(F,M),F.appendChild(M);V=document.querySelectorAll(".footnote-ref"),B=document.querySelectorAll(".footnote-backref"),V?V.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,B?B.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,s=document.querySelector(".summary__container"),i=document.querySelector(".search-result"),D=document.querySelector(".search-result__close"),D?D.addEventListener("click",function(){i.setAttribute("data-display","none"),s.setAttribute("data-display","block")}):null,document.querySelectorAll(".tab")?document.querySelectorAll(".tab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".tab__link"),s=e.querySelectorAll(".tab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,document.querySelectorAll(".codetab")?document.querySelectorAll(".codetab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".codetab__link"),s=e.querySelectorAll(".codetab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,v=document.getElementById("gtt"),v.style.display="none",v.addEventListener("click",function(){window.document.documentMode?document.documentElement.scrollTop=0:ge(250)});function ge(e){var t=-window.scrollY/(e/15),n=setInterval(function(){window.scrollY!=0?window.scrollBy(0,t):clearInterval(n)},15)}ie=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?v.style.display="block":v.style.display="none"},P=document.querySelectorAll(".expand__button");for(let e=0;e<P.length;e++)P[e].addEventListener("click",function(){var e=this.nextElementSibling;e.style.maxHeight?(e.style.maxHeight=null,this.querySelector("svg").classList.add("expand-icon__right"),this.querySelector("svg").classList.remove("expand-icon__down")):(e.style.maxHeight=e.scrollHeight+"px",this.querySelector("svg").classList.remove("expand-icon__right"),this.querySelector("svg").classList.add("expand-icon__down"))});z=window.pageYOffset||document.documentElement.scrollTop,p=document.querySelector(".toc"),r=p?p.querySelector("#TableOfContents"):null,x=document.getElementById("toggle-toc"),d=document.querySelector(".single__contents"),t=document.querySelector(".navbar"),b=document.querySelector(".toc__flexbox"),j=document.querySelector(".toc__flexbox--outer"),L=document.querySelectorAll(".expand__content"),N=document.querySelectorAll(".box"),o=null,S=JSON.parse("true"),a=JSON.parse('["h2","h3","h4"]'),a?a=a.toString():a="h1, h2, h3, h4, h5, h6",d&&d.querySelectorAll(".tab")?d.querySelectorAll(".tab").forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,L?L.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,N?N.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,window.onscroll=function(){ie();var e=window.pageYOffset||document.documentElement.scrollTop;if(e>z){if(e<250?v.style.display="none":v.style.display="block",e<45)return null;t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.contains("navbar--show")&&t.classList.remove("navbar--show"):t.classList.add("navbar--hide")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&(b.setAttribute("data-position",""),b.classList.contains("hide")||b.classList.add("hide")),j&&(j.setAttribute("data-position",""),j.classList.contains("hide")||j.classList.add("hide"))))}else e<250&&(v.style.display="none"),t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.remove("navbar--hide"):t.classList.contains("navbar--show")||t.classList.add("navbar--show")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&!b.classList.contains("hide")&&b.classList.add("hide"),j&&!j.classList.contains("hide")&&j.classList.add("hide"))),r&&document.documentElement.scrollTop<250&&(!1===S||(r.querySelector("ul")?r.querySelector("ul").querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})}):null));z=e<=0?0:e},A=localStorage.getItem("theme"),T=document.getElementById("root"),ae=document.querySelectorAll(".select-theme"),C=document.querySelectorAll(".select-theme__item"),re=JSON.parse('"dark"'),ce=JSON.parse('"light"'),ue=JSON.parse('"hacker"'),de=JSON.parse('"solarized"'),le=JSON.parse('"kimbie"'),k=function(e){var t=document.getElementsByName("msapplication-TileColor")[0],n=document.getElementsByName("theme-color")[0],s=document.getElementsByName("msapplication-navbutton-color")[0],o=document.getElementsByName("apple-mobile-web-app-status-bar-style")[0];e.includes("dark")?(t.setAttribute("content","#fcfcfa"),n.setAttribute("content","#403E41"),s.setAttribute("content","#403E41"),o.setAttribute("content","#403E41")):e.includes("light")?(t.setAttribute("content","#555"),n.setAttribute("content","#eee"),s.setAttribute("content","#eee"),o.setAttribute("content","#eee")):e.includes("hacker")?(t.setAttribute("content","#e3cd26"),n.setAttribute("content","#252526"),s.setAttribute("content","#252526"),o.setAttribute("content","#252526")):e.includes("solarized")?(t.setAttribute("content","#d3af86"),n.setAttribute("content","#51412c"),s.setAttribute("content","#51412c"),o.setAttribute("content","#51412c")):e.includes("kimbie")&&(t.setAttribute("content","#586e75"),n.setAttribute("content","#eee8d5"),s.setAttribute("content","#eee8d5"),o.setAttribute("content","#eee8d5"))},Y=function(e){if(e===re)return"dark";if(e===ce)return"light";if(e===ue)return"hacker";if(e===de)return"solarized";if(e===le)return"kimbie"},A?(C?C.forEach(function(e){e.text.trim()===A?e.classList.add("is-active"):e.classList.remove("is-active")}):null,k(A)):k(T.className),C?C.forEach(function(e){e.addEventListener("click",function(e){var n,s,t=Y(e.target.text.trim());localStorage.setItem("theme",t),k(t),T.removeAttribute("class"),T.classList.add("theme__"+t),ae.forEach(function(e){e.querySelectorAll("a").forEach(function(e){e.classList&&(e.text.trim()===t?e.classList.contains("is-active")||e.classList.add("is-active"):e.classList.contains("is-active")&&e.classList.remove("is-active"))})}),window.mermaid&&(t==="dark"||t==="hacker"?(mermaid.initialize({theme:"dark"}),location.reload()):(mermaid.initialize({theme:"default"}),location.reload())),n=document.getElementById("utterances"),n&&n.querySelector("iframe").contentWindow.postMessage({type:"set-theme",theme:t==="dark"||t==="hacker"?"photon-dark":t==="kimbie"?"github-dark-orange":"github-light"},"https://utteranc.es"),s=document.querySelectorAll(".twitter-timeline"),s&&window.postMessage({type:"set-twitter-theme",theme:t==="light"||t==="solarized"?"light":"dark"})})}):null,G=JSON.parse('"https://www.chenshaowen.com"'),oe=JSON.parse('"https://www.chenshaowen.com/blog/use-dlrover-to-manage-training-job.html"'),se=JSON.parse('""'),l=null,c=null,n=null,ne=JSON.parse("true"),y=JSON.parse("true"),U=JSON.parse('"main"'),K=JSON.parse('"post"'),te=JSON.parse('"page"'),O=null,ne&&function(){var t=new XMLHttpRequest;K==="publication"&&te!=="page"?t.open("GET",oe+"index.json"):t.open("GET",G+se+"/index.json"),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.onload=function(){t.status===200?(O=new Fuse(JSON.parse(t.response.toString("utf-8")),{keys:K.includes("publication")?["title","abstract"]:["title","description","content"],includeMatches:y,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=O):console.error("["+t.status+"]Error:",t.statusText)},t.send()}();function me(e,t){var n,s,o=document.createElement("li");o.className="search-result__item",n=document.createElement("a"),n.innerHTML=t.item.title,n.setAttribute("class","search-result__item--title"),n.setAttribute("href",t.item.permalink),s=document.createElement("div"),s.setAttribute("class","search-result__item--desc"),t.item.description?s.innerHTML=t.item.description:t.item.content&&(s.innerHTML=t.item.content.substring(0,225)),o.appendChild(n),o.appendChild(s),e.appendChild(o)}function be(e,t){var n,s,o,i=document.createElement("li");if(i.className="search-result__item",n=null,o=document.createElement("a"),o.innerHTML=t.item.title,o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri),t.matches&&t.matches.length){for(s=0;s<t.matches.length;s++)"title"===t.matches[s].key&&(o=document.createElement("a"),o.innerHTML=g(t.matches[s].value,t.matches[s].indices),o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri)),"description"===t.matches[s].key?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.description,t.matches[s].indices)):"content"===t.matches[s].key?n||(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.content.substring(0,150),t.matches[s].indices)):t.item.description?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.description):(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.content.substring(0,150));i.appendChild(o),n&&i.appendChild(n),i&&e.appendChild(i)}}function Q(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var t,o,i=document.createElement("li"),s=document.createElement("a");s.setAttribute("href",e.uri),s.setAttribute("class","dropdown-item"),s.appendChild(i),o=document.createElement("div"),o.innerHTML=e.title,o.setAttribute("class","menu-item__title"),t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),e.description?t.innerHTML=e.description:e.content&&(t.innerHTML=e.content.substring(0,150)),i.appendChild(o),i.appendChild(t),n.appendChild(s)}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function Z(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var s,o,a=document.createElement("li"),i=document.createElement("a"),t=null;if(i.setAttribute("href",e.item.uri),i.setAttribute("class","dropdown-item"),i.appendChild(a),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","menu-item__title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.content.substring(0,150));a.appendChild(o),t&&a.appendChild(t),n.appendChild(i)}}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function J(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length>0?t.forEach(function(e){var t=document.createElement("a");t.setAttribute("href",e.uri),t.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+e.title+'</div><div class="mobile-search__item--desc">'+(e.description?e.description:e.content)+"</div></div>",n.appendChild(t)}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function ve(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length?t.forEach(function(e){var s,o,i=document.createElement("li"),a=document.createElement("a"),t=null;if(a.setAttribute("href",e.item.uri),a.appendChild(i),i.setAttribute("class","mobile-search__item"),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","mobile-search__item--title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.content.substring(0,150));i.appendChild(o),t&&i.appendChild(t),n.appendChild(a)}}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function g(e,t){if(!t)return e;var n="",s=0;return t.forEach(function(t){if(t[0]===t[1])return null;n+=""+e.substring(s,t[0])+'<span class="search__highlight">'+e.substring(t[0],t[1]+1)+"</span>",s=t[1]+1}),n+=e.substring(s),n}u=document.getElementById("search"),H=document.getElementById("search-mobile"),m=document.getElementById("search-results"),u?u.addEventListener("input",function(e){if(!e.target.value|window.innerWidth<770)return m?m.setAttribute("class","dropdown"):null,i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null,null;n=e.target.value;var o,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),o=m.querySelectorAll(".dropdown-item"),o?o.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,u?u.addEventListener("blur",function(){if(window.innerWidth<770)return null;m?m.setAttribute("class","dropdown"):null}):null,u?u.addEventListener("click",function(e){if(window.innerWidth<770)return null;if(!e.target.value)return m?m.setAttribute("class","dropdown"):null,null;n=e.target.value;var s,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),s=m.querySelectorAll(".dropdown-item"),s?s.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,pe=document.getElementById("search-menu"),fe=document.querySelector("#search-menu .dropdown-item.is-active"),e=null,he=null,I=350,u?u.addEventListener("keydown",function(t){if(window.innerWidth<770)return null;t.key==="Escape"&&(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null);var n=document.querySelectorAll("#search-menu .dropdown-item"),o=t.which||t.keyCode;if(!n||!n.length)return null;if(t.key==="ArrowDown"||o===40){e===null?(e=0,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===n.length-1?0:e+1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t>0?document.querySelector(".search-content").scrollTop+=n[e].getBoundingClientRect().height:e===0&&(document.querySelector(".search-content").scrollTop=0)}else if(t.key==="ArrowUp"||o===38){e===null?(e=n.length-1,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===0?n.length-1:e-1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t<0?document.querySelector(".search-content").scrollTop-=n[e].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=t+n[e].getBoundingClientRect().height}else t.key==="Enter"||o===13?n[e]&&n[e].getAttribute("href")&&(location.href=n[e].getAttribute("href")):(t.key==="Escape"||o===27)&&(t.target.value=null,l&&l.classList.remove("is-active"))}):null,H?H.addEventListener("input",function(e){if(!e.target.value){let e=document.getElementById("search-mobile-results");for(;e.firstChild;)e.removeChild(e.firstChild);return null}n=e.target.value;var t=O.search(e.target.value);J(n,t),y?ve(n,t):J(n,t)}):null,f=document.querySelector("#search-mobile"),R=document.querySelector(".mobile-search"),$=document.querySelectorAll(".navbar-search"),W=document.querySelector("#search-mobile-close"),w=document.querySelector("#search-mobile-container"),h=document.querySelector("#search-mobile-results"),_=document.querySelector("html"),R&&(R.style.display="none"),$?$.forEach(function(e){e.addEventListener("click",function(){w&&(w.style.display="block"),f&&f.focus(),_&&(_.style.overflowY="hidden")})}):null,W?W.addEventListener("click",function(){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}):null,f?f.addEventListener("keydown",function(e){var t=e.which||e.keyCode;if(e.key==="Escape"||t===27){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}}):null;function ee(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){me(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}function X(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){be(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}})</script><link rel=stylesheet href=/css/main.min.css><meta name=description content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=keywords content="博文,DLRover,训练,Kubernetes,弹性训练,容错训练"><meta name=created content="2024-08-17T00:00:00+0000"><meta name=modified content="2024-08-17T00:00:00+0000"><meta property="article:published_time" content="2024-08-17T00:00:00+0000"><meta name=author content="微信公众号"><meta property="og:site_name" content="陈少文的网站"><meta property="og:title" content="使用 DLRover 托管作业进行弹性、容错训练"><meta property="og:url" content="https://www.chenshaowen.com/blog/use-dlrover-to-manage-training-job.html"><meta property="og:type" content="article"><meta property="og:description" content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=generator content="Hugo 0.110.0"><meta name=msapplication-TileColor content="#fff"><meta name=theme-color content="#fff"><meta name=msapplication-navbutton-color content="#fff"><meta name=apple-mobile-web-app-status-bar-style content="#fff"><link rel=canonical href=https://www.chenshaowen.com/blog/use-dlrover-to-manage-training-job.html><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用 DLRover 托管作业进行弹性、容错训练","datePublished":"2024-08-17T00:00:00Z","dateModified":"2024-08-17T00:00:00Z","url":"https://www.chenshaowen.com/blog/use-dlrover-to-manage-training-job.html","description":"1. 分布式训练面临的问题 预估训练资源困难，无法自动化 需要多少算力、需要多少时间、需要多少带宽、需要多少 CPU、需要多少内存，如果没有足够的积累，很难估算准确。导致的结果就是，超额申请、超额分配，造成极大的资源浪费。 需要去沉淀和提供解决方案。 故","keywords":["博文","DLRover","训练","Kubernetes","弹性训练","容错训练"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.chenshaowen.com"},"publisher":{"@type":"Organization","name":"陈少文的网站","url":"https://www.chenshaowen.com"}}</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MTW4XNQ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>var dataLayer=window.dataLayer=window.dataLayer||[];dataLayer.push({page:"使用 DLRover 托管作业进行弹性、容错训练",categories:"only examples about your dataLayer"})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-MTW4XNQ")</script></head><body id=root class=theme__light><script>var localTheme=localStorage.getItem("theme");localTheme&&(document.getElementById("root").className="theme__"+localTheme)</script><div id=container><div class=wrapper data-type=post data-kind=page><nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr><div class=navbar__brand><a href=/ title=主页 rel=home class=navbar__logo-link><img src=/logo.png alt=Home class=navbar__logo></a>
<a href=/ title=主页 rel=home class=navbar__title-link><h6 class=navbar__title>陈少文的网站</h6></a></div><div class="theme theme-mobile" data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div><div id=search-mobile-container class="mobile-search hide" data-dir=ltr><div class=mobile-search__top><input id=search-mobile type=text aria-label="Mobile Search" placeholder=搜索 class=mobile-search__top--input><div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg></div></div><div id=search-mobile-results class=mobile-search__body></div></div><a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><div class=navbarm__collapse data-open=false><ul dir=ltr><li class=navbarm__menu--item><a href=https://github.com/shaowenchen/ops/>Ops 项目</a></li><li class=navbarm__menu--item><a href=/tags>标签</a></li><li class=navbarm__menu--item><a href=/presentation>演示文档</a></li><li class=navbarm__menu--item><a href=/>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/kubernetes-101/>Kubernetes 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/devops-101/>DevOps 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/microservices-101/>MicroServices 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/aigc/>AIGC</a></li><li class=navbarm__menu--item><a href=/about.html>关于</a></li><li class=navbarm__menu--item><a href=/atom.xml>订阅</a></li></ul></div><div class=navbar__menu><div class=theme data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><a href=https://github.com/shaowenchen/ops/ class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>Ops 项目</a>
<a href=/tags class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>标签</a>
<a href=/presentation class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>演示文档</a><div class="navbar__dropdown navbar__slide-down" data-ani=true><a href=/ class=navbar__menu-item dir=ltr>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a><div class=navbar__dropdown--content><a href=/kubernetes-101/ class=navbar__dropdown--item dir=ltr>Kubernetes 101</a>
<a href=/devops-101/ class=navbar__dropdown--item dir=ltr>DevOps 101</a>
<a href=/microservices-101/ class=navbar__dropdown--item dir=ltr>MicroServices 101</a>
<a href=/aigc/ class=navbar__dropdown--item dir=ltr>AIGC</a></div></div><a href=/about.html class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>关于</a>
<a href=/atom.xml class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>订阅</a></div></nav><main class="single__main main-main"><nav class="breadcrumb hide" aria-label=breadcrumbs><script>document.querySelector(".breadcrumb").classList.remove("hide")</script><ol><li><a href=https://www.chenshaowen.com/ class=capitalize>陈少文的网站</a></li><li><a href=https://www.chenshaowen.com/post/ class=capitalize>Posts</a></li><li class=is-active><span>使用 DLRover 托管作业进行弹性、容错训练</span></li></ol></nav><div class=single><div class=single__nojs>Please enable Javascript to view the contents</div><script>document.querySelector(".single").classList.remove("hide"),document.querySelector(".single__nojs").classList.add("hide")</script><h2 class=single__title data-ani=true>使用 DLRover 托管作业进行弹性、容错训练</h2><h3 class=single__subtitle></h3><div class=single__meta><div class=single__infos><time class=single__info title=创建日期>📅&nbsp;2024年08月17日</time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长>☕&nbsp;12&nbsp;分钟</span>
<span class=single__info></span></div><ul class="single__tags caption">🏷️<li><a href=https://www.chenshaowen.com/tags/%E5%8D%9A%E6%96%87/ class=single__tag title=博文>#博文</a></li><li><a href=https://www.chenshaowen.com/tags/dlrover/ class=single__tag title=DLRover>#DLRover</a></li><li><a href=https://www.chenshaowen.com/tags/%E8%AE%AD%E7%BB%83/ class=single__tag title=训练>#训练</a></li><li><a href=https://www.chenshaowen.com/tags/kubernetes/ class=single__tag title=Kubernetes>#Kubernetes</a></li><li><a href=https://www.chenshaowen.com/tags/%E5%BC%B9%E6%80%A7%E8%AE%AD%E7%BB%83/ class=single__tag title=弹性训练>#弹性训练</a></li><li><a href=https://www.chenshaowen.com/tags/%E5%AE%B9%E9%94%99%E8%AE%AD%E7%BB%83/ class=single__tag title=容错训练>#容错训练</a></li></ul></div><article class=single__contents data-dir=ltr data-ani=true><h2 id=1-分布式训练面临的问题>1. 分布式训练面临的问题</h2><ul><li>预估训练资源困难，无法自动化</li></ul><p>需要多少算力、需要多少时间、需要多少带宽、需要多少 CPU、需要多少内存，如果没有足够的积累，很难估算准确。导致的结果就是，超额申请、超额分配，造成极大的资源浪费。</p><p>需要去沉淀和提供解决方案。</p><ul><li>故障率高，排查困难，缺少高效的工具</li></ul><p>算法同学不太了解 Kubernetes 基础设施，运维同学不太了解训练过程，想要当好 AI Infra Engineer 不是件容易的事。</p><p>训练场景下的故障率非常高，如何快速、准确地定位并解决故障，是我们需要思考的问题。</p><ul><li>单个节点发生故障，全部节点停止训练，需要人值守才能及时拉起作业继续训练</li></ul><p>训练作业类似 Kubernetes 中的 StatefulSet。分布式训练中，由于数据、模型、流水线、张量等并行技术的存在，每个节点在训练过程中并不是完全对等的。</p><p>从发生故障到恢复训练，有很多技术点可以落地到工具、产品上。</p><p>同时，如果是非工作时间段发生故障，我们无法及时响应，模型迭代延期、AI 加速卡闲置都是巨大损失。能不能自动发现故障、自动恢复训练，也是值得研究的问题。</p><h2 id=2-什么是-dlrover>2. 什么是 DLRover</h2><p>DLRover 就试图解决上诉问题的一个方案。下面是 <a href=https://github.com/intelligent-machine-learning/dlrover>https://github.com/intelligent-machine-learning/dlrover</a> 项目的架构图。</p><p><img src=/blog/images/2024/08/dlrover-overview.jpg alt></p><p>管理平面的组件：</p><ul><li>Brain Service，负责资源弹性优化。基于实时采集的训练速度和各个节点负载来自动优化作业的资源配置，还有一个事件采集服务 k8smonitor</li><li>Elastic Controller，是 Kubernetes 对象 ElasticJob、ScalePlan 的控制器</li></ul><p>CRD 对象:</p><ul><li>ElasticJob 用来描述弹性训练作业</li><li>ScalePlan 用于在 Brain、DLRover Master、Elastic Controller 之间传递信息，以做出优化调整。一般不需要主动创建，DLRover 会自动管理</li></ul><p>训练作业相关的组件：</p><ul><li>DLRover Job Master，负责弹性调度、容错自愈。每个训练作业拥有一个 master 节点， master 节点负责训练速度采集、节点负载收集、训练样本管理和弹性调度。</li><li>Elastic Agent 不用单独部署，是需要使用 <code>dlrover-run</code> 命令托管训练作业，负责与训练框架协调来支持训练的容错和弹性。每个节点上都有一个 Elastic Agent， Agent 从 master 上获取作业当前运行的节点信息，通知训练框架更新分布式训练状态。 Agent 还负责从 master 获取训练样本信息来供训练框架迭代模型，从而使训练样本分片支持 worker 的弹性。</li></ul><p>下面这张图是其容错的架构设计:</p><p><img src=/blog/images/2024/08/dlrover-elasticjob.png alt></p><p>DLRover Job Master 负责探测、处理故障，<code>dlrover-run</code> 作为 Agent 上报状态信息。</p><h2 id=3-dlrover-run-命令及参数>3. dlrover-run 命令及参数</h2><ul><li>安装 dlrover 包</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install dlrover<span class=o>[</span>torch<span class=o>]</span> -U -i https://mirrors.aliyun.com/pypi/simple
</span></span></code></pre></td></tr></table></div></div><ul><li><code>dlrover-run</code> 只是对 <code>dlrover.trainer.torch.main</code> 的封装</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /usr/local/bin/dlrover-run
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/usr/local/bin/python</span>
</span></span><span class=line><span class=cl><span class=c1># -*- coding: utf-8 -*-</span>
</span></span><span class=line><span class=cl>import re
</span></span><span class=line><span class=cl>import sys
</span></span><span class=line><span class=cl>from dlrover.trainer.torch.main import main
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nv>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span>:
</span></span><span class=line><span class=cl>    sys.argv<span class=o>[</span>0<span class=o>]</span> <span class=o>=</span> re.sub<span class=o>(</span>r<span class=s1>&#39;(-script\.pyw|\.exe)?$&#39;</span>, <span class=s1>&#39;&#39;</span>, sys.argv<span class=o>[</span>0<span class=o>])</span>
</span></span><span class=line><span class=cl>    sys.exit<span class=o>(</span>main<span class=o>())</span>
</span></span></code></pre></td></tr></table></div></div><ul><li>查看参数</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dlrover-run  --help
</span></span><span class=line><span class=cl>用法: dlrover-run <span class=o>[</span>-h<span class=o>]</span> <span class=o>[</span>--nnodes NNODES<span class=o>]</span> <span class=o>[</span>--nproc-per-node NPROC_PER_NODE<span class=o>]</span> <span class=o>[</span>--rdzv-backend RDZV_BACKEND<span class=o>]</span> <span class=o>[</span>--rdzv-endpoint RDZV_ENDPOINT<span class=o>]</span>
</span></span><span class=line><span class=cl>                   <span class=o>[</span>--rdzv-id RDZV_ID<span class=o>]</span> <span class=o>[</span>--rdzv-conf RDZV_CONF<span class=o>]</span> <span class=o>[</span>--standalone<span class=o>]</span> <span class=o>[</span>--max-restarts MAX_RESTARTS<span class=o>]</span>
</span></span><span class=line><span class=cl>                   <span class=o>[</span>--monitor-interval MONITOR_INTERVAL<span class=o>]</span> <span class=o>[</span>--start-method <span class=o>{</span>spawn,fork,forkserver<span class=o>}]</span> <span class=o>[</span>--role ROLE<span class=o>]</span> <span class=o>[</span>-m<span class=o>]</span> <span class=o>[</span>--no-python<span class=o>]</span>
</span></span><span class=line><span class=cl>                   <span class=o>[</span>--run-path<span class=o>]</span> <span class=o>[</span>--log-dir LOG_DIR<span class=o>]</span> <span class=o>[</span>-r REDIRECTS<span class=o>]</span> <span class=o>[</span>-t TEE<span class=o>]</span> <span class=o>[</span>--node-rank NODE_RANK<span class=o>]</span> <span class=o>[</span>--master-addr MASTER_ADDR<span class=o>]</span>
</span></span><span class=line><span class=cl>                   <span class=o>[</span>--master-port MASTER_PORT<span class=o>]</span> <span class=o>[</span>--local-addr LOCAL_ADDR<span class=o>]</span> <span class=o>[</span>--network-check<span class=o>]</span> <span class=o>[</span>--node-unit NODE_UNIT<span class=o>]</span> <span class=o>[</span>--auto_config<span class=o>]</span>
</span></span><span class=line><span class=cl>                   <span class=o>[</span>--auto_tunning<span class=o>]</span> <span class=o>[</span>--exclude-straggler<span class=o>]</span> <span class=o>[</span>--save_at_breakpoint<span class=o>]</span> <span class=o>[</span>--accelerator <span class=o>{</span>nvidia.com/gpu,ascend-npu<span class=o>}]</span>
</span></span><span class=line><span class=cl>                   training_script ...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Torch Distributed Elastic Training Launcher
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>位置参数:
</span></span><span class=line><span class=cl>  training_script       启动并行执行的训练程序/脚本的完整路径，后跟训练脚本的所有参数。
</span></span><span class=line><span class=cl>  training_script_args  训练脚本的参数
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>可选参数:
</span></span><span class=line><span class=cl>  -h，--help            显示帮助信息并退出
</span></span><span class=line><span class=cl>  --nnodes NNODES       节点数量或节点范围，格式为 &lt;minimum_nodes&gt;:&lt;maximum_nodes&gt;。
</span></span><span class=line><span class=cl>  --nproc-per-node NPROC_PER_NODE，--nproc_per_node NPROC_PER_NODE
</span></span><span class=line><span class=cl>                        每个节点的工作进程数量；支持的值：<span class=o>[</span>auto，cpu，gpu，int<span class=o>]</span>。
</span></span><span class=line><span class=cl>  --rdzv-backend RDZV_BACKEND，--rdzv_backend RDZV_BACKEND
</span></span><span class=line><span class=cl>                        Rendezvous 后端。
</span></span><span class=line><span class=cl>  --rdzv-endpoint RDZV_ENDPOINT，--rdzv_endpoint RDZV_ENDPOINT
</span></span><span class=line><span class=cl>                        Rendezvous 后端的端点；通常格式为 &lt;host&gt;:&lt;port&gt;。
</span></span><span class=line><span class=cl>  --rdzv-id RDZV_ID，--rdzv_id RDZV_ID
</span></span><span class=line><span class=cl>                        用户定义的组 ID。
</span></span><span class=line><span class=cl>  --rdzv-conf RDZV_CONF，--rdzv_conf RDZV_CONF
</span></span><span class=line><span class=cl>                        附加的 rendezvous 配置（&lt;key1&gt;<span class=o>=</span>&lt;value1&gt;,&lt;key2&gt;<span class=o>=</span>&lt;value2&gt;,...）。
</span></span><span class=line><span class=cl>  --standalone          启动一个本地独立的 rendezvous 后端，使用 C10d TCP 存储在端口 <span class=m>29400</span> 上。用于启动单节点、多工作进程作业时非常有用。如果指定，则 --rdzv-backend、--rdzv-endpoint、--rdzv-id 会被自动分配；任何显式设置的值将被忽略。
</span></span><span class=line><span class=cl>  --max-restarts MAX_RESTARTS，--max_restarts MAX_RESTARTS
</span></span><span class=line><span class=cl>                        最大的工作进程组重启次数，超出此次数将失败。
</span></span><span class=line><span class=cl>  --monitor-interval MONITOR_INTERVAL，--monitor_interval MONITOR_INTERVAL
</span></span><span class=line><span class=cl>                        监控工作进程状态的时间间隔，单位为秒。
</span></span><span class=line><span class=cl>  --start-method <span class=o>{</span>spawn,fork,forkserver<span class=o>}</span>，--start_method <span class=o>{</span>spawn,fork,forkserver<span class=o>}</span>
</span></span><span class=line><span class=cl>                        创建工作进程时使用的多进程启动方法。
</span></span><span class=line><span class=cl>  --role ROLE           工作进程的用户定义角色。
</span></span><span class=line><span class=cl>  -m，--module          将每个进程更改为将启动脚本解释为 Python 模块，行为与 <span class=s1>&#39;python -m&#39;</span> 相同。
</span></span><span class=line><span class=cl>  --no-python，--no_python
</span></span><span class=line><span class=cl>                        跳过在训练脚本前添加 <span class=s1>&#39;python&#39;</span> - 直接执行脚本。如果脚本不是 Python 脚本时非常有用。
</span></span><span class=line><span class=cl>  --run-path，--run_path
</span></span><span class=line><span class=cl>                        使用 runpy.run_path 在相同解释器中运行训练脚本。脚本必须提供为绝对路径（例如 /abs/path/script.py）。优先于 --no-python。
</span></span><span class=line><span class=cl>  --log-dir LOG_DIR，--log_dir LOG_DIR
</span></span><span class=line><span class=cl>                        用于日志文件的基础目录（例如 /var/log/torch/elastic）。相同的目录会被多个运行重用（会创建一个以 rdzv_id 为前缀的唯一作业级子目录）。
</span></span><span class=line><span class=cl>  -r REDIRECTS，--redirects REDIRECTS
</span></span><span class=line><span class=cl>                        将标准流重定向到日志目录中的日志文件（例如 <span class=o>[</span>-r 3<span class=o>]</span> 重定向所有工作进程的 stdout+stderr，<span class=o>[</span> -r 0:1,1:2<span class=o>]</span> 重定向本地 rank <span class=m>0</span> 的 stdout 和本地 rank <span class=m>1</span> 的 stderr）。
</span></span><span class=line><span class=cl>  -t TEE，--tee TEE     将标准流分流到日志文件和控制台（参见 --redirects 格式）。
</span></span><span class=line><span class=cl>  --node-rank NODE_RANK，--node_rank NODE_RANK
</span></span><span class=line><span class=cl>                        多节点分布式训练中节点的排名。
</span></span><span class=line><span class=cl>  --master-addr MASTER_ADDR，--master_addr MASTER_ADDR
</span></span><span class=line><span class=cl>                        主节点（rank 0）的地址，仅用于静态 rendezvous。它应该是 rank <span class=m>0</span> 的 IP 地址或主机名。对于单节点多进程训练，--master-addr 可以简单地是 127.0.0.1；IPv6 应该是 <span class=sb>`</span><span class=o>[</span>0:0:0:0:0:0:0:1<span class=o>]</span><span class=sb>`</span> 的模式。
</span></span><span class=line><span class=cl>  --master-port MASTER_PORT，--master_port MASTER_PORT
</span></span><span class=line><span class=cl>                        主节点（rank 0）上用于分布式训练期间通信的端口。仅用于静态 rendezvous。
</span></span><span class=line><span class=cl>  --local-addr LOCAL_ADDR，--local_addr LOCAL_ADDR
</span></span><span class=line><span class=cl>                        本地节点的地址。如果指定，将使用给定的地址进行连接。否则，将查找本地节点地址。否则，默认为本地计算机的 FQDN。
</span></span><span class=line><span class=cl>  --network-check，--network_check
</span></span><span class=line><span class=cl>                        是否在启动训练过程前检查网络。
</span></span><span class=line><span class=cl>  --node_unit NODE_UNIT，--node-unit NODE_UNIT
</span></span><span class=line><span class=cl>                        要调度的节点数量单位。调度的节点数量应为 node_unit 的倍数。
</span></span><span class=line><span class=cl>  --auto_config，--auto-config
</span></span><span class=line><span class=cl>                        是否自动配置 nnodes 和 nproc_per_nodes。
</span></span><span class=line><span class=cl>  --auto_tunning，--auto-tunning
</span></span><span class=line><span class=cl>                        是否自动调优并行配置。
</span></span><span class=line><span class=cl>  --exclude-straggler，--exclude_straggler
</span></span><span class=line><span class=cl>                        布尔值，如果节点是滞后节点且参数为 True，则该节点将退出。该参数仅在 network-check 为 True 时有效。
</span></span><span class=line><span class=cl>  --save_at_breakpoint，--save-at-breakpoint
</span></span><span class=line><span class=cl>                        布尔值。如果为 True，主进程中的代理将在训练过程失败时将检查点保存到存储中。
</span></span><span class=line><span class=cl>  --accelerator <span class=o>{</span>nvidia.com/gpu,ascend-npu<span class=o>}</span>
</span></span><span class=line><span class=cl>                        机器的加速器芯片类型。
</span></span></code></pre></td></tr></table></div></div><h2 id=4-使用-dlrover-快速托管训练>4. 使用 DLRover 快速托管训练</h2><ul><li>启动测试容器</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nerdctl -n k8s.io run --rm -it --gpus all  registry.cn-beijing.aliyuncs.com/intell-ai/dlrover:pytorch-example bash
</span></span></code></pre></td></tr></table></div></div><ul><li>直接运行 Python 脚本</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>RANK</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>LOCAL_RANK</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>WORLD_SIZE</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MASTER_ADDR</span><span class=o>=</span><span class=s2>&#34;localhost&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>MASTER_PORT</span><span class=o>=</span><span class=m>1234</span>
</span></span><span class=line><span class=cl>python3 examples/pytorch/mnist/cnn_train.py --num_epochs <span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                                            --training_data /data/mnist_png/training/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                                            --validation_data /data/mnist_png/testing/
</span></span></code></pre></td></tr></table></div></div><p>我发现 <code>--no-cuda</code> 参数无效，只能通过控制 GPU 挂载来指定仅使用 CPU 训练。</p><ul><li>使用 DLRover 托管训练</li></ul><p>不用设置环境变量直接运行即可，DLRover 帮我们省去了设置环境变量的步骤。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dlrover-run --network-check --nnodes<span class=o>=</span><span class=m>1</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  --nproc_per_node<span class=o>=</span><span class=m>1</span> --max_restarts<span class=o>=</span><span class=m>3</span>  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  examples/pytorch/mnist/cnn_train.py --num_epochs 1<span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  --training_data /data/mnist_png/training/ <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>                  --validation_data /data/mnist_png/testing/
</span></span></code></pre></td></tr></table></div></div><p>由于使用的是单个容器进行训练，需要将 <code>--nnodes</code> 参数设置为 1，否则 DLRover 会一直等待新节点加入，<code>max_restarts</code> 设置为 3 允许失败之后重试 3 次。</p><h2 id=5-集群安装-dlrover-相关组件>5. 集群安装 DLRover 相关组件</h2><p>这里安装的是 DLRover 最新的 Release 版本 v0.3.7 ，是今年 5.13 发布的。</p><ul><li>下载安装包</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>wget https://github.com/intelligent-machine-learning/dlrover/archive/refs/tags/v0.3.7.tar.gz
</span></span><span class=line><span class=cl>tar xvf v0.3.7.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> dlrover-0.3.7
</span></span></code></pre></td></tr></table></div></div><ul><li>安装 ElasticJob Controller Manager</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover apply -k dlrover/go/operator/config/manifests/bases
</span></span></code></pre></td></tr></table></div></div><p>需要注意的是默认的权限设置在 dlrover 空间下，如果想在其他空间使用，则需要创建与之对应的 default-role.yaml。</p><ul><li>查看工作负载</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>dlrover-controller-manager-6d676545d7-nrc4g   2/2     Running   <span class=m>0</span>          73s
</span></span></code></pre></td></tr></table></div></div><ul><li>查看 CRD</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get crd <span class=p>|</span>grep elastic
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>elasticjobs.elastic.iml.github.io                     2024-08-15T07:27:29Z
</span></span><span class=line><span class=cl>scaleplans.elastic.iml.github.io                      2024-08-15T07:27:29Z
</span></span></code></pre></td></tr></table></div></div><p>如果仅使用训练 worker 自动恢复的功能，那么不用安装 Brain 等组件。因为 Brain 依赖 MySQL，仅为测试，下面部署 MySQL 的方式并不可靠。</p><ul><li>安装 DLRover Brain</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover apply -f dlrover/go/brain/manifests/k8s
</span></span></code></pre></td></tr></table></div></div><ul><li>创建数据库表</li></ul><p>查看 MySQL Pod 名</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover get pod  <span class=p>|</span>grep mysql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mysql-85dd8c7fdb-kdxtz                                  1/1     Running            <span class=m>0</span>              7m41s
</span></span></code></pre></td></tr></table></div></div><p>执行命令，创建数据库以及初始化表</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it mysql-85dd8c7fdb-kdxtz --namespace dlrover -- bash
</span></span><span class=line><span class=cl><span class=nb>cd</span> dlrover
</span></span><span class=line><span class=cl>mysql -uroot -proot &lt; dlrover-tables.sql
</span></span></code></pre></td></tr></table></div></div><ul><li>重启 Brain 相关组件</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover rollout restart deployment dlrover-brain dlrover-kube-monitor
</span></span></code></pre></td></tr></table></div></div><ul><li>查看工作负载</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                                      READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>dlrover-brain-689c4b77d4-bqcz9                            1/1     Running   <span class=m>0</span>          3m55s
</span></span><span class=line><span class=cl>dlrover-controller-manager-6b6f9dcd88-2h2fs               2/2     Running   <span class=m>0</span>          6m19s
</span></span><span class=line><span class=cl>dlrover-kube-monitor-69ff5f99f4-gwqws                     1/1     Running   <span class=m>0</span>          3m55s
</span></span><span class=line><span class=cl>mysql-799f94cbfd-864th                                    1/1     Running   <span class=m>0</span>          4m17s
</span></span></code></pre></td></tr></table></div></div><h2 id=6-elasticjob-创建训练作业>6. ElasticJob 创建训练作业</h2><h3 id=61-elasticjob-对象定义>6.1 ElasticJob 对象定义</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ElasticJobSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// DistributionStrategy 指定作业的分发策略。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 目前，策略支持 parameter-server 和 ring-allreduce。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>DistributionStrategy</span> <span class=kt>string</span> <span class=s>`json:&#34;distributionStrategy,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// ResourceLimits 指定作业的最大资源。例如，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// {&#34;cpu&#34;: &#34;100&#34;, &#34;memory&#34;: &#34;10240Mi&#34;} 表示最大 CPU 核数为 100，所有 Pod 的最大内存为 10Gi。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ResourceLimits</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span> <span class=s>`json:&#34;resourceLimits,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// OptimizeMode 指定优化作业资源的模式。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 目前支持 &#34;manual&#34;（手动）、&#34;single-job&#34;（单作业）、&#34;cluster&#34;（集群）。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>OptimizeMode</span> <span class=kt>string</span> <span class=s>`json:&#34;optimizeMode,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// BrainService 指定 Brain 的地址，以优化作业资源。Brain 可以单独部署，配置在 ElasticJobSpec 中。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 仅在 optimizeMode 为 cluster 时使用。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>BrainService</span> <span class=kt>string</span> <span class=s>`json:&#34;brainService,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// EnableElasticScheduling 启动 Pod 的弹性调度。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>EnableElasticScheduling</span> <span class=kt>bool</span> <span class=s>`json:&#34;enableElasticScheduling,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// EnableDynamicSharding 启动数据集的动态分片。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>EnableDynamicSharding</span> <span class=kt>bool</span> <span class=s>`json:&#34;enableDynamicSharding,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// 一个从 ReplicaType（类型）到 ReplicaSpec（值）的映射。指定训练集群的配置。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 例如，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   {
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     &#34;PS&#34;: ReplicaSpec,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//     &#34;Worker&#34;: ReplicaSpec,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//   }
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ReplicaSpecs</span> <span class=kd>map</span><span class=p>[</span><span class=nx>commonv1</span><span class=p>.</span><span class=nx>ReplicaType</span><span class=p>]</span><span class=o>*</span><span class=nx>ReplicaSpec</span> <span class=s>`json:&#34;replicaSpecs&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Envs 指定作业 Pod 的环境变量。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Envs</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>corev1</span><span class=p>.</span><span class=nx>EnvVar</span> <span class=s>`json:&#34;envs,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>其中的 ReplicaSpec 定义如下:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kd>type</span> <span class=nx>ReplicaSpec</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>commonv1</span><span class=p>.</span><span class=nx>ReplicaSpec</span> <span class=s>`json:&#34;,inline&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// RestartCount 是重新启动失败副本的次数。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RestartCount</span> <span class=kt>int</span> <span class=s>`json:&#34;restartCount,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// AutoScale 是一个标志，用于自动调整副本数量和每个副本的资源。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>AutoScale</span> <span class=kt>bool</span> <span class=s>`json:&#34;autoScale,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// RestartTimeout 是等待挂起副本的时间。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>RestartTimeout</span> <span class=kt>int</span> <span class=s>`json:&#34;restartTimeout,omitempty&#34;`</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Priority 支持 high/low/0.5。0.5 表示一半的工作节点具有高优先级，
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 另一半工作节点具有低优先级。默认值为 low。
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Priority</span> <span class=kt>string</span> <span class=s>`json:&#34;priority,omitempty&#34;`</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>下面对其中的一些关键字段进行说明。</p><h3 id=62-distributionstrategy-策略>6.2 DistributionStrategy 策略</h3><p>有两种 DistributionStrategy 策略：</p><ul><li>ParameterServerStrategy</li></ul><p>适用于使用 TensorFlow 的 <code>parameter_server</code> 作业，https://www.tensorflow.org/tutorials/distribute/parameter_server_training 。</p><ul><li>AllreduceStrategy</li></ul><p>适用于 Horovod 的 <code>ring-allreduce</code> 和 PyTorch 的 <code>DistributedDataParallel</code> 作业。</p><p>从这里可以看出，如果训练使用的是 PyTorch 就选 AllreduceStrategy，使用的是 TensorFlow 就选 ParameterServerStrategy。</p><p>PyTorch DistributedDataParallel 的 Allreduce 策略下，预训练过程中会保持 Global Batch Size 固定，也就不需要增删节点，不涉及弹性训练，主要使用的是 Job Master 的容错自愈能力。</p><p>TensorFlow <code>parameter_server</code> 的 ParameterServerStrategy 策略下，节点数可以调整，依赖 Brain 服务进行弹性训练。</p><h3 id=63-optimizemode-模式>6.3 optimizeMode 模式</h3><p>有三种 optimizeMode 模式:</p><ul><li>manual</li></ul><p>调试模式，修改正在运行的作业时，作业不会重启，用来探索更佳的作业参数配置。</p><ul><li>single-job</li></ul><p>测试、快速验证的场景，不依赖额外的组件。使用 master 的内存存储历史的统计数据，如果主节点发生故障，历史统计数据会丢失。</p><ul><li>cluster</li></ul><p>正式环境的训练，Bran 服务会将作业的历史统计数据持久化到数据库中，进行集群级别的优化。即使主节点发生故障时，DLRover 可以重启主节点继续训练。</p><p>上面这段描述来自 DLRover 的设计文档。在测试时，发现 single-job\cluster 模式在 AllreduceStrategy 下没有明显区别，cluster 模式在 Brain 不能用时也能正常运行。同时，AllreduceStrategy 下的 Job Master 发生故障时，整个作业就失败了。</p><h3 id=64-训练作业测试>6.4 训练作业测试</h3><ul><li>创建 ElasticJob 对象</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: elastic.iml.github.io/v1alpha1
</span></span></span><span class=line><span class=cl><span class=s>kind: ElasticJob
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: torch-mnist-single-job-testing-1
</span></span></span><span class=line><span class=cl><span class=s>  namespace: dlrover
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    some-label: some-value
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  distributionStrategy: AllreduceStrategy
</span></span></span><span class=line><span class=cl><span class=s>  optimizeMode: cluster
</span></span></span><span class=line><span class=cl><span class=s>  replicaSpecs:
</span></span></span><span class=line><span class=cl><span class=s>    worker:
</span></span></span><span class=line><span class=cl><span class=s>      replicas: 5
</span></span></span><span class=line><span class=cl><span class=s>      template:
</span></span></span><span class=line><span class=cl><span class=s>        spec:
</span></span></span><span class=line><span class=cl><span class=s>          restartPolicy: Always
</span></span></span><span class=line><span class=cl><span class=s>          containers:
</span></span></span><span class=line><span class=cl><span class=s>            - name: main
</span></span></span><span class=line><span class=cl><span class=s>              image: registry.cn-beijing.aliyuncs.com/intell-ai/dlrover:pytorch-example
</span></span></span><span class=line><span class=cl><span class=s>              imagePullPolicy: Always
</span></span></span><span class=line><span class=cl><span class=s>              command:
</span></span></span><span class=line><span class=cl><span class=s>                - /bin/bash
</span></span></span><span class=line><span class=cl><span class=s>                - -c
</span></span></span><span class=line><span class=cl><span class=s>                - &#34;dlrover-run --network-check --nnodes=1:10 \
</span></span></span><span class=line><span class=cl><span class=s>                  --nproc_per_node=1 --max_restarts=10  \
</span></span></span><span class=line><span class=cl><span class=s>                  examples/pytorch/mnist/cnn_train.py --num_epochs 500 \
</span></span></span><span class=line><span class=cl><span class=s>                  --training_data /data/mnist_png/training/ \
</span></span></span><span class=line><span class=cl><span class=s>                  --validation_data /data/mnist_png/testing/&#34;
</span></span></span><span class=line><span class=cl><span class=s>              resources:
</span></span></span><span class=line><span class=cl><span class=s>                limits:
</span></span></span><span class=line><span class=cl><span class=s>                  cpu: 2
</span></span></span><span class=line><span class=cl><span class=s>                  memory: 3Gi
</span></span></span><span class=line><span class=cl><span class=s>                  tencent.com/vcuda-core: 100
</span></span></span><span class=line><span class=cl><span class=s>                requests:
</span></span></span><span class=line><span class=cl><span class=s>                  cpu: 2
</span></span></span><span class=line><span class=cl><span class=s>                  memory: 3Gi
</span></span></span><span class=line><span class=cl><span class=s>                  tencent.com/vcuda-core: 100
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p>一旦 ElasticJob 创建完成，DLRover 会马上开始创建 master 和 worker Pod，并不会判断是否有足够的资源，没有 gang-scheduler 的支持。根据社区沟通，DLRover 会结合 Volcano 的 gang-scheduler 支持此特性。</p><ul><li>查看作业状态</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                                         READY   STATUS    RESTARTS      AGE
</span></span><span class=line><span class=cl>elasticjob-torch-mnist-single-job-testing-1-dlrover-master   1/1     Running   <span class=m>0</span>             10s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-0             1/1     Running   <span class=m>0</span>             5s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-1             1/1     Running   <span class=m>0</span>             5s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-2             1/1     Running   <span class=m>0</span>             5s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-3             1/1     Running   <span class=m>0</span>             5s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-4             1/1     Running   <span class=m>0</span>             5s
</span></span></code></pre></td></tr></table></div></div><ul><li>主动删掉一个 worker</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover delete pod torch-mnist-single-job-testing-1-edljob-worker-3
</span></span></code></pre></td></tr></table></div></div><ul><li>查看作业状态</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover get pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                                         READY   STATUS    RESTARTS      AGE
</span></span><span class=line><span class=cl>elasticjob-torch-mnist-single-job-testing-1-dlrover-master   1/1     Running   <span class=m>0</span>             6m18s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-0             1/1     Running   <span class=m>0</span>             6m13s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-1             1/1     Running   <span class=m>0</span>             6m13s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-2             1/1     Running   <span class=m>0</span>             6m13s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-4             1/1     Running   <span class=m>0</span>             6m12s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-5             1/1     Running   <span class=m>0</span>             3m12s
</span></span></code></pre></td></tr></table></div></div><p>DLRover 会自动拉起一个新的 worker 作业，继续训练任务，这就是其故障自动恢复的能力。当然，如果是其他故障，比如掉卡、程序异常退出、IO 异常等故障，DLRover 也可以自动处理，不需要人工干预。</p><ul><li>清理</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover delete elasticjob torch-mnist-single-job-testing-1
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover delete scaleplans.elastic.iml.github.io torch-mnist-single-job-testing-1
</span></span></code></pre></td></tr></table></div></div><h3 id=65-弹性作业原理>6.5 弹性作业原理</h3><p>Allreduce 现在只支持容错，不支持弹性扩容。我们的目标场景是 PyTorch 的分布式预训练大模型，对 Tensorflow 相关的弹性没有强烈需求。这里仅仅只是简单了解下其弹性原理。</p><p>DLRover Brain 会根据当前训练任务的监控，利用算法计算出资源优化需要调整的数据。训练作业的 Job Master 拿到新的资源优化结果后，会生成一个 ScalePlan CRD，通知 ElasticJob Controller 更改训练作业的节点规模。</p><p>我测试过社区提供的 <code>deepctr-auto-scale</code> 示例，chief 占用了大量内存资源，并没有观察到 worker 副本数的增加。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deepctr-auto-scale-edljob-chief-0              1947m        185022Mi
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>deepctr-auto-scale-edljob-chief-0              1/1     Running   <span class=m>0</span>               4h42m
</span></span><span class=line><span class=cl>deepctr-auto-scale-edljob-evaluator-0          1/1     Running   <span class=m>0</span>               4h42m
</span></span><span class=line><span class=cl>deepctr-auto-scale-edljob-ps-0                 1/1     Running   <span class=m>0</span>               4h42m
</span></span><span class=line><span class=cl>dlrover-brain-78b6484859-p67s5                 1/1     Running   <span class=m>0</span>               16h
</span></span><span class=line><span class=cl>dlrover-controller-manager-688c767cb7-8bzgl    2/2     Running   <span class=m>1</span> <span class=o>(</span>7h43m ago<span class=o>)</span>   15h
</span></span><span class=line><span class=cl>dlrover-kube-monitor-88548c89f-kjjjw           1/1     Running   <span class=m>1</span> <span class=o>(</span>16h ago<span class=o>)</span>     16h
</span></span><span class=line><span class=cl>elasticjob-deepctr-auto-scale-dlrover-master   1/1     Running   <span class=m>0</span>               4h42m
</span></span><span class=line><span class=cl>mysql-574fb78ddb-8l79r                         1/1     Running   <span class=m>0</span>               16h
</span></span></code></pre></td></tr></table></div></div><p>同时，这个作业依赖于 <code>/nas</code> 中的数据，文档中也没有给出配置说明，因此没有测试太多。</p><h2 id=7-一些问题>7. 一些问题</h2><ul><li>master 挂了之后，训练会停止</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl -n dlrover delete pod elasticjob-torch-mnist-single-job-testing-1-dlrover-master
</span></span></code></pre></td></tr></table></div></div><p>之后</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>dlrover-controller-manager-6b6f9dcd88-2h2fs     1/2     CrashLoopBackOff   <span class=m>4</span> <span class=o>(</span>35s ago<span class=o>)</span>   58m
</span></span></code></pre></td></tr></table></div></div><p>dlrover-controller-manager CrashLoopBackOff 的概率还挺高。等待一会儿，作业也会全部失败。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-0   0/1     Error     <span class=m>0</span>             112s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-1   0/1     Error     <span class=m>0</span>             112s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-2   0/1     Error     <span class=m>0</span>             112s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-3   0/1     Error     <span class=m>0</span>             112s
</span></span><span class=line><span class=cl>torch-mnist-single-job-testing-1-edljob-worker-4   0/1     Error     <span class=m>0</span>             112s
</span></span></code></pre></td></tr></table></div></div><ul><li>ElasticJob 对象缺失非关键字段时，Worker 无法创建</li></ul><p>不设置 <code>spec.template.spec.restartPolicy</code> 字段时，仅创建了 Job Master，而不会创建 Worker。在 ElasticJob Manager 和 Job Master Pod 的日志中看不到异常报错。</p><p>不设置作业 ElasticJob 的 labels 字段，也是这种情况。</p><ul><li>版本控制做得不好，可能触发很多潜在问题</li></ul><p>在 Release 的版本中，镜像 Tag 还是 test、master，拉取策略是 Always。文档中的一些测试 Case 也没有太多版本控制，很容易触发兼容性问题。</p><p>还有就是 DLRover master 的 Dockerfile 中使用的 0.3.6 ，而 pytorch-example 中使用的是 0.3.4。</p><ul><li>项目完成度可能不是很高</li></ul><p>我看到 <code>EnableElasticScheduling</code> 字段很快就联想到了 <code>autoScale</code> 字段，但是发现只有这个字段的定义，代码仓库中没有相关的实现。</p><p>可能是开源的同学支持内部压力大，没太多时间打磨社区版这些细节，有些包名还没来得从 EasyDL 改为 DLRover。</p><h2 id=8-总结>8. 总结</h2><p>本篇是测试 DLRover 托管训练作用的一些记录，主要内容如下:</p><ul><li>在 Kubernetes 上进行训练，有其特定场景的问题需要解决，分布式训练任务形态类似 StatefulSet，节点（Pod) 之间不是完全对等</li><li>DLRover 能解决分布式训练时的一些问题，包括资源的配置，弹性训练，故障的检测、定位、恢复。</li><li>在主机和 Kubernetes 基础设施上分别对 DLRover 进行了尝试</li><li>目前 DLRover 项目还有些不完善的地方，但也给了我们共同参与的机会，希望项目能够走得远一点</li></ul></article><script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script>"use strict";document.addEventListener("DOMContentLoaded",function(){var e=!1,t=document.querySelectorAll("pre.chroma"),n=document.querySelectorAll(".language-code"),s=document.querySelectorAll("div.language-\\$"),o=document.querySelectorAll("div.language-\\>"),i=function(t){var s,o,i,a,r,c,l,d=t,n=t.textContent;if(n.length>15){e||(a=new ClipboardJS(".copy-to-clipboard",{text:function(e){var t=prev(e).querySelectorAll("code");return t.length>1?n=prev(e).querySelector('code[class^="language-"]').textContent:n=prev(e).querySelector("code").textContent,n.replace(/^\$\s/gm,"")}}),a.on("success",function(e){e.clearSelection(),l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label","Copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),a.on("error",function(e){l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label",e.action.toString()),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),e=!0),r=["language-mermaid","language-viz","language-wave","language-chart","language-msc","language-flowchart"],c=!1,s=d.getAttribute("class");for(o=0;o<r.length;o++)if(s&&s.startsWith(r[o])){c=!0;break}c||s&&(i=document.createElement("span"),i.setAttribute("class","copy-to-clipboard"),i.setAttribute("title","Copy to clipboard"),t.parentNode.parentNode.insertBefore(i,t.parentNode.nextElementSibling))}},a=function(e){var t=document.createElement("span");t.setAttribute("class","copy-to-clipboard"),t.setAttribute("title","Copy to clipboard"),e.parentNode.parentNode.insertBefore(t,e.parentNode.nextElementSibling)};t?t.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,n?n.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,s?s.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null,o?o.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null})</script><script>"use strict";function wrap(e,t){e.parentNode.insertBefore(t,e),t.appendChild(e)}(function(){var e=document.querySelector(".single__contents");e?e.querySelectorAll("pre > code").forEach(function(e){var t=e.getAttribute("data-lang"),n=document.createElement("div"),o=null,s=null;t&&t.includes(":")?(o=t.split(":")[0],s=t.split(":")[1],n.className="language-"+o,n.setAttribute("data-lang",s),e.className="language-"+o,e.setAttribute("data-lang",s),e.setAttribute("id",s)):t||(n.setAttribute("data-lang","Code"),n.className="language-code"),(!t||s)&&wrap(e.parentNode,n)}):null})();var langCodeElem=document.querySelectorAll(".language-code"),dollarCodeElem,gtCodeElem;langCodeElem?langCodeElem.forEach(function(e){var t=document.createElement("span");t.className="copy-to-clipboard",t.setAttribute("title","Copy to clipboard"),e.append(t)}):null,dollarCodeElem=document.querySelectorAll("div.language-\\$"),gtCodeElem=document.querySelectorAll("div.language-\\>"),dollarCodeElem?dollarCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="$<br/>"}):null}):null,gtCodeElem?gtCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="><br/>"}):null}):null</script><div class=whoami__gutter></div><hr class="hr-slash whoami-hr"><section class=whoami><div class=whoami__image-wrapper><img data-src=/static/images/chenshaowen.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=微信公众号 class="lazyload whoami__image"></div><div class=whoami__contents><div class=whoami__written-by>作者</div><div class=whoami__title>微信公众号</div><div class=whoami__desc></div><div class=whoami__social></div></div></section><hr class="hr-slash whoami-hr"><section class=related><h1 class=related__title><hr class=hr-dots><div>相关内容</div><hr class=hr-dots></h1><ul class=related-ul><li><a href=/blog/why-top-node-free-grafana-data-not-match.html class=related__link>为什么 top node、free、Grafana 的数据对不上</a></li><li><a href=/blog/store-elasticsearch-data-in-juicefs.html class=related__link>使用 JuiceFS 存储 Elasticsearch 数据</a></li><li><a href=/blog/model-parallel-training-techniques.html class=related__link>模型并行训练技术</a></li><li><a href=/blog/the-basic-of-volcano.html class=related__link>Volcano 使用基础</a></li><li><a href=/blog/ops-added-server-and-ui-services.html class=related__link>Ops 新增 Server 及 UI 服务</a></li></ul></section><div class=grow></div><nav class=pagination-single><a href=https://www.chenshaowen.com/blog/develop-a-copilot-to-handle-exceptions.html class=pagination-single__left><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg></div><div class=pagination-single__left-title>开发了一个 Copilot 用来处理运维故障</div></a><div class=grow></div><a href=https://www.chenshaowen.com/blog/data-parallel-architecture-in-distributed-train.html class=pagination-single__right><div class=pagination-single__right-title>分布式训练中的数据并行架构</div><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg></div></a></nav><div class="modal micromodal-slide" id=modal aria-hidden=true><div class=modal__overlay tabindex=-1 data-micromodal-close><div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title><div class=modal__content id=modal-content><div id=mySwipe class=swipe><div class=swipe-wrap></div></div></div><span class=modal__items><span class=modal__header><div class=modal__paging title="Page Info" aria-label="Current Page"></div><div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg></div></span><div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg></div><div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg></div><div class=modal__caption><div class=modal__caption--text></div></div></span></div></div></div><script defer src=/js/swipe.min.feb438efb7ca009ecd7fc2ac3ad2fced4840990b2798d81f87137f2dc6281f05.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var e,t,n,o,i,a,r,c,l,d,u,h,f,p,g,v,b,s=document.documentElement;function j(){s.requestFullscreen?s.requestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen():s.msRequestFullscreen&&s.msRequestFullscreen()}function m(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}c=document.getElementById("modal"),i=document.querySelector(".gallery__container"),v=document.querySelector(".swipe-wrap"),b=document.getElementById("mySwipe"),u=document.querySelector(".modal__arrow--left"),f=document.querySelector(".modal__arrow--right"),h=document.querySelector(".modal__toolbar--close"),t=document.querySelector(".modal__toolbar--full"),n=document.querySelector(".modal__toolbar--normal"),r=document.querySelector(".modal__caption"),d=document.querySelector(".modal__paging"),o=document.querySelector(".modal__items"),a=null,l=null,e=null,p=function(t){t.key==="ArrowRight"?c&&c.classList.contains("is-open")&&e.next():t.key==="ArrowLeft"&&c&&c.classList.contains("is-open")&&e.prev()},i?a=i.querySelectorAll("img").length:(i=document.querySelector(".single__contents"),a=i.querySelectorAll("img").length),MicroModal.init({onClose:function(){e&&(e.kill(),e=null,m()),window.removeEventListener("keydown",p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),g=function(e){return new Promise(function(t,n){var s=new Image;s.onload=function(){t(s)},s.onerror=n,s.src=e})},i.querySelectorAll("img").forEach(function(s,i){s.style.cursor="pointer";var c,u=s.cloneNode(!0);u.style.maxHeight="100%",u.style.maxWidth="100%",u.onclick=function(e){e.stopPropagation()},c=document.createElement("div"),c.style.width="100%",c.style.height="100vh",c.setAttribute("data-micromodal-close",""),c.onclick=function(){e&&(e.kill(),e=null)},c.onmouseenter=function(){clearTimeout(l),fadeIn(o,200)},c.onmouseleave=function(){l=setTimeout(function(){fadeOut(o,200)},2500)},c.ontouchstart=function(){fadeIn(o,200)},c.append(u),v.append(c),s.addEventListener("click",async function(s){MicroModal.show("modal"),e&&(e.kill(),e=null);var c,m=s.target.getAttribute("data-src")||s.target.getAttribute("src"),h=await g(m);u.style.width=h.width+"px",u.style.height=h.height+"px",e=new Swipe(b,{startSlide:i,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(e,t){var s,n=t.querySelector("img"),c=n.getAttribute("data-src")||n.getAttribute("src"),i=await g(c);n.style.width=i.width+"px",n.style.height=i.height+"px",r&&n&&(s=null,n.getAttribute("data-caption")?s=n.getAttribute("data-caption"):n.getAttribute("title")?s=n.getAttribute("title"):n.getAttribute("alt")?s=n.getAttribute("alt"):s=n.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=s,d.innerText=e+1+" / "+a,clearTimeout(l),fadeIn(o,200))}}),fadeIn(o),r&&(c=null,s.target.getAttribute("data-caption")?c=s.target.getAttribute("data-caption"):s.target.getAttribute("title")?c=s.target.getAttribute("title"):s.target.getAttribute("alt")?c=s.target.getAttribute("alt"):c=s.target.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=c,d.innerText=i+1+" / "+a),n&&t&&(n.style.zIndex=-1,n.style.opacity=0,t.style.zIndex=25,t.style.opacity=1)}),window.addEventListener("keydown",p)}),u?u.addEventListener("click",function(){e&&e.prev()}):null,f?f.addEventListener("click",function(){e&&e.next()}):null,h?h.addEventListener("click",function(){e&&(e.kill(),e=null),m(),MicroModal.close("modal")}):null,t?t.addEventListener("click",function(){j(),n&&(n.style.zIndex=25,n.style.opacity=1,t.style.zIndex=-1,t.style.opacity=0)}):null,n?n.addEventListener("click",function(){m(),t&&(t.style.zIndex=25,t.style.opacity=1,n.style.zIndex=-1,n.style.opacity=0)}):null})</script><div class=hide><div class=search><span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><input id=search aria-label="Site Search" class=input type=text placeholder=搜索 autocomplete=off><div id=search-results class=dropdown><div id=search-menu class=dropdown-menu role=menu></div></div></div></div></div></main><aside class="single__side main-side"><section class="sidebar hide"><script>document.querySelector(".sidebar").classList.remove("hide")</script><div class=toc__flexbox data-position=fixed><h6 class=toc__title data-ani=true>目录</h6><label class=switch data-ani=true><input id=toggle-toc aria-label="Toggle TOC" type=checkbox checked>
<span class="slider round"></span></label></div><div class=toc data-dir=ltr data-folding=true data-ani=true><nav id=TableOfContents><ul><li><a href=#1-分布式训练面临的问题>1. 分布式训练面临的问题</a></li><li><a href=#2-什么是-dlrover>2. 什么是 DLRover</a></li><li><a href=#3-dlrover-run-命令及参数>3. dlrover-run 命令及参数</a></li><li><a href=#4-使用-dlrover-快速托管训练>4. 使用 DLRover 快速托管训练</a></li><li><a href=#5-集群安装-dlrover-相关组件>5. 集群安装 DLRover 相关组件</a></li><li><a href=#6-elasticjob-创建训练作业>6. ElasticJob 创建训练作业</a><ul><li><a href=#61-elasticjob-对象定义>6.1 ElasticJob 对象定义</a></li><li><a href=#62-distributionstrategy-策略>6.2 DistributionStrategy 策略</a></li><li><a href=#63-optimizemode-模式>6.3 optimizeMode 模式</a></li><li><a href=#64-训练作业测试>6.4 训练作业测试</a></li><li><a href=#65-弹性作业原理>6.5 弹性作业原理</a></li></ul></li><li><a href=#7-一些问题>7. 一些问题</a></li><li><a href=#8-总结>8. 总结</a></li></ul></nav></div></section></aside><script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"inner"'),singleMainElem=document.querySelector(".single__main"),singleSideElem=document.querySelector(".single__side");enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main"),singleSideElem.classList.remove("main-side"),singleSideElem.classList.add("hide")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"))},unmatch:function(){(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove("main"),singleMainElem.classList.add("main-main"),singleSideElem.classList.remove("hide"),singleSideElem.classList.add("main-side")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"));var t=document.querySelector(".navbar__burger"),e=document.getElementsByClassName("navbarm__collapse")[0];e&&(e.setAttribute("data-open",!1),e.style.maxHeight=0,t.classList.remove("is-active")),document.getElementsByClassName("navbar__menu")[0].classList.remove("is-active"),document.getElementsByClassName("mobile-search")[0].classList.add("hide")},setup:function(){},deferSetup:!0,destroy:function(){}})</script><script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script defer src=/js/helper/throttle.min.js></script>
<script>"use strict";window.onload=function(){var e,t,n,s,o,i,r,c,l,d,u,h,m,f,p,g,v,b,j,y,_,w,O,x,C,E,k,A,S,M,F,T,z,D,N,H,a=document.querySelector(".navbar"),P=document.querySelector(".single__contents"),R=JSON.parse("false"),L=JSON.parse("true");R&&L&&(y=document.querySelector("#busuanzi_value_page_pv"),y.textContent=y.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),S=JSON.parse("true"),z=JSON.parse("null"),D=JSON.parse("false"),d=document.querySelector(".toc__flexbox"),u=document.querySelector(".toc__flexbox--outer"),x=JSON.parse("true"),(S||z)&&document.querySelector(".toc")&&(i=document.querySelector(".toc").querySelector("#TableOfContents"),i.onmouseenter=function(){a.classList.contains("scrolling")&&a.classList.remove("scrolling")},i.onmouseleave=function(){a.classList.contains("scrolling")||a.classList.add("scrolling")},!1===x||(i.querySelectorAll("ul")?i.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),i&&(i.querySelectorAll("a").length>0?i.querySelectorAll("a").forEach(function(e){e.addEventListener("click",function(){var t,n=e.getAttribute("id");a.classList.contains("scrolling")||(a.classList.remove("navbar--show"),a.classList.remove("navbar--hide"),a.classList.add("navbar--hide")),document.querySelector(".toc").querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),e.classList.add("active"),t=i.querySelector('[href="#'+n+'"]'),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),t&&(getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null)})}):(d&&(d.setAttribute("data-position",""),d.classList.contains("hide")||d.classList.add("hide")),u&&(u.setAttribute("data-position",""),u.classList.contains("hide")||u.classList.add("hide")))),b=document.getElementById("toggle-toc"),v=document.getElementById("visible-toc"),s=document.querySelector(".toc"),o=document.querySelector("main"),l=document.querySelector("side"),c=document.querySelector(".toc__flexbox"),b?b.addEventListener("change",function(e){e.target.checked?(s&&fadeIn(s,200),c&&c.setAttribute("data-position","fixed"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main-main")),l&&l.classList.remove("main-side")):(s&&fadeOut(s,200),c&&c.setAttribute("data-position","absolute"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main")),l&&l.classList.remove("main-side"))}):null,v?v.addEventListener("change",function(e){e.target.checked?s&&fadeIn(s,200):s&&fadeOut(s,200)}):null),C=120,M=70,A=function(){s&&(s.style.maxHeight=window.innerHeight-C-M+"px")},w=throttle(A,300),w(),window.addEventListener("resize",w),E=new ClipboardJS(".anchor"),j=P.querySelectorAll("h1, h2, h3, h4"),F=JSON.parse('"ltr"'),j?j.forEach(function(e){var t,s=parseInt(e.tagName.substr(1),10)*2,o=encodeURI(document.location.origin+document.location.pathname),i=o+"#"+e.getAttribute("id"),n=document.createElement("span");n.classList.add("anchor"),n.classList.add("hide"),n.setAttribute("data-clipboard-text",decodeURI(i)),n.style.position="relative",t=document.createElement("span"),t.style.position="absolute",t.style.top="50%",t.style.left="0.75rem",t.style.transform="translateY(-50%)",t.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-s}px" height="${32-s}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,F==="rtl"?t.style.left="-2rem":t.style.right="-2rem",n.append(t),e.append(n),e.addEventListener("mouseenter",function(){this.querySelector(".anchor").classList.remove("hide")}),e.addEventListener("mouseleave",function(){this.querySelector(".anchor").classList.add("hide")})}):null,document.querySelectorAll(".anchor").forEach(function(e){e.addEventListener("mouseleave",function(){e.setAttribute("aria-label",null),e.classList.remove("tooltipped"),e.classList.remove("tooltipped-s"),e.classList.remove("tooltipped-w")})}),E.on("success",function(e){e.clearSelection(),e.trigger.setAttribute("aria-label","Link copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-s")}),t=JSON.parse("null"),t&&t.includes("mermaid")&&(O=localStorage.getItem("theme")||JSON.parse('"light"'),O==="dark"||O==="hacker"?mermaid.initialize({theme:"dark"}):mermaid.initialize({theme:"default"}),_=[],[].push.apply(_,document.getElementsByClassName("language-mermaid")),_.forEach(function(e){var n,t=e.parentNode;t!==document.body&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t)),n=document.createElement("div"),n.classList.add("mermaid"),n.style.padding="34px 4px 6px",n.innerHTML=e.innerHTML,e.replaceWith(n)})),t&&t.includes("katex")&&(N=document.getElementsByClassName("math"),r={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector(".single__contents"),r)),t&&t.includes("flowchartjs")&&(r=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),n=null,T="language-flowchart",e=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+T+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="flowchart"+e,t.parentNode.insertBefore(s,t),o=flowchart.parse(n),o.drawSVG("flowchart"+e,r),e+=1})),document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"}),t&&t.includes("msc")&&(r=JSON.parse('{"theme":"hand"}'),n=null,e=0,h="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="msc"+e,t.parentNode.insertBefore(s,t),o=Diagram.parse(n),o.drawSVG("msc"+e,r),e+=1})),t&&t.includes("chart")&&(m="#666",f="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=m,Chart.defaults.global.elements.rectangle.backgroundColor=f,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=m,Chart.defaults.global.elements.line.backgroundColor=f,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=m,Chart.defaults.global.elements.point.backgroundColor=f,h="language-chart",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var i,a,s=document.createElement("canvas"),o=null;s.height=200,s.style.height=200,s.id="myChart"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),i=document.getElementById("myChart"+e).getContext("2d"),a=new Chart(i,o),e+=1})),t&&t.includes("wavedrom")&&(k="language-wave",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+k+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var s=document.createElement("div"),o=null;s.id="WaveDrom_Display_"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),WaveDrom.RenderWaveForm(e,o,"WaveDrom_Display_"),e+=1})),t&&t.includes("viz")&&(g="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+g+"]"),function(e){e.style.display="none",e.parentNode.style.backgroundColor="transparent",e.getAttribute("class").split(" ").forEach(function(e){e.startsWith(g)&&(t=e.substr(g.length))});var t,n=new Viz;n.renderSVGElement(e.innerText,{engine:t}).then(function(t){t.style.width="100%",e.parentNode.insertBefore(t,e)})}))}</script><footer class=footer><div id=gtt><div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg></div></div><hr><div class="basicflex flexwrap"><a href=https://beian.miit.gov.cn/ class=footer__link target=_blank rel=noreferrer>鄂ICP备15009848号-4</a></div><div class=footer__poweredby><p class=caption>©2016 - 2025, All Rights Reserved.</p></div></footer></div><div class="wrapper__right hide" data-pad=true dir=ltr><script>document.querySelector(".wrapper__right").classList.remove("hide")</script></div></div></body></html>