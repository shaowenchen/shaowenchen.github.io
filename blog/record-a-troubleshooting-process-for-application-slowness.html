<!doctype html><html lang=zh dir=ltr><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>从 CPU 到网络记录一次排查应用慢的过程 – 陈少文的网站</title><script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script>
<script defer src=/js/helper/getParents.min.086022fb02d7a1517e33c2670bffb976b3e80bcacd9caeee0c6a586064f20e42.js></script>
<script defer src=/js/helper/fadeinout.min.3ce954c8aea3b69cc5e6f734d8273ba4cd48d3a7987dbdca145849bc4b8fc296.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(e,t){"use strict";if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return t===void 0&&(t=0),this.indexOf(e,t)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(e){if(!e.length)throw new Error("DOM Exception 8");if(e.length===1)return typeof e[0]=="string"?document.createTextNode(e[0]):e[0];for(var t,n=document.createDocumentFragment(),o=e.length,s=-1;++s<o;)t=e[s],n.appendChild(typeof t=="string"?document.createTextNode(t):t);return n}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),document.addEventListener("DOMContentLoaded",function(){var e,t,n,s,o,i,a,r,c,l,d,u,h,m,f,p,v,b,j,y,_,w,O,x,C,k,A,S,M,F,T,z,D,N,L,R,P,H,I,B,V,$,W,U,K,q,Y,G,E=document.querySelector(".navbar__burger"),ie,ae,re,ce,ue,de,le,oe,se,ne,te,pe,fe,he;E?E.addEventListener("click",function(){var n,t=document.querySelector(".navbarm__collapse");t&&(n=t.getAttribute("data-open"),n==="true"?(t.setAttribute("data-open","false"),t.style.maxHeight=0,E.classList.remove("is-active")):(t.setAttribute("data-open","true"),t.style.maxHeight=t.scrollHeight+"px",E.classList.add("is-active")))}):null,q=document.querySelectorAll(".single__contents > table");for(let e=0;e<q.length;e++)M=q[e],F=document.createElement("div"),F.className="table-wrapper",M.parentElement.replaceChild(F,M),F.appendChild(M);V=document.querySelectorAll(".footnote-ref"),B=document.querySelectorAll(".footnote-backref"),V?V.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,B?B.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,s=document.querySelector(".summary__container"),i=document.querySelector(".search-result"),D=document.querySelector(".search-result__close"),D?D.addEventListener("click",function(){i.setAttribute("data-display","none"),s.setAttribute("data-display","block")}):null,document.querySelectorAll(".tab")?document.querySelectorAll(".tab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".tab__link"),s=e.querySelectorAll(".tab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,document.querySelectorAll(".codetab")?document.querySelectorAll(".codetab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".codetab__link"),s=e.querySelectorAll(".codetab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,v=document.getElementById("gtt"),v.style.display="none",v.addEventListener("click",function(){window.document.documentMode?document.documentElement.scrollTop=0:ge(250)});function ge(e){var t=-window.scrollY/(e/15),n=setInterval(function(){window.scrollY!=0?window.scrollBy(0,t):clearInterval(n)},15)}ie=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?v.style.display="block":v.style.display="none"},P=document.querySelectorAll(".expand__button");for(let e=0;e<P.length;e++)P[e].addEventListener("click",function(){var e=this.nextElementSibling;e.style.maxHeight?(e.style.maxHeight=null,this.querySelector("svg").classList.add("expand-icon__right"),this.querySelector("svg").classList.remove("expand-icon__down")):(e.style.maxHeight=e.scrollHeight+"px",this.querySelector("svg").classList.remove("expand-icon__right"),this.querySelector("svg").classList.add("expand-icon__down"))});z=window.pageYOffset||document.documentElement.scrollTop,p=document.querySelector(".toc"),r=p?p.querySelector("#TableOfContents"):null,x=document.getElementById("toggle-toc"),d=document.querySelector(".single__contents"),t=document.querySelector(".navbar"),b=document.querySelector(".toc__flexbox"),j=document.querySelector(".toc__flexbox--outer"),L=document.querySelectorAll(".expand__content"),N=document.querySelectorAll(".box"),o=null,S=JSON.parse("true"),a=JSON.parse('["h2","h3","h4"]'),a?a=a.toString():a="h1, h2, h3, h4, h5, h6",d&&d.querySelectorAll(".tab")?d.querySelectorAll(".tab").forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,L?L.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,N?N.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,window.onscroll=function(){ie();var e=window.pageYOffset||document.documentElement.scrollTop;if(e>z){if(e<250?v.style.display="none":v.style.display="block",e<45)return null;t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.contains("navbar--show")&&t.classList.remove("navbar--show"):t.classList.add("navbar--hide")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&(b.setAttribute("data-position",""),b.classList.contains("hide")||b.classList.add("hide")),j&&(j.setAttribute("data-position",""),j.classList.contains("hide")||j.classList.add("hide"))))}else e<250&&(v.style.display="none"),t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.remove("navbar--hide"):t.classList.contains("navbar--show")||t.classList.add("navbar--show")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&!b.classList.contains("hide")&&b.classList.add("hide"),j&&!j.classList.contains("hide")&&j.classList.add("hide"))),r&&document.documentElement.scrollTop<250&&(!1===S||(r.querySelector("ul")?r.querySelector("ul").querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})}):null));z=e<=0?0:e},A=localStorage.getItem("theme"),T=document.getElementById("root"),ae=document.querySelectorAll(".select-theme"),C=document.querySelectorAll(".select-theme__item"),re=JSON.parse('"dark"'),ce=JSON.parse('"light"'),ue=JSON.parse('"hacker"'),de=JSON.parse('"solarized"'),le=JSON.parse('"kimbie"'),k=function(e){var t=document.getElementsByName("msapplication-TileColor")[0],n=document.getElementsByName("theme-color")[0],s=document.getElementsByName("msapplication-navbutton-color")[0],o=document.getElementsByName("apple-mobile-web-app-status-bar-style")[0];e.includes("dark")?(t.setAttribute("content","#fcfcfa"),n.setAttribute("content","#403E41"),s.setAttribute("content","#403E41"),o.setAttribute("content","#403E41")):e.includes("light")?(t.setAttribute("content","#555"),n.setAttribute("content","#eee"),s.setAttribute("content","#eee"),o.setAttribute("content","#eee")):e.includes("hacker")?(t.setAttribute("content","#e3cd26"),n.setAttribute("content","#252526"),s.setAttribute("content","#252526"),o.setAttribute("content","#252526")):e.includes("solarized")?(t.setAttribute("content","#d3af86"),n.setAttribute("content","#51412c"),s.setAttribute("content","#51412c"),o.setAttribute("content","#51412c")):e.includes("kimbie")&&(t.setAttribute("content","#586e75"),n.setAttribute("content","#eee8d5"),s.setAttribute("content","#eee8d5"),o.setAttribute("content","#eee8d5"))},Y=function(e){if(e===re)return"dark";if(e===ce)return"light";if(e===ue)return"hacker";if(e===de)return"solarized";if(e===le)return"kimbie"},A?(C?C.forEach(function(e){e.text.trim()===A?e.classList.add("is-active"):e.classList.remove("is-active")}):null,k(A)):k(T.className),C?C.forEach(function(e){e.addEventListener("click",function(e){var n,s,t=Y(e.target.text.trim());localStorage.setItem("theme",t),k(t),T.removeAttribute("class"),T.classList.add("theme__"+t),ae.forEach(function(e){e.querySelectorAll("a").forEach(function(e){e.classList&&(e.text.trim()===t?e.classList.contains("is-active")||e.classList.add("is-active"):e.classList.contains("is-active")&&e.classList.remove("is-active"))})}),window.mermaid&&(t==="dark"||t==="hacker"?(mermaid.initialize({theme:"dark"}),location.reload()):(mermaid.initialize({theme:"default"}),location.reload())),n=document.getElementById("utterances"),n&&n.querySelector("iframe").contentWindow.postMessage({type:"set-theme",theme:t==="dark"||t==="hacker"?"photon-dark":t==="kimbie"?"github-dark-orange":"github-light"},"https://utteranc.es"),s=document.querySelectorAll(".twitter-timeline"),s&&window.postMessage({type:"set-twitter-theme",theme:t==="light"||t==="solarized"?"light":"dark"})})}):null,G=JSON.parse('"https://www.chenshaowen.com"'),oe=JSON.parse('"https://www.chenshaowen.com/blog/record-a-troubleshooting-process-for-application-slowness.html"'),se=JSON.parse('""'),l=null,c=null,n=null,ne=JSON.parse("true"),y=JSON.parse("true"),U=JSON.parse('"main"'),K=JSON.parse('"post"'),te=JSON.parse('"page"'),O=null,ne&&function(){var t=new XMLHttpRequest;K==="publication"&&te!=="page"?t.open("GET",oe+"index.json"):t.open("GET",G+se+"/index.json"),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.onload=function(){t.status===200?(O=new Fuse(JSON.parse(t.response.toString("utf-8")),{keys:K.includes("publication")?["title","abstract"]:["title","description","content"],includeMatches:y,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=O):console.error("["+t.status+"]Error:",t.statusText)},t.send()}();function me(e,t){var n,s,o=document.createElement("li");o.className="search-result__item",n=document.createElement("a"),n.innerHTML=t.item.title,n.setAttribute("class","search-result__item--title"),n.setAttribute("href",t.item.permalink),s=document.createElement("div"),s.setAttribute("class","search-result__item--desc"),t.item.description?s.innerHTML=t.item.description:t.item.content&&(s.innerHTML=t.item.content.substring(0,225)),o.appendChild(n),o.appendChild(s),e.appendChild(o)}function be(e,t){var n,s,o,i=document.createElement("li");if(i.className="search-result__item",n=null,o=document.createElement("a"),o.innerHTML=t.item.title,o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri),t.matches&&t.matches.length){for(s=0;s<t.matches.length;s++)"title"===t.matches[s].key&&(o=document.createElement("a"),o.innerHTML=g(t.matches[s].value,t.matches[s].indices),o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri)),"description"===t.matches[s].key?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.description,t.matches[s].indices)):"content"===t.matches[s].key?n||(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.content.substring(0,150),t.matches[s].indices)):t.item.description?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.description):(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.content.substring(0,150));i.appendChild(o),n&&i.appendChild(n),i&&e.appendChild(i)}}function Q(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var t,o,i=document.createElement("li"),s=document.createElement("a");s.setAttribute("href",e.uri),s.setAttribute("class","dropdown-item"),s.appendChild(i),o=document.createElement("div"),o.innerHTML=e.title,o.setAttribute("class","menu-item__title"),t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),e.description?t.innerHTML=e.description:e.content&&(t.innerHTML=e.content.substring(0,150)),i.appendChild(o),i.appendChild(t),n.appendChild(s)}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function Z(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var s,o,a=document.createElement("li"),i=document.createElement("a"),t=null;if(i.setAttribute("href",e.item.uri),i.setAttribute("class","dropdown-item"),i.appendChild(a),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","menu-item__title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.content.substring(0,150));a.appendChild(o),t&&a.appendChild(t),n.appendChild(i)}}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function J(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length>0?t.forEach(function(e){var t=document.createElement("a");t.setAttribute("href",e.uri),t.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+e.title+'</div><div class="mobile-search__item--desc">'+(e.description?e.description:e.content)+"</div></div>",n.appendChild(t)}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function ve(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length?t.forEach(function(e){var s,o,i=document.createElement("li"),a=document.createElement("a"),t=null;if(a.setAttribute("href",e.item.uri),a.appendChild(i),i.setAttribute("class","mobile-search__item"),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","mobile-search__item--title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.content.substring(0,150));i.appendChild(o),t&&i.appendChild(t),n.appendChild(a)}}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function g(e,t){if(!t)return e;var n="",s=0;return t.forEach(function(t){if(t[0]===t[1])return null;n+=""+e.substring(s,t[0])+'<span class="search__highlight">'+e.substring(t[0],t[1]+1)+"</span>",s=t[1]+1}),n+=e.substring(s),n}u=document.getElementById("search"),H=document.getElementById("search-mobile"),m=document.getElementById("search-results"),u?u.addEventListener("input",function(e){if(!e.target.value|window.innerWidth<770)return m?m.setAttribute("class","dropdown"):null,i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null,null;n=e.target.value;var o,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),o=m.querySelectorAll(".dropdown-item"),o?o.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,u?u.addEventListener("blur",function(){if(window.innerWidth<770)return null;m?m.setAttribute("class","dropdown"):null}):null,u?u.addEventListener("click",function(e){if(window.innerWidth<770)return null;if(!e.target.value)return m?m.setAttribute("class","dropdown"):null,null;n=e.target.value;var s,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),s=m.querySelectorAll(".dropdown-item"),s?s.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,pe=document.getElementById("search-menu"),fe=document.querySelector("#search-menu .dropdown-item.is-active"),e=null,he=null,I=350,u?u.addEventListener("keydown",function(t){if(window.innerWidth<770)return null;t.key==="Escape"&&(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null);var n=document.querySelectorAll("#search-menu .dropdown-item"),o=t.which||t.keyCode;if(!n||!n.length)return null;if(t.key==="ArrowDown"||o===40){e===null?(e=0,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===n.length-1?0:e+1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t>0?document.querySelector(".search-content").scrollTop+=n[e].getBoundingClientRect().height:e===0&&(document.querySelector(".search-content").scrollTop=0)}else if(t.key==="ArrowUp"||o===38){e===null?(e=n.length-1,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===0?n.length-1:e-1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t<0?document.querySelector(".search-content").scrollTop-=n[e].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=t+n[e].getBoundingClientRect().height}else t.key==="Enter"||o===13?n[e]&&n[e].getAttribute("href")&&(location.href=n[e].getAttribute("href")):(t.key==="Escape"||o===27)&&(t.target.value=null,l&&l.classList.remove("is-active"))}):null,H?H.addEventListener("input",function(e){if(!e.target.value){let e=document.getElementById("search-mobile-results");for(;e.firstChild;)e.removeChild(e.firstChild);return null}n=e.target.value;var t=O.search(e.target.value);J(n,t),y?ve(n,t):J(n,t)}):null,f=document.querySelector("#search-mobile"),R=document.querySelector(".mobile-search"),$=document.querySelectorAll(".navbar-search"),W=document.querySelector("#search-mobile-close"),w=document.querySelector("#search-mobile-container"),h=document.querySelector("#search-mobile-results"),_=document.querySelector("html"),R&&(R.style.display="none"),$?$.forEach(function(e){e.addEventListener("click",function(){w&&(w.style.display="block"),f&&f.focus(),_&&(_.style.overflowY="hidden")})}):null,W?W.addEventListener("click",function(){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}):null,f?f.addEventListener("keydown",function(e){var t=e.which||e.keyCode;if(e.key==="Escape"||t===27){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}}):null;function ee(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){me(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}function X(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){be(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}})</script><link rel=stylesheet href=/css/main.min.css><meta name=description content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=keywords content="博文,CPU,网络,应用,排查,故障"><meta name=created content="2023-11-08T00:00:00+0000"><meta name=modified content="2023-11-08T00:00:00+0000"><meta property="article:published_time" content="2023-11-08T00:00:00+0000"><meta name=author content="微信公众号"><meta property="og:site_name" content="陈少文的网站"><meta property="og:title" content="从 CPU 到网络记录一次排查应用慢的过程"><meta property="og:url" content="https://www.chenshaowen.com/blog/record-a-troubleshooting-process-for-application-slowness.html"><meta property="og:type" content="article"><meta property="og:description" content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=generator content="Hugo 0.110.0"><meta name=msapplication-TileColor content="#fff"><meta name=theme-color content="#fff"><meta name=msapplication-navbutton-color content="#fff"><meta name=apple-mobile-web-app-status-bar-style content="#fff"><link rel=canonical href=https://www.chenshaowen.com/blog/record-a-troubleshooting-process-for-application-slowness.html><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"从 CPU 到网络记录一次排查应用慢的过程","datePublished":"2023-11-08T00:00:00Z","dateModified":"2023-11-08T00:00:00Z","url":"https://www.chenshaowen.com/blog/record-a-troubleshooting-process-for-application-slowness.html","description":"1. 现象 业务反馈应用 app-a 的接口慢，查看日志发现是某一个 Pod 慢，删除该 Pod 让其更换节点就好。 从监控指标可以看到，Pod 的 CPU 使用率确实有剧增。 但该 Pod 没有达到 Limit 的限制，没有被限流 CPU。 接着看节点的 CPU 监控，发现节点的 CPU 使用率也有剧增。 并且增加的部分是 System …","keywords":["博文","CPU","网络","应用","排查","故障"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.chenshaowen.com"},"publisher":{"@type":"Organization","name":"陈少文的网站","url":"https://www.chenshaowen.com"}}</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MTW4XNQ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>var dataLayer=window.dataLayer=window.dataLayer||[];dataLayer.push({page:"从 CPU 到网络记录一次排查应用慢的过程",categories:"only examples about your dataLayer"})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-MTW4XNQ")</script></head><body id=root class=theme__light><script>var localTheme=localStorage.getItem("theme");localTheme&&(document.getElementById("root").className="theme__"+localTheme)</script><div id=container><div class=wrapper data-type=post data-kind=page><nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr><div class=navbar__brand><a href=/ title=主页 rel=home class=navbar__logo-link><img src=/logo.png alt=Home class=navbar__logo></a>
<a href=/ title=主页 rel=home class=navbar__title-link><h6 class=navbar__title>陈少文的网站</h6></a></div><div class="theme theme-mobile" data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div><div id=search-mobile-container class="mobile-search hide" data-dir=ltr><div class=mobile-search__top><input id=search-mobile type=text aria-label="Mobile Search" placeholder=搜索 class=mobile-search__top--input><div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg></div></div><div id=search-mobile-results class=mobile-search__body></div></div><a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><div class=navbarm__collapse data-open=false><ul dir=ltr><li class=navbarm__menu--item><a href=https://github.com/shaowenchen/ops/>Ops 项目</a></li><li class=navbarm__menu--item><a href=/tags>标签</a></li><li class=navbarm__menu--item><a href=/presentation>演示文档</a></li><li class=navbarm__menu--item><a href=/>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/kubernetes-101/>Kubernetes 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/devops-101/>DevOps 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/microservices-101/>MicroServices 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/aigc/>AIGC</a></li><li class=navbarm__menu--item><a href=/about.html>关于</a></li><li class=navbarm__menu--item><a href=/atom.xml>订阅</a></li></ul></div><div class=navbar__menu><div class=theme data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><a href=https://github.com/shaowenchen/ops/ class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>Ops 项目</a>
<a href=/tags class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>标签</a>
<a href=/presentation class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>演示文档</a><div class="navbar__dropdown navbar__slide-down" data-ani=true><a href=/ class=navbar__menu-item dir=ltr>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a><div class=navbar__dropdown--content><a href=/kubernetes-101/ class=navbar__dropdown--item dir=ltr>Kubernetes 101</a>
<a href=/devops-101/ class=navbar__dropdown--item dir=ltr>DevOps 101</a>
<a href=/microservices-101/ class=navbar__dropdown--item dir=ltr>MicroServices 101</a>
<a href=/aigc/ class=navbar__dropdown--item dir=ltr>AIGC</a></div></div><a href=/about.html class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>关于</a>
<a href=/atom.xml class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>订阅</a></div></nav><main class="single__main main-main"><nav class="breadcrumb hide" aria-label=breadcrumbs><script>document.querySelector(".breadcrumb").classList.remove("hide")</script><ol><li><a href=https://www.chenshaowen.com/ class=capitalize>陈少文的网站</a></li><li><a href=https://www.chenshaowen.com/post/ class=capitalize>Posts</a></li><li class=is-active><span>从 CPU 到网络记录一次排查应用慢的过程</span></li></ol></nav><div class=single><div class=single__nojs>Please enable Javascript to view the contents</div><script>document.querySelector(".single").classList.remove("hide"),document.querySelector(".single__nojs").classList.add("hide")</script><h2 class=single__title data-ani=true>从 CPU 到网络记录一次排查应用慢的过程</h2><h3 class=single__subtitle></h3><div class=single__meta><div class=single__infos><time class=single__info title=创建日期>📅&nbsp;2023年11月08日</time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长>☕&nbsp;7&nbsp;分钟</span>
<span class=single__info></span></div><ul class="single__tags caption">🏷️<li><a href=https://www.chenshaowen.com/tags/%E5%8D%9A%E6%96%87/ class=single__tag title=博文>#博文</a></li><li><a href=https://www.chenshaowen.com/tags/cpu/ class=single__tag title=CPU>#CPU</a></li><li><a href=https://www.chenshaowen.com/tags/%E7%BD%91%E7%BB%9C/ class=single__tag title=网络>#网络</a></li><li><a href=https://www.chenshaowen.com/tags/%E5%BA%94%E7%94%A8/ class=single__tag title=应用>#应用</a></li><li><a href=https://www.chenshaowen.com/tags/%E6%8E%92%E6%9F%A5/ class=single__tag title=排查>#排查</a></li><li><a href=https://www.chenshaowen.com/tags/%E6%95%85%E9%9A%9C/ class=single__tag title=故障>#故障</a></li></ul></div><article class=single__contents data-dir=ltr data-ani=true><h2 id=1-现象>1. 现象</h2><p><img src=/blog/images/2023/11/pod-conn-errorlog.png alt></p><p>业务反馈应用 app-a 的接口慢，查看日志发现是某一个 Pod 慢，删除该 Pod 让其更换节点就好。</p><p>从监控指标可以看到，Pod 的 CPU 使用率确实有剧增。</p><p><img src=/blog/images/2023/11/pod-cpu-usage.png alt></p><p>但该 Pod 没有达到 Limit 的限制，没有被限流 CPU。</p><p><img src=/blog/images/2023/11/pod-cpu-limit.png alt></p><p>接着看节点的 CPU 监控，发现节点的 CPU 使用率也有剧增。</p><p><img src=/blog/images/2023/11/node-cpu-busy.png alt></p><p>并且增加的部分是 System CPU，也就是内核态的 CPU。</p><p><img src=/blog/images/2023/11/node-cpu-usage.png alt></p><p><img src=/blog/images/2023/11/node-cpu-load.png alt></p><p>进一步，确定增加的部分是 System CPU，也就是内核态的 CPU。</p><p>使用内核态 CPU 的主要场景有网络、磁盘 IO 等。</p><h2 id=2-排查问题>2. 排查问题</h2><h3 id=21-排查磁盘-io>2.1 排查磁盘 IO</h3><p>iowait 高并不意味着磁盘 IO 高，iowait 高只是说明 CPU 等待 IO 的时间长，但是并不一定是因为磁盘 IO 高导致的，也可能是网络 IO 高所致。但 iowait 低则能判断出磁盘 IO 压力小。</p><p>从上面的监控可以看到 CPU 的 iowait 低，说明磁盘没有瓶颈。</p><p>另外，从监控指标可以看到，磁盘 IO 速度、IOPS 也都没有异常波动。</p><p><img src=/blog/images/2023/11/node-disk-io.png alt></p><p><img src=/blog/images/2023/11/node-disk-iops.png alt></p><p>也可以结合磁盘设备平均 IO 队列数、读延迟、写延迟等指标继续确认磁盘 IO 是否有异常。</p><p>至此，基本排除了磁盘 IO 的瓶颈。</p><h3 id=22-排查网络-io>2.2 排查网络 IO</h3><p>网络 IO 先看节点 Node 的进出流量，再找异常流量的 Pod。</p><p>从监控可以看到，节点的网络 IO 有异常波动，从 500 Mbps 到 800 Mbps 。</p><p><img src=/blog/images/2023/11/node-traffic.png alt></p><p>接着找到这个节点上流量异常的 Pod。</p><h3 id=23-找到问题>2.3 找到问题</h3><p>很快，我就从监控系统中找出了这个 Pod。</p><p><img src=/blog/images/2023/11/pod2-traffic-usage.png alt></p><p>时间点上很符合，大量的网络 IO、CPU 使用剧增。</p><p><img src=/blog/images/2023/11/pod2-cpu-usage.png alt></p><p>原来是应用 app-b，在 HPA 扩容调度时，恰好调度到了这个节点上，导致这个节点的网络 IO、CPU 使用剧增，影响到了延时敏感的应用 app-a，导致应用 app-a 的接口慢。</p><h3 id=24-解决问题>2.4 解决问题</h3><p>解决办法就是利用 Pod 的反亲和性，将应用 app-a 和应用 app-b 从调度层隔离开来，不让其同时存在于一个节点。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span>- <span class=l>app-b</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>至此，应用 app-a 慢的情况比之前改善了很多，但还是会偶尔出现慢的情况。于是，我继续花了点时间排查。</p><h2 id=3-为什么-pod-cpu-没有被限流>3. 为什么 Pod CPU 没有被限流</h2><p>我一度怀疑应用 app-a 的 Pod CPU 有被限流，监控指标没有反应出来而已。但排查了一段时间后，我并没有发现相关的证据。这个猜测可能是错误的。</p><h3 id=31-k8s-中的-cfs-限流机制>3.1 K8s 中的 CFS 限流机制</h3><p>CFS 是 Linux 内核中用来实现 CPU 带宽控制的一种机制，它可以设定一个进程组可使用的 CPU 时间的上限。</p><p>通常，CPU 使用的的计量周期为 100ms。CPU Limit 决定了每个计量周期，也就是 100ms 时间内，可以使用的 CPU 时间上限。</p><p>1 CPU 代表着 100ms 内，可以使用 1 个核心的 CPU 时间；2 CPU 代表着 100ms 内，可以使用 2 个核心的 CPU 时间。但如果是 0.5 CPU，代表着 100ms 内，就不是 0.5 个核心的 CPU 时间，而是 50ms 的 CPU 时间，因为 CPU 的核心是整数，不能分割，能分割的是占用时间。</p><p>这里其实并不会涉及使用率的问题，无论应用将 CPU 用来计算、还是闲置，都会被计算在内。</p><p>如果 CPU 使用超过了 CPU Limit 规定的时间，就会被限制使用。这里其实还有一个细节就是，多久调度一次 CPU 的使用。这也是我非常感兴趣的一个问题，在后面的文章中，我会继续分析。</p><h3 id=32-kubelet-对-pod-cpu-指标的采集>3.2 kubelet 对 Pod CPU 指标的采集</h3><ol><li>Prometheus 中的服务发现配置</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>job_name</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes-nodes-cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kubernetes_sd_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>role</span><span class=p>:</span><span class=w> </span><span class=l>node</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>relabel_configs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>action</span><span class=p>:</span><span class=w> </span><span class=l>labelmap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>__meta_kubernetes_node_label_(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.default.svc:443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__address__</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>regex</span><span class=p>:</span><span class=w> </span><span class=l>(.+)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replacement</span><span class=p>:</span><span class=w> </span><span class=l>/api/v1/nodes/$1/proxy/metrics/cadvisor</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>source_labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>__meta_kubernetes_node_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target_label</span><span class=p>:</span><span class=w> </span><span class=l>__metrics_path__</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>数据采集的链路是 cAdvisor -> kubelet -> kube-apiserver -> Prometheus。</p><ol start=2><li>cAdvisor 对 CPU 指标的采集</li></ol><p>CPU 限流的指标主要是 <code>container_cpu_cfs_throttled_seconds_total</code> 这是 cAdvisor 源码中的定义:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span><span class=p>:</span>      <span class=s>&#34;container_cpu_cfs_throttled_seconds_total&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>help</span><span class=p>:</span>      <span class=s>&#34;Total time duration the container has been throttled.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>valueType</span><span class=p>:</span> <span class=nx>prometheus</span><span class=p>.</span><span class=nx>CounterValue</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>condition</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=nx>info</span><span class=p>.</span><span class=nx>ContainerSpec</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Cpu</span><span class=p>.</span><span class=nx>Quota</span> <span class=o>!=</span> <span class=mi>0</span> <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>getValues</span><span class=p>:</span> <span class=kd>func</span><span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>info</span><span class=p>.</span><span class=nx>ContainerStats</span><span class=p>)</span> <span class=nx>metricValues</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>metricValues</span><span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span><span class=p>:</span>     <span class=nb>float64</span><span class=p>(</span><span class=nx>s</span><span class=p>.</span><span class=nx>Cpu</span><span class=p>.</span><span class=nx>CFS</span><span class=p>.</span><span class=nx>ThrottledTime</span><span class=p>)</span> <span class=o>/</span> <span class=nb>float64</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=nx>timestamp</span><span class=p>:</span> <span class=nx>s</span><span class=p>.</span><span class=nx>Timestamp</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>}}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>cAdvisor 获取 CPU 指标的方式:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=nx>spec</span><span class=p>.</span><span class=nx>Cpu</span><span class=p>.</span><span class=nx>Limit</span> <span class=p>=</span> <span class=nf>readUInt64</span><span class=p>(</span><span class=nx>cpuRoot</span><span class=p>,</span> <span class=s>&#34;cpu.shares&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>spec</span><span class=p>.</span><span class=nx>Cpu</span><span class=p>.</span><span class=nx>Period</span> <span class=p>=</span> <span class=nf>readUInt64</span><span class=p>(</span><span class=nx>cpuRoot</span><span class=p>,</span> <span class=s>&#34;cpu.cfs_period_us&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>quota</span> <span class=o>:=</span> <span class=nf>readString</span><span class=p>(</span><span class=nx>cpuRoot</span><span class=p>,</span> <span class=s>&#34;cpu.cfs_quota_us&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>内核会动态修改这些容器文件，cAdvisor watch 了这些文件变化，当有文件创建时，说明有新的容器创建；当有文件变更时，说明指标发生了变化，这些都会触发指标的采集。</p><p>在容器中，可以看到这些文件:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls /sys/fs/cgroup/cpu
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cgroup.clone_children  cpu.cfs_quota_us   cpu.shares    cpuacct.usage         cpuacct.usage_percpu_sys   cpuacct.usage_user
</span></span><span class=line><span class=cl>cgroup.procs           cpu.rt_period_us   cpu.stat      cpuacct.usage_all     cpuacct.usage_percpu_user  notify_on_release
</span></span><span class=line><span class=cl>cpu.cfs_period_us      cpu.rt_runtime_us  cpuacct.stat  cpuacct.usage_percpu  cpuacct.usage_sys          tasks
</span></span></code></pre></td></tr></table></div></div><p>其中与 CPU 限流相关的文件是</p><ul><li>cpu.cfs_period_us</li><li>cpu.cfs_quota_us</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /sys/fs/cgroup/cpu/cpu.cfs_period_us
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>100000</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 100000 微秒，也就是 100 ms，即一个 CPU 上 cfs 控制程序使用的周期。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>200000</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的 200000 微秒，也就是 200 ms，<code>cfs_quota_us</code> 表示总的时间周期，这里的含义是可以同时两个 CPU 核心的 100 ms 时间。</p><p>而限流指标存储在这里:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /sys/fs/cgroup/cpu/cpu.stat
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>nr_periods <span class=m>2759610</span>
</span></span><span class=line><span class=cl>nr_throttled <span class=m>5592</span>
</span></span><span class=line><span class=cl>throttled_time <span class=m>30204498882</span>
</span></span></code></pre></td></tr></table></div></div><p>其中，</p><ul><li>nr_periods 已经使用的周期数</li><li>nr_throttled 被限制的周期数</li><li>throttled_time 被限制的时钟长度，单位纳秒</li></ul><p>在 Pod 的监控指标中，可以看到:</p><p><img src=/blog/images/2023/11/pod-cfs-throttled-seconds.png alt></p><ol start=3><li>Prometheus 对指标的抓取</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>prometheus.yml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>  global:
</span></span></span><span class=line><span class=cl><span class=sd>    evaluation_interval: 1m
</span></span></span><span class=line><span class=cl><span class=sd>    external_labels:
</span></span></span><span class=line><span class=cl><span class=sd>      cluster: mycluster
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_interval: 60s
</span></span></span><span class=line><span class=cl><span class=sd>    scrape_timeout: 20s
</span></span></span><span class=line><span class=cl><span class=sd>  remote_write:
</span></span></span><span class=line><span class=cl><span class=sd>  - queue_config:
</span></span></span><span class=line><span class=cl><span class=sd>      batch_send_deadline: 2s
</span></span></span><span class=line><span class=cl><span class=sd>      capacity: 5000
</span></span></span><span class=line><span class=cl><span class=sd>      max_backoff: 5s
</span></span></span><span class=line><span class=cl><span class=sd>      max_samples_per_send: 500
</span></span></span><span class=line><span class=cl><span class=sd>      min_backoff: 100ms
</span></span></span><span class=line><span class=cl><span class=sd>      max_shards: 10000
</span></span></span><span class=line><span class=cl><span class=sd>    remote_timeout: 120s
</span></span></span><span class=line><span class=cl><span class=sd>    url: http://victoria-metrics-insert/insert/0/prometheus</span><span class=w>  
</span></span></span></code></pre></td></tr></table></div></div><p>抓取周期较长，为 60s，对于 Counter 类型的指标只会损失精度，而不会错过特征，这与 Gauge 形成了鲜明的对比。</p><p>从采集到抓取，没有发现可能错过 CPU 限流监控的地方。</p><h3 id=33-告警系统会不会错过异常特征>3.3 告警系统会不会错过异常特征</h3><p>在告警系统中，使用的是 irate 并且时间段是 10s。10s 间隔能看到更多细节，如下图:</p><p><img src=/blog/images/2023/11/pod-cfs-10s-rate.png alt></p><p>但不利于监控告警，rate 能查看到趋势，5m 间隔有利于监控告警。</p><p><img src=/blog/images/2023/11/pod-cfs-5m-rate.png alt></p><p>因此可能，有一些 CPU 限流的毛刺，告警系统不能检测到。</p><p>但很遗憾的是，在这个场景下，我反复找了很多次，没有发现 CPU 限流的毛刺。</p><h2 id=4-会不会是网络流量转发慢>4. 会不会是网络流量转发慢</h2><h3 id=41-kube-proxy-中的异常日志>4.1 kube-proxy 中的异常日志</h3><p>这里有一段异常的日志引起来了我的注意。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>E1103 07:33:18.156949       1 proxier.go:900] Failed to ensure that nat chain KUBE-MARK-DROP exists: error creating chain &#34;KUBE-MARK-DROP&#34;: exit status 4: Another app is currently holding the xtables lock; still 4s 100000us time ahead to have a chance to grab the lock...
</span></span><span class=line><span class=cl>Another app is currently holding the xtables lock; still 3s 100000us time ahead to have a chance to grab the lock...
</span></span><span class=line><span class=cl>Another app is currently holding the xtables lock; still 2s 100000us time ahead to have a chance to grab the lock...
</span></span><span class=line><span class=cl>Another app is currently holding the xtables lock; still 1s 100000us time ahead to have a chance to grab the lock...
</span></span><span class=line><span class=cl>Another app is currently holding the xtables lock; still 0s 100000us time ahead to have a chance to grab the lock...
</span></span><span class=line><span class=cl>Another app is currently holding the xtables lock. Stopped waiting after 5s.
</span></span><span class=line><span class=cl>I1103 07:33:18.157007       1 proxier.go:876] Sync failed; retrying in 30s
</span></span><span class=line><span class=cl>I1103 07:33:28.798252       1 trace.go:205] Trace[1195266045]: &#34;iptables save&#34; (03-Nov-2023 07:33:26.573) (total time: 2225ms):
</span></span><span class=line><span class=cl>Trace[1195266045]: [2.225081921s] [2.225081921s] END
</span></span><span class=line><span class=cl>I1103 07:33:31.892549       1 trace.go:205] Trace[964002782]: &#34;iptables restore&#34; (03-Nov-2023 07:33:28.966) (total time: 2925ms):
</span></span><span class=line><span class=cl>Trace[964002782]: [2.925513421s] [2.925513421s] END
</span></span><span class=line><span class=cl>I1103 07:33:43.900533       1 trace.go:205] Trace[431351666]: &#34;iptables restore&#34; (03-Nov-2023 07:33:40.759) (total time: 3141ms):
</span></span></code></pre></td></tr></table></div></div><p>原来 kube-proxy 挂载了 <code>/run/xtables.lock</code>，以此仅有一个地方能够操作 iptables。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/kube-proxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>xtables-lock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/run/xtables.lock</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>如果主机有其他进程也在操作 iptables，kube-proxy 就会等待。但这个日志时不时出现一次，并且也不符合异常时的时间点。</p><h3 id=42-kube-proxy-启动配置>4.2 kube-proxy 启动配置</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat /var/lib/kube-proxy/config.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>apiVersion: kubeproxy.config.k8s.io/v1alpha1
</span></span><span class=line><span class=cl>bindAddress: 0.0.0.0
</span></span><span class=line><span class=cl>bindAddressHardFail: <span class=nb>false</span>
</span></span><span class=line><span class=cl>clusterCIDR: 10.239.0.0/16
</span></span><span class=line><span class=cl>configSyncPeriod: 15m0s
</span></span><span class=line><span class=cl>conntrack:
</span></span><span class=line><span class=cl>  maxPerCore: <span class=m>32768</span>
</span></span><span class=line><span class=cl>  min: <span class=m>131072</span>
</span></span><span class=line><span class=cl>  tcpCloseWaitTimeout: 1h0m0s
</span></span><span class=line><span class=cl>  tcpEstablishedTimeout: 24h0m0s
</span></span><span class=line><span class=cl>detectLocalMode: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>enableProfiling: <span class=nb>false</span>
</span></span><span class=line><span class=cl>healthzBindAddress: 0.0.0.0:10256
</span></span><span class=line><span class=cl>hostnameOverride: <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>iptables:
</span></span><span class=line><span class=cl>  masqueradeAll: <span class=nb>false</span>
</span></span><span class=line><span class=cl>  masqueradeBit: <span class=m>14</span>
</span></span><span class=line><span class=cl>  minSyncPeriod: 0s
</span></span><span class=line><span class=cl>  syncPeriod: 30s
</span></span><span class=line><span class=cl>mode: iptables
</span></span></code></pre></td></tr></table></div></div><p>其中，syncPeriod 意味着每隔 30s 全量同步一次 iptables 规则。那么，如果没有同步完成，碰到了下一个 30s 的同步周期，会怎么样呢？</p><h3 id=43-kube-proxy-更新-iptables-真的很慢>4.3 kube-proxy 更新 iptables 真的很慢</h3><p>应用 app-b 会大批量下载文件并存储在内存中，导致节点的网络 IO 压力、NF_CONNTRACK 表项、节点的 CPU 压力都剧增。</p><p>虽然 Kube-proxy 没有重启、没有 OOMKilled，但 kube-proxy 的 <code>kubeproxy_network_programming_duration_seconds_bucket</code> P99 指标却有异常波动。如下图:</p><p><img src=/blog/images/2023/11/kube-proxy-duration.png alt></p><p>kube-proxy 同步 iptables 规则慢，可能会导致 Pod 的流量摘除不及时，将流量转发到不存在的 Pod 上。</p><p>但应用 app-a 异常 timeout 时，并没有 Pod 的重新调度、Pod IP 发生变化的情况发生。</p><p>接着，我看了下 nf_conntrack table 的监控值，也没有满，而且上限极高。</p><p><img src=/blog/images/2023/11/node-conntrack.png alt></p><p><img src=/blog/images/2023/11/node-conntrack-limit.png alt></p><p>至此，我浪费了很多时间，也没有找到问题的根源。</p><h2 id=5-应用使用-cpu-推理慢>5. 应用使用 CPU 推理慢</h2><p>幸运的是，我不仅是 SRE 还负责开发 CICD，直接就去翻了下应用 app-a 的代码。原来应用 app-a 使用 PyTorch 框架在 CPU 上运行推理。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>vocab</span> <span class=o>=</span> <span class=n>pickle</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=nb>open</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>env</span><span class=o>.</span><span class=n>LOCAL_DATA_DIR</span><span class=p>,</span> <span class=s1>&#39;vocab_xxx.pkl&#39;</span><span class=p>),</span> <span class=s1>&#39;rb&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>cpu_num</span> <span class=o>=</span> <span class=n>env</span><span class=o>.</span><span class=n>CPU_NUM</span>
</span></span><span class=line><span class=cl><span class=n>cpu_num</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>cpu_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>cpu_num</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>os</span><span class=o>.</span><span class=n>environ</span><span class=p>[</span><span class=s2>&#34;OMP_NUM_THREADS&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>cpu_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>torch</span><span class=o>.</span><span class=n>set_num_threads</span><span class=p>(</span><span class=n>cpu_num</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s1>&#39;cpu&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>model_path</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>env</span><span class=o>.</span><span class=n>CLOUD_DATA_DIR</span><span class=p>,</span> <span class=s2>&#34;xxx_model.ckpt&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>config</span> <span class=o>=</span> <span class=n>Config</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>config</span><span class=o>.</span><span class=n>n_vocab</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>vocab</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=n>xxx_model</span><span class=o>.</span><span class=n>Model</span><span class=p>(</span><span class=n>config</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=bp>self</span><span class=o>.</span><span class=n>model</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>to</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>device</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>exists</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model_path</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>model</span><span class=o>.</span><span class=n>load_state_dict</span><span class=p>(</span><span class=n>torch</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>model_path</span><span class=p>,</span> <span class=n>map_location</span><span class=o>=</span><span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&#34;cpu&#34;</span><span class=p>)),</span> <span class=kc>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>raise</span> <span class=ne>Exception</span><span class=p>(</span><span class=s2>&#34;Model file not exists&#34;</span><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div><p>CPU 运行的推理应用与普通应用不同:</p><p><img src=/blog/images/2023/11/pod-cpu-usage-limit.png alt></p><p>虽然提供了大量的 CPU，但 CPU 使用率很低，同时有大量推理任务依然需要 3-257s，高峰期慢推理能达到 800 /秒。</p><p><img src=/blog/images/2023/11/pod-slow-log.png alt></p><p>至此，没有其他线索了，并不全是 IaaS 层资源的问题，主要是 CPU 扛不住低延时、大吞吐的推理任务。</p><h2 id=6-总结>6. 总结</h2><p>本篇主要是记录了一次应用慢的排查过程。最后没有找到问题的根源，但发现了不少目前大集群的问题。</p><p>排查应用慢时的思路主要如下:</p><ol><li>CPU 限流，看 Pod 的 CPU 指标、节点的 CPU 指标是否有异常</li><li>磁盘 IO 慢，看 iowait、iops、io 队列数、读写延迟等是否有异常</li><li>网络慢，沿着流量路径，查看网络指标是否有异常</li><li>应用依赖的服务，本篇中的 app-a 没有外部依赖，因此跳过了这个环节</li></ol><p>由于这次碰到的是一个推理应用，其实还会涉及输入文本的长度、<code>BATCH_SIZE</code> 大小、模型的复杂度等因素，但这些因素都是应用层的问题，不在本篇的讨论范围。</p></article><script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script>"use strict";document.addEventListener("DOMContentLoaded",function(){var e=!1,t=document.querySelectorAll("pre.chroma"),n=document.querySelectorAll(".language-code"),s=document.querySelectorAll("div.language-\\$"),o=document.querySelectorAll("div.language-\\>"),i=function(t){var s,o,i,a,r,c,l,d=t,n=t.textContent;if(n.length>15){e||(a=new ClipboardJS(".copy-to-clipboard",{text:function(e){var t=prev(e).querySelectorAll("code");return t.length>1?n=prev(e).querySelector('code[class^="language-"]').textContent:n=prev(e).querySelector("code").textContent,n.replace(/^\$\s/gm,"")}}),a.on("success",function(e){e.clearSelection(),l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label","Copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),a.on("error",function(e){l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label",e.action.toString()),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),e=!0),r=["language-mermaid","language-viz","language-wave","language-chart","language-msc","language-flowchart"],c=!1,s=d.getAttribute("class");for(o=0;o<r.length;o++)if(s&&s.startsWith(r[o])){c=!0;break}c||s&&(i=document.createElement("span"),i.setAttribute("class","copy-to-clipboard"),i.setAttribute("title","Copy to clipboard"),t.parentNode.parentNode.insertBefore(i,t.parentNode.nextElementSibling))}},a=function(e){var t=document.createElement("span");t.setAttribute("class","copy-to-clipboard"),t.setAttribute("title","Copy to clipboard"),e.parentNode.parentNode.insertBefore(t,e.parentNode.nextElementSibling)};t?t.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,n?n.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,s?s.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null,o?o.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null})</script><script>"use strict";function wrap(e,t){e.parentNode.insertBefore(t,e),t.appendChild(e)}(function(){var e=document.querySelector(".single__contents");e?e.querySelectorAll("pre > code").forEach(function(e){var t=e.getAttribute("data-lang"),n=document.createElement("div"),o=null,s=null;t&&t.includes(":")?(o=t.split(":")[0],s=t.split(":")[1],n.className="language-"+o,n.setAttribute("data-lang",s),e.className="language-"+o,e.setAttribute("data-lang",s),e.setAttribute("id",s)):t||(n.setAttribute("data-lang","Code"),n.className="language-code"),(!t||s)&&wrap(e.parentNode,n)}):null})();var langCodeElem=document.querySelectorAll(".language-code"),dollarCodeElem,gtCodeElem;langCodeElem?langCodeElem.forEach(function(e){var t=document.createElement("span");t.className="copy-to-clipboard",t.setAttribute("title","Copy to clipboard"),e.append(t)}):null,dollarCodeElem=document.querySelectorAll("div.language-\\$"),gtCodeElem=document.querySelectorAll("div.language-\\>"),dollarCodeElem?dollarCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="$<br/>"}):null}):null,gtCodeElem?gtCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="><br/>"}):null}):null</script><div class=whoami__gutter></div><hr class="hr-slash whoami-hr"><section class=whoami><div class=whoami__image-wrapper><img data-src=/static/images/chenshaowen.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=微信公众号 class="lazyload whoami__image"></div><div class=whoami__contents><div class=whoami__written-by>作者</div><div class=whoami__title>微信公众号</div><div class=whoami__desc></div><div class=whoami__social></div></div></section><hr class="hr-slash whoami-hr"><section class=related><h1 class=related__title><hr class=hr-dots><div>相关内容</div><hr class=hr-dots></h1><ul class=related-ul><li><a href=/blog/solving-the-problem-of-celery-processe-large-file-failure.html class=related__link>Celery 处理大文件失败问题排查与解决</a></li><li><a href=/blog/source-analysis-kubernetes-management-of-pod-ip.html class=related__link>源码分析 Kubernetes 对 Pod IP 的管理</a></li><li><a href=/blog/how-to-run-llama-on-cpu.html class=related__link>使用 CPU 推理 llama 结构的大模型</a></li><li><a href=/blog/insight-kubernetes-network-by-kindling.html class=related__link>使用 Kindling 观测 Kubernetes 的网络连接</a></li><li><a href=/blog/a-global-images-distribution-network.html class=related__link>面向全球的镜像分发网络</a></li></ul></section><div class=grow></div><nav class=pagination-single><a href=https://www.chenshaowen.com/blog/source-analysis-kubernetes-management-of-pod-ip.html class=pagination-single__left><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg></div><div class=pagination-single__left-title>源码分析 Kubernetes 对 Pod IP 的管理</div></a><div class=grow></div><a href=https://www.chenshaowen.com/blog/how-to-intialize-pci-ssd.html class=pagination-single__right><div class=pagination-single__right-title>安装并初始化 PCI 接口的 SSD</div><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg></div></a></nav><div class="modal micromodal-slide" id=modal aria-hidden=true><div class=modal__overlay tabindex=-1 data-micromodal-close><div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title><div class=modal__content id=modal-content><div id=mySwipe class=swipe><div class=swipe-wrap></div></div></div><span class=modal__items><span class=modal__header><div class=modal__paging title="Page Info" aria-label="Current Page"></div><div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg></div></span><div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg></div><div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg></div><div class=modal__caption><div class=modal__caption--text></div></div></span></div></div></div><script defer src=/js/swipe.min.feb438efb7ca009ecd7fc2ac3ad2fced4840990b2798d81f87137f2dc6281f05.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var e,t,n,o,i,a,r,c,l,d,u,h,f,p,g,v,b,s=document.documentElement;function j(){s.requestFullscreen?s.requestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen():s.msRequestFullscreen&&s.msRequestFullscreen()}function m(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}c=document.getElementById("modal"),i=document.querySelector(".gallery__container"),v=document.querySelector(".swipe-wrap"),b=document.getElementById("mySwipe"),u=document.querySelector(".modal__arrow--left"),f=document.querySelector(".modal__arrow--right"),h=document.querySelector(".modal__toolbar--close"),t=document.querySelector(".modal__toolbar--full"),n=document.querySelector(".modal__toolbar--normal"),r=document.querySelector(".modal__caption"),d=document.querySelector(".modal__paging"),o=document.querySelector(".modal__items"),a=null,l=null,e=null,p=function(t){t.key==="ArrowRight"?c&&c.classList.contains("is-open")&&e.next():t.key==="ArrowLeft"&&c&&c.classList.contains("is-open")&&e.prev()},i?a=i.querySelectorAll("img").length:(i=document.querySelector(".single__contents"),a=i.querySelectorAll("img").length),MicroModal.init({onClose:function(){e&&(e.kill(),e=null,m()),window.removeEventListener("keydown",p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),g=function(e){return new Promise(function(t,n){var s=new Image;s.onload=function(){t(s)},s.onerror=n,s.src=e})},i.querySelectorAll("img").forEach(function(s,i){s.style.cursor="pointer";var c,u=s.cloneNode(!0);u.style.maxHeight="100%",u.style.maxWidth="100%",u.onclick=function(e){e.stopPropagation()},c=document.createElement("div"),c.style.width="100%",c.style.height="100vh",c.setAttribute("data-micromodal-close",""),c.onclick=function(){e&&(e.kill(),e=null)},c.onmouseenter=function(){clearTimeout(l),fadeIn(o,200)},c.onmouseleave=function(){l=setTimeout(function(){fadeOut(o,200)},2500)},c.ontouchstart=function(){fadeIn(o,200)},c.append(u),v.append(c),s.addEventListener("click",async function(s){MicroModal.show("modal"),e&&(e.kill(),e=null);var c,m=s.target.getAttribute("data-src")||s.target.getAttribute("src"),h=await g(m);u.style.width=h.width+"px",u.style.height=h.height+"px",e=new Swipe(b,{startSlide:i,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(e,t){var s,n=t.querySelector("img"),c=n.getAttribute("data-src")||n.getAttribute("src"),i=await g(c);n.style.width=i.width+"px",n.style.height=i.height+"px",r&&n&&(s=null,n.getAttribute("data-caption")?s=n.getAttribute("data-caption"):n.getAttribute("title")?s=n.getAttribute("title"):n.getAttribute("alt")?s=n.getAttribute("alt"):s=n.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=s,d.innerText=e+1+" / "+a,clearTimeout(l),fadeIn(o,200))}}),fadeIn(o),r&&(c=null,s.target.getAttribute("data-caption")?c=s.target.getAttribute("data-caption"):s.target.getAttribute("title")?c=s.target.getAttribute("title"):s.target.getAttribute("alt")?c=s.target.getAttribute("alt"):c=s.target.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=c,d.innerText=i+1+" / "+a),n&&t&&(n.style.zIndex=-1,n.style.opacity=0,t.style.zIndex=25,t.style.opacity=1)}),window.addEventListener("keydown",p)}),u?u.addEventListener("click",function(){e&&e.prev()}):null,f?f.addEventListener("click",function(){e&&e.next()}):null,h?h.addEventListener("click",function(){e&&(e.kill(),e=null),m(),MicroModal.close("modal")}):null,t?t.addEventListener("click",function(){j(),n&&(n.style.zIndex=25,n.style.opacity=1,t.style.zIndex=-1,t.style.opacity=0)}):null,n?n.addEventListener("click",function(){m(),t&&(t.style.zIndex=25,t.style.opacity=1,n.style.zIndex=-1,n.style.opacity=0)}):null})</script><div class=hide><div class=search><span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><input id=search aria-label="Site Search" class=input type=text placeholder=搜索 autocomplete=off><div id=search-results class=dropdown><div id=search-menu class=dropdown-menu role=menu></div></div></div></div></div></main><aside class="single__side main-side"><section class="sidebar hide"><script>document.querySelector(".sidebar").classList.remove("hide")</script><div class=toc__flexbox data-position=fixed><h6 class=toc__title data-ani=true>目录</h6><label class=switch data-ani=true><input id=toggle-toc aria-label="Toggle TOC" type=checkbox checked>
<span class="slider round"></span></label></div><div class=toc data-dir=ltr data-folding=true data-ani=true><nav id=TableOfContents><ul><li><a href=#1-现象>1. 现象</a></li><li><a href=#2-排查问题>2. 排查问题</a><ul><li><a href=#21-排查磁盘-io>2.1 排查磁盘 IO</a></li><li><a href=#22-排查网络-io>2.2 排查网络 IO</a></li><li><a href=#23-找到问题>2.3 找到问题</a></li><li><a href=#24-解决问题>2.4 解决问题</a></li></ul></li><li><a href=#3-为什么-pod-cpu-没有被限流>3. 为什么 Pod CPU 没有被限流</a><ul><li><a href=#31-k8s-中的-cfs-限流机制>3.1 K8s 中的 CFS 限流机制</a></li><li><a href=#32-kubelet-对-pod-cpu-指标的采集>3.2 kubelet 对 Pod CPU 指标的采集</a></li><li><a href=#33-告警系统会不会错过异常特征>3.3 告警系统会不会错过异常特征</a></li></ul></li><li><a href=#4-会不会是网络流量转发慢>4. 会不会是网络流量转发慢</a><ul><li><a href=#41-kube-proxy-中的异常日志>4.1 kube-proxy 中的异常日志</a></li><li><a href=#42-kube-proxy-启动配置>4.2 kube-proxy 启动配置</a></li><li><a href=#43-kube-proxy-更新-iptables-真的很慢>4.3 kube-proxy 更新 iptables 真的很慢</a></li></ul></li><li><a href=#5-应用使用-cpu-推理慢>5. 应用使用 CPU 推理慢</a></li><li><a href=#6-总结>6. 总结</a></li></ul></nav></div></section></aside><script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"inner"'),singleMainElem=document.querySelector(".single__main"),singleSideElem=document.querySelector(".single__side");enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main"),singleSideElem.classList.remove("main-side"),singleSideElem.classList.add("hide")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"))},unmatch:function(){(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove("main"),singleMainElem.classList.add("main-main"),singleSideElem.classList.remove("hide"),singleSideElem.classList.add("main-side")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"));var t=document.querySelector(".navbar__burger"),e=document.getElementsByClassName("navbarm__collapse")[0];e&&(e.setAttribute("data-open",!1),e.style.maxHeight=0,t.classList.remove("is-active")),document.getElementsByClassName("navbar__menu")[0].classList.remove("is-active"),document.getElementsByClassName("mobile-search")[0].classList.add("hide")},setup:function(){},deferSetup:!0,destroy:function(){}})</script><script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script defer src=/js/helper/throttle.min.js></script>
<script>"use strict";window.onload=function(){var e,t,n,s,o,i,r,c,l,d,u,h,m,f,p,g,v,b,j,y,_,w,O,x,C,E,k,A,S,M,F,T,z,D,N,H,a=document.querySelector(".navbar"),P=document.querySelector(".single__contents"),R=JSON.parse("false"),L=JSON.parse("true");R&&L&&(y=document.querySelector("#busuanzi_value_page_pv"),y.textContent=y.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),S=JSON.parse("true"),z=JSON.parse("null"),D=JSON.parse("false"),d=document.querySelector(".toc__flexbox"),u=document.querySelector(".toc__flexbox--outer"),x=JSON.parse("true"),(S||z)&&document.querySelector(".toc")&&(i=document.querySelector(".toc").querySelector("#TableOfContents"),i.onmouseenter=function(){a.classList.contains("scrolling")&&a.classList.remove("scrolling")},i.onmouseleave=function(){a.classList.contains("scrolling")||a.classList.add("scrolling")},!1===x||(i.querySelectorAll("ul")?i.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),i&&(i.querySelectorAll("a").length>0?i.querySelectorAll("a").forEach(function(e){e.addEventListener("click",function(){var t,n=e.getAttribute("id");a.classList.contains("scrolling")||(a.classList.remove("navbar--show"),a.classList.remove("navbar--hide"),a.classList.add("navbar--hide")),document.querySelector(".toc").querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),e.classList.add("active"),t=i.querySelector('[href="#'+n+'"]'),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),t&&(getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null)})}):(d&&(d.setAttribute("data-position",""),d.classList.contains("hide")||d.classList.add("hide")),u&&(u.setAttribute("data-position",""),u.classList.contains("hide")||u.classList.add("hide")))),b=document.getElementById("toggle-toc"),v=document.getElementById("visible-toc"),s=document.querySelector(".toc"),o=document.querySelector("main"),l=document.querySelector("side"),c=document.querySelector(".toc__flexbox"),b?b.addEventListener("change",function(e){e.target.checked?(s&&fadeIn(s,200),c&&c.setAttribute("data-position","fixed"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main-main")),l&&l.classList.remove("main-side")):(s&&fadeOut(s,200),c&&c.setAttribute("data-position","absolute"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main")),l&&l.classList.remove("main-side"))}):null,v?v.addEventListener("change",function(e){e.target.checked?s&&fadeIn(s,200):s&&fadeOut(s,200)}):null),C=120,M=70,A=function(){s&&(s.style.maxHeight=window.innerHeight-C-M+"px")},w=throttle(A,300),w(),window.addEventListener("resize",w),E=new ClipboardJS(".anchor"),j=P.querySelectorAll("h1, h2, h3, h4"),F=JSON.parse('"ltr"'),j?j.forEach(function(e){var t,s=parseInt(e.tagName.substr(1),10)*2,o=encodeURI(document.location.origin+document.location.pathname),i=o+"#"+e.getAttribute("id"),n=document.createElement("span");n.classList.add("anchor"),n.classList.add("hide"),n.setAttribute("data-clipboard-text",decodeURI(i)),n.style.position="relative",t=document.createElement("span"),t.style.position="absolute",t.style.top="50%",t.style.left="0.75rem",t.style.transform="translateY(-50%)",t.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-s}px" height="${32-s}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,F==="rtl"?t.style.left="-2rem":t.style.right="-2rem",n.append(t),e.append(n),e.addEventListener("mouseenter",function(){this.querySelector(".anchor").classList.remove("hide")}),e.addEventListener("mouseleave",function(){this.querySelector(".anchor").classList.add("hide")})}):null,document.querySelectorAll(".anchor").forEach(function(e){e.addEventListener("mouseleave",function(){e.setAttribute("aria-label",null),e.classList.remove("tooltipped"),e.classList.remove("tooltipped-s"),e.classList.remove("tooltipped-w")})}),E.on("success",function(e){e.clearSelection(),e.trigger.setAttribute("aria-label","Link copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-s")}),t=JSON.parse("null"),t&&t.includes("mermaid")&&(O=localStorage.getItem("theme")||JSON.parse('"light"'),O==="dark"||O==="hacker"?mermaid.initialize({theme:"dark"}):mermaid.initialize({theme:"default"}),_=[],[].push.apply(_,document.getElementsByClassName("language-mermaid")),_.forEach(function(e){var n,t=e.parentNode;t!==document.body&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t)),n=document.createElement("div"),n.classList.add("mermaid"),n.style.padding="34px 4px 6px",n.innerHTML=e.innerHTML,e.replaceWith(n)})),t&&t.includes("katex")&&(N=document.getElementsByClassName("math"),r={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector(".single__contents"),r)),t&&t.includes("flowchartjs")&&(r=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),n=null,T="language-flowchart",e=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+T+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="flowchart"+e,t.parentNode.insertBefore(s,t),o=flowchart.parse(n),o.drawSVG("flowchart"+e,r),e+=1})),document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"}),t&&t.includes("msc")&&(r=JSON.parse('{"theme":"hand"}'),n=null,e=0,h="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="msc"+e,t.parentNode.insertBefore(s,t),o=Diagram.parse(n),o.drawSVG("msc"+e,r),e+=1})),t&&t.includes("chart")&&(m="#666",f="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=m,Chart.defaults.global.elements.rectangle.backgroundColor=f,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=m,Chart.defaults.global.elements.line.backgroundColor=f,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=m,Chart.defaults.global.elements.point.backgroundColor=f,h="language-chart",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var i,a,s=document.createElement("canvas"),o=null;s.height=200,s.style.height=200,s.id="myChart"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),i=document.getElementById("myChart"+e).getContext("2d"),a=new Chart(i,o),e+=1})),t&&t.includes("wavedrom")&&(k="language-wave",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+k+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var s=document.createElement("div"),o=null;s.id="WaveDrom_Display_"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),WaveDrom.RenderWaveForm(e,o,"WaveDrom_Display_"),e+=1})),t&&t.includes("viz")&&(g="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+g+"]"),function(e){e.style.display="none",e.parentNode.style.backgroundColor="transparent",e.getAttribute("class").split(" ").forEach(function(e){e.startsWith(g)&&(t=e.substr(g.length))});var t,n=new Viz;n.renderSVGElement(e.innerText,{engine:t}).then(function(t){t.style.width="100%",e.parentNode.insertBefore(t,e)})}))}</script><footer class=footer><div id=gtt><div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg></div></div><hr><div class="basicflex flexwrap"><a href=https://beian.miit.gov.cn/ class=footer__link target=_blank rel=noreferrer>鄂ICP备15009848号-4</a></div><div class=footer__poweredby><p class=caption>©2016 - 2025, All Rights Reserved.</p></div></footer></div><div class="wrapper__right hide" data-pad=true dir=ltr><script>document.querySelector(".wrapper__right").classList.remove("hide")</script></div></div></body></html>