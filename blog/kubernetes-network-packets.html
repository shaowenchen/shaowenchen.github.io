<!doctype html><html lang=zh dir=ltr><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Kubernetes 网络流量转发详解 – 陈少文的网站</title><script defer src=/js/fuse.min.32195737929df2c8096e855a5789cbb3f1331224d9169e8705493e7008f47df8.js></script>
<script src=/js/enquire.min.dfb99dee1e029d51d6cfb672d847929890b1585402de17f5ed092edd72a688b4.js></script>
<script defer src=/js/lazysizes.min.fb649fcae62177dfe63e67081ddceb830b5ce1f05a4184e9bbb7d87ac4b8f4e5.js></script>
<script defer src=/js/helper/getParents.min.086022fb02d7a1517e33c2670bffb976b3e80bcacd9caeee0c6a586064f20e42.js></script>
<script defer src=/js/helper/fadeinout.min.3ce954c8aea3b69cc5e6f734d8273ba4cd48d3a7987dbdca145849bc4b8fc296.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script>"use strict";window.NodeList&&!NodeList.prototype.forEach&&(NodeList.prototype.forEach=Array.prototype.forEach),String.prototype.includes||(String.prototype.includes=function(e,t){"use strict";if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return t===void 0&&(t=0),this.indexOf(e,t)!==-1}),Document.prototype.append=Element.prototype.append=function(){this.appendChild(_mutation(arguments))};function _mutation(e){if(!e.length)throw new Error("DOM Exception 8");if(e.length===1)return typeof e[0]=="string"?document.createTextNode(e[0]):e[0];for(var t,n=document.createDocumentFragment(),o=e.length,s=-1;++s<o;)t=e[s],n.appendChild(typeof t=="string"?document.createTextNode(t):t);return n}String.prototype.startsWith||(String.prototype.startsWith=function(e,t){return t=t||0,this.indexOf(e,t)===t}),document.addEventListener("DOMContentLoaded",function(){var e,t,n,s,o,i,a,r,c,l,d,u,h,m,f,p,v,b,j,y,_,w,O,x,C,k,A,S,M,F,T,z,D,N,L,R,P,H,I,B,V,$,W,U,K,q,Y,G,E=document.querySelector(".navbar__burger"),ie,ae,re,ce,ue,de,le,oe,se,ne,te,pe,fe,he;E?E.addEventListener("click",function(){var n,t=document.querySelector(".navbarm__collapse");t&&(n=t.getAttribute("data-open"),n==="true"?(t.setAttribute("data-open","false"),t.style.maxHeight=0,E.classList.remove("is-active")):(t.setAttribute("data-open","true"),t.style.maxHeight=t.scrollHeight+"px",E.classList.add("is-active")))}):null,q=document.querySelectorAll(".single__contents > table");for(let e=0;e<q.length;e++)M=q[e],F=document.createElement("div"),F.className="table-wrapper",M.parentElement.replaceChild(F,M),F.appendChild(M);V=document.querySelectorAll(".footnote-ref"),B=document.querySelectorAll(".footnote-backref"),V?V.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,B?B.forEach(function(e){e.onmouseenter=function(){t.classList.contains("scrolling")&&t.classList.remove("scrolling")},e.onmouseleave=function(){t.classList.contains("scrolling")||setTimeout(function(){t.classList.add("scrolling")},100)},e.onclick=function(){t.classList.contains("scrolling")||(t.classList.remove("navbar--show"),t.classList.remove("navbar--hide"),t.classList.add("navbar--hide"))}}):null,s=document.querySelector(".summary__container"),i=document.querySelector(".search-result"),D=document.querySelector(".search-result__close"),D?D.addEventListener("click",function(){i.setAttribute("data-display","none"),s.setAttribute("data-display","block")}):null,document.querySelectorAll(".tab")?document.querySelectorAll(".tab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".tab__link"),s=e.querySelectorAll(".tab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,document.querySelectorAll(".codetab")?document.querySelectorAll(".codetab").forEach(function(e){var o=e.getAttribute("id"),i=e,n=e.querySelectorAll(".codetab__link"),s=e.querySelectorAll(".codetab__content"),a=[];n&&n.length>0?n.forEach(function(e,t,n){e.onclick=function(){for(var o=0;o<n.length;o++)t===parseInt(o,10)?n[o].classList.contains("active")||(n[o].classList.add("active"),s[o].style.display="block"):(n[o].classList.remove("active"),s[o].style.display="none")}}):null}):null,v=document.getElementById("gtt"),v.style.display="none",v.addEventListener("click",function(){window.document.documentMode?document.documentElement.scrollTop=0:ge(250)});function ge(e){var t=-window.scrollY/(e/15),n=setInterval(function(){window.scrollY!=0?window.scrollBy(0,t):clearInterval(n)},15)}ie=function(){document.body.scrollTop>250||document.documentElement.scrollTop>250?v.style.display="block":v.style.display="none"},P=document.querySelectorAll(".expand__button");for(let e=0;e<P.length;e++)P[e].addEventListener("click",function(){var e=this.nextElementSibling;e.style.maxHeight?(e.style.maxHeight=null,this.querySelector("svg").classList.add("expand-icon__right"),this.querySelector("svg").classList.remove("expand-icon__down")):(e.style.maxHeight=e.scrollHeight+"px",this.querySelector("svg").classList.remove("expand-icon__right"),this.querySelector("svg").classList.add("expand-icon__down"))});z=window.pageYOffset||document.documentElement.scrollTop,p=document.querySelector(".toc"),r=p?p.querySelector("#TableOfContents"):null,x=document.getElementById("toggle-toc"),d=document.querySelector(".single__contents"),t=document.querySelector(".navbar"),b=document.querySelector(".toc__flexbox"),j=document.querySelector(".toc__flexbox--outer"),L=document.querySelectorAll(".expand__content"),N=document.querySelectorAll(".box"),o=null,S=JSON.parse("true"),a=JSON.parse('["h2","h3","h4"]'),a?a=a.toString():a="h1, h2, h3, h4, h5, h6",d&&d.querySelectorAll(".tab")?d.querySelectorAll(".tab").forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,L?L.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,N?N.forEach(function(e){e.querySelectorAll(a).forEach(function(e){o=Array.isArray(o)?o.concat(e.getAttribute("id")):[e.getAttribute("id")]})}):null,window.onscroll=function(){ie();var e=window.pageYOffset||document.documentElement.scrollTop;if(e>z){if(e<250?v.style.display="none":v.style.display="block",e<45)return null;t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.contains("navbar--show")&&t.classList.remove("navbar--show"):t.classList.add("navbar--hide")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&(b.setAttribute("data-position",""),b.classList.contains("hide")||b.classList.add("hide")),j&&(j.setAttribute("data-position",""),j.classList.contains("hide")||j.classList.add("hide"))))}else e<250&&(v.style.display="none"),t.classList.contains("scrolling")&&(t.classList.contains("navbar--hide")?t.classList.remove("navbar--hide"):t.classList.contains("navbar--show")||t.classList.add("navbar--show")),d&&(d.querySelectorAll(a).length>0?d.querySelectorAll(a).forEach(function(e){if(x&&!x.checked)return null;if(o&&o.includes(e.getAttribute("id")))return null;if(document.documentElement.scrollTop>=e.offsetTop&&r){var t,n=e.getAttribute("id");p.querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),p.querySelector('a[href="#'+n+'"]')?p.querySelector('a[href="#'+n+'"]').classList.add("active"):null,!1===S||(r.querySelectorAll("ul")?r.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),t=r.querySelector("[href='#"+n+"']"),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null}}):(b&&!b.classList.contains("hide")&&b.classList.add("hide"),j&&!j.classList.contains("hide")&&j.classList.add("hide"))),r&&document.documentElement.scrollTop<250&&(!1===S||(r.querySelector("ul")?r.querySelector("ul").querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})}):null));z=e<=0?0:e},A=localStorage.getItem("theme"),T=document.getElementById("root"),ae=document.querySelectorAll(".select-theme"),C=document.querySelectorAll(".select-theme__item"),re=JSON.parse('"dark"'),ce=JSON.parse('"light"'),ue=JSON.parse('"hacker"'),de=JSON.parse('"solarized"'),le=JSON.parse('"kimbie"'),k=function(e){var t=document.getElementsByName("msapplication-TileColor")[0],n=document.getElementsByName("theme-color")[0],s=document.getElementsByName("msapplication-navbutton-color")[0],o=document.getElementsByName("apple-mobile-web-app-status-bar-style")[0];e.includes("dark")?(t.setAttribute("content","#fcfcfa"),n.setAttribute("content","#403E41"),s.setAttribute("content","#403E41"),o.setAttribute("content","#403E41")):e.includes("light")?(t.setAttribute("content","#555"),n.setAttribute("content","#eee"),s.setAttribute("content","#eee"),o.setAttribute("content","#eee")):e.includes("hacker")?(t.setAttribute("content","#e3cd26"),n.setAttribute("content","#252526"),s.setAttribute("content","#252526"),o.setAttribute("content","#252526")):e.includes("solarized")?(t.setAttribute("content","#d3af86"),n.setAttribute("content","#51412c"),s.setAttribute("content","#51412c"),o.setAttribute("content","#51412c")):e.includes("kimbie")&&(t.setAttribute("content","#586e75"),n.setAttribute("content","#eee8d5"),s.setAttribute("content","#eee8d5"),o.setAttribute("content","#eee8d5"))},Y=function(e){if(e===re)return"dark";if(e===ce)return"light";if(e===ue)return"hacker";if(e===de)return"solarized";if(e===le)return"kimbie"},A?(C?C.forEach(function(e){e.text.trim()===A?e.classList.add("is-active"):e.classList.remove("is-active")}):null,k(A)):k(T.className),C?C.forEach(function(e){e.addEventListener("click",function(e){var n,s,t=Y(e.target.text.trim());localStorage.setItem("theme",t),k(t),T.removeAttribute("class"),T.classList.add("theme__"+t),ae.forEach(function(e){e.querySelectorAll("a").forEach(function(e){e.classList&&(e.text.trim()===t?e.classList.contains("is-active")||e.classList.add("is-active"):e.classList.contains("is-active")&&e.classList.remove("is-active"))})}),window.mermaid&&(t==="dark"||t==="hacker"?(mermaid.initialize({theme:"dark"}),location.reload()):(mermaid.initialize({theme:"default"}),location.reload())),n=document.getElementById("utterances"),n&&n.querySelector("iframe").contentWindow.postMessage({type:"set-theme",theme:t==="dark"||t==="hacker"?"photon-dark":t==="kimbie"?"github-dark-orange":"github-light"},"https://utteranc.es"),s=document.querySelectorAll(".twitter-timeline"),s&&window.postMessage({type:"set-twitter-theme",theme:t==="light"||t==="solarized"?"light":"dark"})})}):null,G=JSON.parse('"https://www.chenshaowen.com"'),oe=JSON.parse('"https://www.chenshaowen.com/blog/kubernetes-network-packets.html"'),se=JSON.parse('""'),l=null,c=null,n=null,ne=JSON.parse("true"),y=JSON.parse("true"),U=JSON.parse('"main"'),K=JSON.parse('"post"'),te=JSON.parse('"page"'),O=null,ne&&function(){var t=new XMLHttpRequest;K==="publication"&&te!=="page"?t.open("GET",oe+"index.json"):t.open("GET",G+se+"/index.json"),t.setRequestHeader("Content-Type","application/json; charset=utf-8"),t.onload=function(){t.status===200?(O=new Fuse(JSON.parse(t.response.toString("utf-8")),{keys:K.includes("publication")?["title","abstract"]:["title","description","content"],includeMatches:y,shouldSort:!0,threshold:.4,location:0,distance:100,maxPatternLength:32,minMatchCharLength:1,isCaseSensitive:!1,findAllMatches:!1,useExtendedSearch:!1}),window.fuse=O):console.error("["+t.status+"]Error:",t.statusText)},t.send()}();function me(e,t){var n,s,o=document.createElement("li");o.className="search-result__item",n=document.createElement("a"),n.innerHTML=t.item.title,n.setAttribute("class","search-result__item--title"),n.setAttribute("href",t.item.permalink),s=document.createElement("div"),s.setAttribute("class","search-result__item--desc"),t.item.description?s.innerHTML=t.item.description:t.item.content&&(s.innerHTML=t.item.content.substring(0,225)),o.appendChild(n),o.appendChild(s),e.appendChild(o)}function be(e,t){var n,s,o,i=document.createElement("li");if(i.className="search-result__item",n=null,o=document.createElement("a"),o.innerHTML=t.item.title,o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri),t.matches&&t.matches.length){for(s=0;s<t.matches.length;s++)"title"===t.matches[s].key&&(o=document.createElement("a"),o.innerHTML=g(t.matches[s].value,t.matches[s].indices),o.setAttribute("class","search-result__item--title"),o.setAttribute("href",t.item.uri)),"description"===t.matches[s].key?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.description,t.matches[s].indices)):"content"===t.matches[s].key?n||(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=g(t.item.content.substring(0,150),t.matches[s].indices)):t.item.description?(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.description):(n=document.createElement("div"),n.setAttribute("class","search-result__item--desc"),n.innerHTML=t.item.content.substring(0,150));i.appendChild(o),n&&i.appendChild(n),i&&e.appendChild(i)}}function Q(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var t,o,i=document.createElement("li"),s=document.createElement("a");s.setAttribute("href",e.uri),s.setAttribute("class","dropdown-item"),s.appendChild(i),o=document.createElement("div"),o.innerHTML=e.title,o.setAttribute("class","menu-item__title"),t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),e.description?t.innerHTML=e.description:e.content&&(t.innerHTML=e.content.substring(0,150)),i.appendChild(o),i.appendChild(t),n.appendChild(s)}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function Z(e,t){l=document.getElementById("search-results"),c=document.getElementById("search-menu"),l.setAttribute("class","dropdown is-active");var s,n=document.createElement("ul");for(n.setAttribute("class","dropdown-content search-content"),t.length?t.forEach(function(e){var s,o,a=document.createElement("li"),i=document.createElement("a"),t=null;if(i.setAttribute("href",e.item.uri),i.setAttribute("class","dropdown-item"),i.appendChild(a),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","menu-item__title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","menu-item__desc"),t.innerHTML=e.item.content.substring(0,150));a.appendChild(o),t&&a.appendChild(t),n.appendChild(i)}}):(s=document.createElement("li"),s.setAttribute("class","dropdown-item"),s.innerText="No results found",n.appendChild(s));c.hasChildNodes();)c.removeChild(c.lastChild);c.appendChild(n)}function J(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length>0?t.forEach(function(e){var t=document.createElement("a");t.setAttribute("href",e.uri),t.innerHTML='<div class="mobile-search__item"><div class="mobile-search__item--title">📄 '+e.title+'</div><div class="mobile-search__item--desc">'+(e.description?e.description:e.content)+"</div></div>",n.appendChild(t)}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function ve(e,t){l=document.getElementById("search-mobile-results");var o,n=document.createElement("div");n.setAttribute("class","mobile-search__content"),t.length?t.forEach(function(e){var s,o,i=document.createElement("li"),a=document.createElement("a"),t=null;if(a.setAttribute("href",e.item.uri),a.appendChild(i),i.setAttribute("class","mobile-search__item"),o=document.createElement("div"),o.innerHTML=e.item.title,o.setAttribute("class","mobile-search__item--title"),e.matches&&e.matches.length){for(s=0;s<e.matches.length;s++)"title"===e.matches[s].key&&(o.innerHTML=g(e.matches[s].value,e.matches[s].indices)),"description"===e.matches[s].key?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.description,e.matches[s].indices)):"content"===e.matches[s].key?t||(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=g(e.item.content.substring(0,150),e.matches[s].indices)):e.item.description?(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.description):(t=document.createElement("div"),t.setAttribute("class","mobile-search__item--desc"),t.innerHTML=e.item.content.substring(0,150));i.appendChild(o),t&&i.appendChild(t),n.appendChild(a)}}):(o=document.createElement("span"),n.appendChild(o));let s=document.getElementById("search-mobile-results");for(;s.firstChild;)s.removeChild(s.firstChild);l.appendChild(n)}function g(e,t){if(!t)return e;var n="",s=0;return t.forEach(function(t){if(t[0]===t[1])return null;n+=""+e.substring(s,t[0])+'<span class="search__highlight">'+e.substring(t[0],t[1]+1)+"</span>",s=t[1]+1}),n+=e.substring(s),n}u=document.getElementById("search"),H=document.getElementById("search-mobile"),m=document.getElementById("search-results"),u?u.addEventListener("input",function(e){if(!e.target.value|window.innerWidth<770)return m?m.setAttribute("class","dropdown"):null,i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null,null;n=e.target.value;var o,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),o=m.querySelectorAll(".dropdown-item"),o?o.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,u?u.addEventListener("blur",function(){if(window.innerWidth<770)return null;m?m.setAttribute("class","dropdown"):null}):null,u?u.addEventListener("click",function(e){if(window.innerWidth<770)return null;if(!e.target.value)return m?m.setAttribute("class","dropdown"):null,null;n=e.target.value;var s,t=O.search(e.target.value);U==="main"?y?X(n,t):ee(n,t):(y?Z(n,t):Q(n,t),s=m.querySelectorAll(".dropdown-item"),s?s.forEach(function(e){e.addEventListener("mousedown",function(e){e.target.click()})}):null)}):null,pe=document.getElementById("search-menu"),fe=document.querySelector("#search-menu .dropdown-item.is-active"),e=null,he=null,I=350,u?u.addEventListener("keydown",function(t){if(window.innerWidth<770)return null;t.key==="Escape"&&(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null);var n=document.querySelectorAll("#search-menu .dropdown-item"),o=t.which||t.keyCode;if(!n||!n.length)return null;if(t.key==="ArrowDown"||o===40){e===null?(e=0,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===n.length-1?0:e+1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t>0?document.querySelector(".search-content").scrollTop+=n[e].getBoundingClientRect().height:e===0&&(document.querySelector(".search-content").scrollTop=0)}else if(t.key==="ArrowUp"||o===38){e===null?(e=n.length-1,n[e].classList.remove("is-active")):(n[e].classList.remove("is-active"),e=e===0?n.length-1:e-1),n[e].classList.add("is-active");let t=n[e].offsetTop+n[e].clientHeight-I;t<0?document.querySelector(".search-content").scrollTop-=n[e].getBoundingClientRect().height:document.querySelector(".search-content").scrollTop=t+n[e].getBoundingClientRect().height}else t.key==="Enter"||o===13?n[e]&&n[e].getAttribute("href")&&(location.href=n[e].getAttribute("href")):(t.key==="Escape"||o===27)&&(t.target.value=null,l&&l.classList.remove("is-active"))}):null,H?H.addEventListener("input",function(e){if(!e.target.value){let e=document.getElementById("search-mobile-results");for(;e.firstChild;)e.removeChild(e.firstChild);return null}n=e.target.value;var t=O.search(e.target.value);J(n,t),y?ve(n,t):J(n,t)}):null,f=document.querySelector("#search-mobile"),R=document.querySelector(".mobile-search"),$=document.querySelectorAll(".navbar-search"),W=document.querySelector("#search-mobile-close"),w=document.querySelector("#search-mobile-container"),h=document.querySelector("#search-mobile-results"),_=document.querySelector("html"),R&&(R.style.display="none"),$?$.forEach(function(e){e.addEventListener("click",function(){w&&(w.style.display="block"),f&&f.focus(),_&&(_.style.overflowY="hidden")})}):null,W?W.addEventListener("click",function(){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}):null,f?f.addEventListener("keydown",function(e){var t=e.which||e.keyCode;if(e.key==="Escape"||t===27){if(w&&(w.style.display="none"),f&&(f.value=""),h)for(;h.firstChild;)h.removeChild(h.firstChild);_&&(_.style.overflowY="visible")}}):null;function ee(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){me(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}function X(e,t){var a=document.querySelector(".search-result__body"),n=a.querySelector("ul"),o=document.createElement("ul");e?t&&t&&t.length&&(t.forEach(function(e){be(o,e)}),i?i.setAttribute("data-display","block"):null,s?s.setAttribute("data-display","none"):null):(i?i.setAttribute("data-display","none"):null,s?s.setAttribute("data-display","block"):null),n.parentNode.replaceChild(o,n)}})</script><link rel=stylesheet href=/css/main.min.css><meta name=description content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=keywords content="翻译,Kubernetes,网络"><meta name=created content="2022-09-17T00:00:00+0000"><meta name=modified content="2022-09-17T00:00:00+0000"><meta property="article:published_time" content="2022-09-17T00:00:00+0000"><meta name=author content="微信公众号"><meta property="og:site_name" content="陈少文的网站"><meta property="og:title" content="Kubernetes 网络流量转发详解"><meta property="og:url" content="https://www.chenshaowen.com/blog/kubernetes-network-packets.html"><meta property="og:type" content="article"><meta property="og:description" content="关注 AI、云原生相关技术，同时也对团队文化、经营策略感兴趣。"><meta name=generator content="Hugo 0.110.0"><meta name=msapplication-TileColor content="#fff"><meta name=theme-color content="#fff"><meta name=msapplication-navbutton-color content="#fff"><meta name=apple-mobile-web-app-status-bar-style content="#fff"><link rel=canonical href=https://www.chenshaowen.com/blog/kubernetes-network-packets.html><link rel=manifest href=/manifest.json><link rel=apple-touch-icon sizes=57x57 href=/favicon/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/favicon/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/favicon/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/favicon/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/favicon/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/favicon/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/favicon/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/favicon/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/favicon/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-192x192.png><link rel=icon type=image/png sizes=192x192 href=/favicon/android-icon-512x512.png><link rel=icon type=image/png sizes=32x32 href=/favicon/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon/favicon-16x16.png><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Kubernetes 网络流量转发详解","datePublished":"2022-09-17T00:00:00Z","dateModified":"2022-09-17T00:00:00Z","url":"https://www.chenshaowen.com/blog/kubernetes-network-packets.html","description":"本文翻译自 https://learnk8s.io/kubernetes-network-packets，并没有逐字翻译，带入了些自己的理解。 阅读本文，你可以了解在 Kubernetes 内外，数据包是如何转发的，从原始的 Web 请求开始，到托管应用程序的容器。 Kubernetes 网络要","keywords":["翻译","Kubernetes","网络"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.chenshaowen.com"},"publisher":{"@type":"Organization","name":"陈少文的网站","url":"https://www.chenshaowen.com"}}</script><noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MTW4XNQ" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript><script>var dataLayer=window.dataLayer=window.dataLayer||[];dataLayer.push({page:"Kubernetes 网络流量转发详解",categories:"only examples about your dataLayer"})</script><script>(function(e,t,n,s,o){e[s]=e[s]||[],e[s].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var a=t.getElementsByTagName(n)[0],i=t.createElement(n),r=s!="dataLayer"?"&l="+s:"";i.async=!0,i.src="https://www.googletagmanager.com/gtm.js?id="+o+r,a.parentNode.insertBefore(i,a)})(window,document,"script","dataLayer","GTM-MTW4XNQ")</script></head><body id=root class=theme__light><script>var localTheme=localStorage.getItem("theme");localTheme&&(document.getElementById("root").className="theme__"+localTheme)</script><div id=container><div class=wrapper data-type=post data-kind=page><nav class="navbar scrolling" role=navigation aria-label="main navigation" data-dir=ltr><div class=navbar__brand><a href=/ title=主页 rel=home class=navbar__logo-link><img src=/logo.png alt=Home class=navbar__logo></a>
<a href=/ title=主页 rel=home class=navbar__title-link><h6 class=navbar__title>陈少文的网站</h6></a></div><div class="theme theme-mobile" data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><div class="mobile-search__btn navbar-search" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></div><div id=search-mobile-container class="mobile-search hide" data-dir=ltr><div class=mobile-search__top><input id=search-mobile type=text aria-label="Mobile Search" placeholder=搜索 class=mobile-search__top--input><div id=search-mobile-close class=mobile-search__top--icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path opacity=".87" fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41.0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"/></svg></div></div><div id=search-mobile-results class=mobile-search__body></div></div><a role=button class=navbar__burger aria-label=menu aria-expanded=false data-ani=true><span aria-hidden=true></span>
<span aria-hidden=true></span>
<span aria-hidden=true></span></a><div class=navbarm__collapse data-open=false><ul dir=ltr><li class=navbarm__menu--item><a href=https://github.com/shaowenchen/ops/>Ops 项目</a></li><li class=navbarm__menu--item><a href=/tags>标签</a></li><li class=navbarm__menu--item><a href=/presentation>演示文档</a></li><li class=navbarm__menu--item><a href=/>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/kubernetes-101/>Kubernetes 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/devops-101/>DevOps 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/microservices-101/>MicroServices 101</a></li><li class="navbarm__menu--item navbarm__menu--subitem"><a href=/aigc/>AIGC</a></li><li class=navbarm__menu--item><a href=/about.html>关于</a></li><li class=navbarm__menu--item><a href=/atom.xml>订阅</a></li></ul></div><div class=navbar__menu><div class=theme data-ani=true><div class=dropdown><button class="dropdown-trigger navbar__slide-down" aria-label="Select Theme Button" data-ani=true><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24"><path fill="none" d="M24 0H0v24h24V0z"/><path fill="currentcolor" d="M6.34 7.93c-3.12 3.12-3.12 8.19.0 11.31C7.9 20.8 9.95 21.58 12 21.58s4.1-.78 5.66-2.34c3.12-3.12 3.12-8.19.0-11.31l-4.95-4.95c-.39-.39-1.02-.39-1.41.0L6.34 7.93zM12 19.59c-1.6.0-3.11-.62-4.24-1.76C6.62 16.69 6 15.19 6 13.59s.62-3.11 1.76-4.24L12 5.1v14.49z"/></svg></button><div class="dropdown-content select-theme"><a href=# class="dropdown-item select-theme__item is-active">light</a>
<a href=# class="dropdown-item select-theme__item">dark</a></div></div></div><a href=https://github.com/shaowenchen/ops/ class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>Ops 项目</a>
<a href=/tags class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>标签</a>
<a href=/presentation class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>演示文档</a><div class="navbar__dropdown navbar__slide-down" data-ani=true><a href=/ class=navbar__menu-item dir=ltr>电子书<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41.0s.39 1.02.0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41.0L6.7 10.7c-.39-.39-.39-1.02.0-1.41.39-.38 1.03-.39 1.42.0z"/></svg></a><div class=navbar__dropdown--content><a href=/kubernetes-101/ class=navbar__dropdown--item dir=ltr>Kubernetes 101</a>
<a href=/devops-101/ class=navbar__dropdown--item dir=ltr>DevOps 101</a>
<a href=/microservices-101/ class=navbar__dropdown--item dir=ltr>MicroServices 101</a>
<a href=/aigc/ class=navbar__dropdown--item dir=ltr>AIGC</a></div></div><a href=/about.html class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>关于</a>
<a href=/atom.xml class="navbar__menu-item navbar__slide-down" dir=ltr data-ani=true>订阅</a></div></nav><main class="single__main main-main"><nav class="breadcrumb hide" aria-label=breadcrumbs><script>document.querySelector(".breadcrumb").classList.remove("hide")</script><ol><li><a href=https://www.chenshaowen.com/ class=capitalize>陈少文的网站</a></li><li><a href=https://www.chenshaowen.com/post/ class=capitalize>Posts</a></li><li class=is-active><span>Kubernetes 网络流量转发详解</span></li></ol></nav><div class=single><div class=single__nojs>Please enable Javascript to view the contents</div><script>document.querySelector(".single").classList.remove("hide"),document.querySelector(".single__nojs").classList.add("hide")</script><h2 class=single__title data-ani=true>Kubernetes 网络流量转发详解</h2><h3 class=single__subtitle></h3><div class=single__meta><div class=single__infos><time class=single__info title=创建日期>📅&nbsp;2022年09月17日</time>
&nbsp;&#183;&nbsp; <span class=single__info title=阅读时长>☕&nbsp;16&nbsp;分钟</span>
<span class=single__info></span></div><ul class="single__tags caption">🏷️<li><a href=https://www.chenshaowen.com/tags/%E7%BF%BB%E8%AF%91/ class=single__tag title=翻译>#翻译</a></li><li><a href=https://www.chenshaowen.com/tags/kubernetes/ class=single__tag title=Kubernetes>#Kubernetes</a></li><li><a href=https://www.chenshaowen.com/tags/%E7%BD%91%E7%BB%9C/ class=single__tag title=网络>#网络</a></li></ul></div><article class=single__contents data-dir=ltr data-ani=true><blockquote><p>本文翻译自 <a href=https://learnk8s.io/kubernetes-network-packets>https://learnk8s.io/kubernetes-network-packets</a>，并没有逐字翻译，带入了些自己的理解。</p></blockquote><p><img src=/blog/images/2022/09/k8s-network-1.svg alt></p><p>阅读本文，你可以了解在 Kubernetes 内外，数据包是如何转发的，从原始的 Web 请求开始，到托管应用程序的容器。</p><h2 id=kubernetes-网络要求>Kubernetes 网络要求</h2><p>在深入了解在 Kubernetes 集群中数据包如何流转的细节之前，先明确一下 Kubernetes 对网络的要求。</p><p>Kubernetes 网络模型定义了一组基本规则：</p><ul><li>在不使用网络地址转换 (NAT) 的情况下，集群中的 Pod 能够与任意其他 Pod 进行通信。</li><li>在不使用网络地址转换 (NAT) 的情况下，在集群节点上运行的程序能与同一节点上的任何 Pod 进行通信。</li><li>每个 Pod 都有自己的 IP 地址（IP-per-Pod），并且任意其他 Pod 都可以通过相同的这个地址访问它。</li></ul><p>这些要求，不会将具体实现限制在某种解决方案上。</p><p>相反，它们笼统地描述了集群网络的特性。</p><p>为了满足这些限制，你必须解决以下挑战:</p><ol><li>如何确保同一个 Pod 中的容器行为就像它们在同一个主机上一样？</li><li>集群中的 Pod 能否访问其他 Pod？</li><li>Pod 可以访问服务吗？服务是负载均衡的吗？</li><li>Pod 可以接收集群外部的流量吗？</li></ol><p>在本文中，将重点关注前三点，从 Pod 内的网络，容器到容器的通信说起。</p><h2 id=linux-网络命名空间如何在-pod-中工作>Linux 网络命名空间如何在 Pod 中工作</h2><p>让我们来看一个运行应用的主容器和伴随一起的另一个容器。</p><p>在示例中，有一个带有 nginx 和 busybox 容器的 Pod:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>multi-container-Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>container-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;/bin/sh&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-c&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;sleep 1d&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>container-2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>部署时，会发生以下事情：</p><ol><li>Pod 在节点上拥有独立的网络命名空间。</li><li>分配一个 IP 地址给 Pod ，两个容器之间共享端口。</li><li>两个容器共享相同的网络命名空间，并在本地彼此可见。</li></ol><p>网络配置在后台迅速完成。</p><p>但是，让我们退后一步，尝试理解为什么运行容器需要上述动作。</p><p><a href=https://iximiuz.com/en/posts/container-networking-is-simple/>在 Linux 中，网络命名空间是独立的、隔离的逻辑空间。</a></p><p>你可以将网络命名空间视为，将物理网络接口分割小块之后的独立部分。</p><p>每个部分都可以单独配置，并拥有自己的网络规则和资源。</p><p>这些包括防火墙规则、接口（虚拟的或物理的）、路由以及与网络相关的所有内容。</p><ol><li>物理网络接口持有根网络命名空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-2.svg alt></p><ol start=2><li>你可以使用 Linux 网络命名空间来创建独立的网络。每个网络都是独立的，除非你进行配置，默认不会与其他网络互通。</li></ol><p><img src=/blog/images/2022/09/k8s-network-3.svg alt></p><p>但最终，还是需要物理接口处理所有真实的数据包，所有虚拟接口都是基于物理接口创建的。</p><p>网络命名空间可以通过 <a href=https://man7.org/linux/man-pages/man8/ip-netns.8.html>ip-netns</a> 进行管理，使用 <code>ip netns list</code> 可以列出主机上的命名空间。</p><blockquote><p>需要注意的是，创建的网络命名空间会出现在 <code>/var/run/netns</code> 下面，但 Docker 并没有遵循这一规则。</p></blockquote><p>例如，这是 Kubernetes 节点的一些命名空间：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns list
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cni-0f226515-e28b-df13-9f16-dd79456825ac <span class=o>(</span>id: 3<span class=o>)</span>
</span></span><span class=line><span class=cl>cni-4e4dfaac-89a6-2034-6098-dd8b2ee51dcd <span class=o>(</span>id: 4<span class=o>)</span>
</span></span><span class=line><span class=cl>cni-7e94f0cc-9ee8-6a46-178a-55c73ce58f2e <span class=o>(</span>id: 2<span class=o>)</span>
</span></span><span class=line><span class=cl>cni-7619c818-5b66-5d45-91c1-1c516f559291 <span class=o>(</span>id: 1<span class=o>)</span>
</span></span><span class=line><span class=cl>cni-3004ec2c-9ac2-2928-b556-82c7fb37a4d8 <span class=o>(</span>id: 0<span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><blockquote><p>注意 cni- 前缀；这意味着命名空间是由 CNI 插件创建的。</p></blockquote><p>当你创建一个 Pod，Pod 被分配给一个节点后，CNI 将：</p><ol><li>分配 IP 地址。</li><li>将容器连接到网络。</li></ol><p>如果 Pod 包含多个容器，那么这些容器都将被放在同一个命名空间中。</p><ol><li>当创建 Pod 时，容器运行时会给容器创建一个网络命名空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-4.svg alt></p><ol start=2><li>然后 CNI 负责给 Pod 分配一个 IP 地址。</li></ol><p><img src=/blog/images/2022/09/k8s-network-5.svg alt></p><ol start=3><li>最后 CNI 将容器连接到网络的其余部分。</li></ol><p><img src=/blog/images/2022/09/k8s-network-6.svg alt></p><p>那么，当你列出节点上的容器的命名空间会发生什么呢？</p><p>你可以通过 SSH 连接到 Kubernetes 节点并查看命名空间：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lsns -t net
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        NS TYPE NPROCS   PID USER     NETNSID NSFS                           COMMAND
</span></span><span class=line><span class=cl><span class=m>4026531992</span> net     <span class=m>171</span>     <span class=m>1</span> root  unassigned /run/docker/netns/default      /sbin/init noembed norestore
</span></span><span class=line><span class=cl><span class=m>4026532286</span> net       <span class=m>2</span>  <span class=m>4808</span> <span class=m>65535</span>          <span class=m>0</span> /run/docker/netns/56c020051c3b /pause
</span></span><span class=line><span class=cl><span class=m>4026532414</span> net       <span class=m>5</span>  <span class=m>5489</span> <span class=m>65535</span>          <span class=m>1</span> /run/docker/netns/7db647b9b187 /pause
</span></span></code></pre></td></tr></table></div></div><p><code>lsns</code> 是一个用于列出主机上所有可用命名空间的命令。</p><blockquote><p>请记住，Linux 中有<a href=https://man7.org/linux/man-pages/man7/namespaces.7.html>多种命名空间类型</a>。</p></blockquote><p>Nginx 容器在哪里？</p><p>那些 pause 容器是什么？</p><h2 id=在-pod-中pause-容器创建了网络命名空间>在 Pod 中，pause 容器创建了网络命名空间</h2><p>先列出节点上的所有命名空间，看看能否找到 Nginx 容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>lsns
</span></span><span class=line><span class=cl>        NS TYPE   NPROCS   PID USER            COMMAND
</span></span><span class=line><span class=cl><span class=c1># truncated output</span>
</span></span><span class=line><span class=cl><span class=m>4026532414</span> net         <span class=m>5</span>  <span class=m>5489</span> <span class=m>65535</span>           /pause
</span></span><span class=line><span class=cl><span class=m>4026532513</span> mnt         <span class=m>1</span>  <span class=m>5599</span> root            sleep 1d
</span></span><span class=line><span class=cl><span class=m>4026532514</span> uts         <span class=m>1</span>  <span class=m>5599</span> root            sleep 1d
</span></span><span class=line><span class=cl><span class=m>4026532515</span> pid         <span class=m>1</span>  <span class=m>5599</span> root            sleep 1d
</span></span><span class=line><span class=cl><span class=m>4026532516</span> mnt         <span class=m>3</span>  <span class=m>5777</span> root            nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=m>4026532517</span> uts         <span class=m>3</span>  <span class=m>5777</span> root            nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=m>4026532518</span> pid         <span class=m>3</span>  <span class=m>5777</span> root            nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>Nginx 容器在挂载 (<code>mnt</code>)、Unix time-sharing (<code>uts</code>) 和 PID (<code>pid</code>) 命名空间中，但不在网络命名空间 (<code>net</code>) 中。</p><p>不幸的是，<code>lsns</code> 只显示每个进程最小的 PID，但你可以根据这个进程 ID 进一步过滤。</p><p>使用以下命令，在所有命名空间中检索 Nginx 容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo lsns -p <span class=m>5777</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       NS TYPE   NPROCS   PID USER  COMMAND
</span></span><span class=line><span class=cl><span class=m>4026531835</span> cgroup    <span class=m>178</span>     <span class=m>1</span> root  /sbin/init noembed norestore
</span></span><span class=line><span class=cl><span class=m>4026531837</span> user      <span class=m>178</span>     <span class=m>1</span> root  /sbin/init noembed norestore
</span></span><span class=line><span class=cl><span class=m>4026532411</span> ipc         <span class=m>5</span>  <span class=m>5489</span> <span class=m>65535</span> /pause
</span></span><span class=line><span class=cl><span class=m>4026532414</span> net         <span class=m>5</span>  <span class=m>5489</span> <span class=m>65535</span> /pause
</span></span><span class=line><span class=cl><span class=m>4026532516</span> mnt         <span class=m>3</span>  <span class=m>5777</span> root  nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=m>4026532517</span> uts         <span class=m>3</span>  <span class=m>5777</span> root  nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span><span class=line><span class=cl><span class=m>4026532518</span> pid         <span class=m>3</span>  <span class=m>5777</span> root  nginx: master process nginx -g daemon off<span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>pause</code> 进程再次出现，它劫持了网络命名空间。</p><p>这是怎么回事？</p><p><em><strong>集群中的每个 Pod 都有一个额外的隐藏容器在后台运行，称为 pause 容器。</strong></em></p><p>列出在节点上运行的容器并获取 pause 容器：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker ps <span class=p>|</span> grep pause
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>fa9666c1d9c6   k8s.gcr.io/pause:3.4.1  <span class=s2>&#34;/pause&#34;</span>  k8s_POD_kube-dns-599484b884-sv2js…
</span></span><span class=line><span class=cl>44218e010aeb   k8s.gcr.io/pause:3.4.1  <span class=s2>&#34;/pause&#34;</span>  k8s_POD_blackbox-exporter-55c457d…
</span></span><span class=line><span class=cl>5fb4b5942c66   k8s.gcr.io/pause:3.4.1  <span class=s2>&#34;/pause&#34;</span>  k8s_POD_kube-dns-599484b884-cq99x…
</span></span><span class=line><span class=cl>8007db79dcf2   k8s.gcr.io/pause:3.4.1  <span class=s2>&#34;/pause&#34;</span>  k8s_POD_konnectivity-agent-84f87c…
</span></span></code></pre></td></tr></table></div></div><p>可以看到，节点上的每一个 Pod 都会有一个对应的 pause 容器。</p><p>这个 <code>pause</code> 容器负责创建和维持网络命名空间。</p><p><a href=https://www.aquasec.com/cloud-native-academy/container-security/container-runtime/>底层容器运行时</a>会完成网络命名空间的创建，通常是由 <code>containerd</code> 或 <code>CRI-O</code> 完成。</p><p>在部署 Pod 和创建容器之前，由运行时创建网络命名空间。</p><p>容器运行时会自动完成这些，不需要手工执行 <code>ip netns</code> 创建命名空间。</p><p>话题回到 pause 容器。</p><p>它包含非常少的代码，并且在部署后立即进入睡眠状态。</p><p>但是，<a href=https://www.ianlewis.org/en/almighty-pause-container>它是必不可少的，并且在 Kubernetes 生态系统中起着至关重要的作用</a>。</p><ol><li>创建 Pod 时，容器运行时会创建一个带有睡眠容器的网络命名空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-7.svg alt></p><ol start=2><li>Pod 中的其他容器都会加入由 pause 容器创建的网络名称空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-8.svg alt></p><ol start=3><li>此时，CNI 分配 IP 地址并将容器连接到网络。</li></ol><p><img src=/blog/images/2022/09/k8s-network-9.svg alt></p><p>一个进入睡眠状态的容器有什么用？</p><p>为了理解它的用途，让我们想象一个 Pod 有两个容器，就像前面的例子一样，但没有 pause 容器。</p><p>一旦容器启动，CNI 将会：</p><ol><li>使 busybox 容器加入之前的网络命名空间。</li><li>分配 IP 地址。</li><li>将容器连接到网络。</li></ol><p>如果 Nginx 崩溃了怎么办？</p><p>CNI 将不得不再次执行所有步骤，并且两个容器的网络都将中断。</p><p>由于睡眠容器不太可能有任何错误，因此创建网络命名空间通常是一种更安全、更健壮的选择。</p><p><code>如果 Pod 中的一个容器崩溃了，剩下的仍然可以回复其他网络请求。</code></p><h2 id=分配一个-ip-地址给-pod>分配一个 IP 地址给 Pod</h2><p>前面我提到 Pod 和两个容器将具有同一个 IP 地址。</p><p>那是怎样配置的呢？</p><p><code>在 Pod 网络命名空间内，创建了一个接口，并分配了一个 IP 地址。</code></p><p>让我们验证一下。</p><p>首先，找到 Pod 的 IP 地址：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl get Pod multi-container-Pod -o <span class=nv>jsonpath</span><span class=o>={</span>.status.PodIP<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>10.244.4.40
</span></span></code></pre></td></tr></table></div></div><p>接下来，找到相关的网络命名空间。</p><p>由于网络命名空间是从物理接口创建的，需要先访问集群节点。</p><blockquote><p>如果你运行的是 minikube，使用 <code>minikube ssh</code> 访问节点。如果在云厂中运行，那么应该有某种方法可以通过 SSH 访问节点。</p></blockquote><p>进入后，找到最新创建的命名网络命名空间：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ls -lt /var/run/netns
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>total <span class=m>0</span>
</span></span><span class=line><span class=cl>-r--r--r-- <span class=m>1</span> root root <span class=m>0</span> Sep <span class=m>25</span> 13:34 cni-0f226515-e28b-df13-9f16-dd79456825ac
</span></span><span class=line><span class=cl>-r--r--r-- <span class=m>1</span> root root <span class=m>0</span> Sep <span class=m>24</span> 09:39 cni-4e4dfaac-89a6-2034-6098-dd8b2ee51dcd
</span></span><span class=line><span class=cl>-r--r--r-- <span class=m>1</span> root root <span class=m>0</span> Sep <span class=m>24</span> 09:39 cni-7e94f0cc-9ee8-6a46-178a-55c73ce58f2e
</span></span><span class=line><span class=cl>-r--r--r-- <span class=m>1</span> root root <span class=m>0</span> Sep <span class=m>24</span> 09:39 cni-7619c818-5b66-5d45-91c1-1c516f559291
</span></span><span class=line><span class=cl>-r--r--r-- <span class=m>1</span> root root <span class=m>0</span> Sep <span class=m>24</span> 09:39 cni-3004ec2c-9ac2-2928-b556-82c7fb37a4d8
</span></span></code></pre></td></tr></table></div></div><p>在示例中，就是 <code>cni-0f226515-e28b-df13-9f16-dd79456825ac</code>。然后，可以在该命名空间内运行 <code>exec</code> 命令：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac ip a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># output truncated</span>
</span></span><span class=line><span class=cl>3: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1450</span> qdisc noqueue state UP group default
</span></span><span class=line><span class=cl>    link/ether 16:a4:f8:4f:56:77 brd ff:ff:ff:ff:ff:ff link-netnsid <span class=m>0</span>
</span></span><span class=line><span class=cl>    inet 10.244.4.40/32 brd 10.244.4.40 scope global eth0
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span><span class=line><span class=cl>    inet6 fe80::14a4:f8ff:fe4f:5677/64 scope link
</span></span><span class=line><span class=cl>       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table></div></div><p>这个 IP 就是 Pod 的 IP 地址！通过查找 @if12 中的 12 找到网络接口</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link <span class=p>|</span> grep -A1 ^12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>12: vethweplb3f36a0@if16: mtu <span class=m>1376</span> qdisc noqueue master weave state UP mode DEFAULT group default
</span></span><span class=line><span class=cl>    link/ether 72:1c:73:d9:d9:f6 brd ff:ff:ff:ff:ff:ff link-netnsid <span class=m>1</span>
</span></span></code></pre></td></tr></table></div></div><p>你还可以验证 Nginx 容器是否监听了来自该命名空间内的 HTTP 流量：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac netstat -lnp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Active Internet connections <span class=o>(</span>only servers<span class=o>)</span>
</span></span><span class=line><span class=cl>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
</span></span><span class=line><span class=cl>tcp        <span class=m>0</span>      <span class=m>0</span> 0.0.0.0:80              0.0.0.0:*               LISTEN      692698/nginx: master
</span></span><span class=line><span class=cl>tcp6       <span class=m>0</span>      <span class=m>0</span> :::80                   :::*                    LISTEN      692698/nginx: master
</span></span></code></pre></td></tr></table></div></div><blockquote><p>如果你无法通过 SSH 访问集群中的工作节点，你可以使用 <code>kubectl exec</code> 获取到 busybox 容器的 shell 并直接在内部使用 <code>ip</code> 和 <code>netstat</code> 命令。</p></blockquote><p>刚刚我们介绍了容器之间的通信，再来看看如何建立 Pod 到 Pod 的通信吧。</p><h2 id=查看集群中-pod-到-pod-的流量>查看集群中 Pod 到 Pod 的流量</h2><p>Pod 到 Pod 的通信有两种可能的情况：</p><ol><li>Pod 流量的目的地是同一节点上的 Pod。</li><li>Pod 流量的目的地是在不同节点上的 Pod。</li></ol><p>整个工作流依赖于虚拟接口对和网桥，下面先来了解一下这部分的内容。</p><p><code>为了让一个 Pod 与其他 Pod 通信，它必须先访问节点的根命名空间。</code></p><p>通过虚拟以太网对来实现 Pod 和根命名空间的连接。</p><p>这些虚拟接口设备（veth 中的 v）连接并充当两个命名空间之间的隧道。</p><p>使用此 <code>veth</code> 设备，你将一端连接到 Pod 的命名空间，另一端连接到根命名空间。</p><p><img src=/blog/images/2022/09/k8s-network-10.svg alt></p><p>CNI 可以帮你执行这些操作，但你也可以手动执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link add veth1 netns Pod-namespace <span class=nb>type</span> veth peer veth2 netns root
</span></span></code></pre></td></tr></table></div></div><p>现在 Pod 的命名空间有一个可以访问根命名空间的 <code>隧道</code>。</p><p>节点上，新建的每一个 Pod 都会设置这样的 <code>veth</code> 对。</p><p>一个是，创建接口对；另一个是为以太网设备分配地址并配置默认路由。</p><p>下面看看如何在 Pod 的命名空间中设置 <code>veth1</code> 接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac ip addr add 10.244.4.40/24 dev veth1
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac ip link <span class=nb>set</span> veth1 up
</span></span><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac ip route add default via 10.244.4.40
</span></span></code></pre></td></tr></table></div></div><p>在节点上，让我们创建另一个 <code>veth2</code> 对：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip addr add 169.254.132.141/16 dev veth2
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> veth2 up
</span></span></code></pre></td></tr></table></div></div><p>可以像前面一样检查现有的 <code>veth</code> 对。</p><p>在 Pod 的命名空间中，检索 <code>eth0</code> 接口的后缀。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip netns <span class=nb>exec</span> cni-0f226515-e28b-df13-9f16-dd79456825ac ip link show <span class=nb>type</span> veth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1450</span> qdisc noqueue state UP mode DEFAULT group default
</span></span><span class=line><span class=cl>    link/ether 16:a4:f8:4f:56:77 brd ff:ff:ff:ff:ff:ff link-netnsid <span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><p>在这种情况下，可以使用命令 <code>grep -A1 ^12</code> 查找（或滚动到目标所在处）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>ip link show <span class=nb>type</span> veth
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># output truncated</span>
</span></span><span class=line><span class=cl>12: cali97e50e215bd@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class=m>1450</span> qdisc noqueue state UP mode DEFAULT group default
</span></span><span class=line><span class=cl>    link/ether ee:ee:ee:ee:ee:ee brd ff:ff:ff:ff:ff:ff link-netns cni-0f226515-e28b-df13-9f16-dd79456825ac
</span></span></code></pre></td></tr></table></div></div><blockquote><p>也可以使用 <code>ip -n cni-0f226515-e28b-df13-9f16-dd79456825ac link show type veth</code>.命令</p></blockquote><p>注意 <code>3: eth0@if12和12: cali97e50e215bd@if3</code> 接口上的符号。</p><p>从 Pod 命名空间，该 <code>eth0</code> 接口连接到根命名空间的 12 号接口，因此是 <code>@if12</code>.</p><p>在 <code>veth</code> 对的另一端，根命名空间连接到 Pod 命名空间的 3 号接口。</p><p>接下来是连接 <code>veth</code> 对两端的桥接器。</p><h2 id=pod-网络命名空间连接到以太网桥>Pod 网络命名空间连接到以太网桥</h2><p>网桥会汇聚位于根命名空间中的每一个虚拟接口。这个网桥允许虚拟 pair 之间的流量，也允许穿过公共根命名空间的流量。</p><p>补充一下相关原理。</p><p>以太网桥位于 <a href=https://en.wikipedia.org/wiki/OSI_model>OSI 网络模型</a> 的第 2 层。</p><p>你可以将网桥视为接受来自不同命名空间和接口的连接的虚拟交换机。</p><p><a href=https://ops.tips/blog/using-network-namespaces-and-bridge-to-isolate-servers/>以太网桥可以连接节点上的多个可用网络。</a></p><p>因此，可以使用网桥连接两个接口，即 Pod 命名空间的 <code>veth</code> 连接到同一节点上另一个 Pod 的 <code>veth</code>。</p><p><img src=/blog/images/2022/09/k8s-network-11.svg alt></p><p>接下来，继续看网桥和 veth 对的用途。</p><h2 id=跟踪在同一节点上-pod-到-pod-的流量>跟踪在同一节点上 Pod 到 Pod 的流量</h2><p>假设同一个节点上有两个 Pod，Pod-A 向 Pod-B 发送消息。</p><ol><li>由于访问目标不在同一个命名空间，Pod-A 将数据包发送到其默认接口 eth0。 这个接口与 veth 对的一端绑定，作为隧道。这样，数据包会被转发到节点上的根命名空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-12.svg alt></p><ol start=2><li>以太网网桥作为一个虚拟交换机，需要目标 Pod-B 的 MAC 地址才能工作。</li></ol><p><img src=/blog/images/2022/09/k8s-network-13.svg alt></p><ol start=3><li>ARP 协议会解决这个问题。当帧到达网桥时，会向所有连接的设备发送 ARP 广播。网桥广播询问持有 Pod-B 的 IP 地址</li></ol><p><img src=/blog/images/2022/09/k8s-network-14.svg alt></p><ol start=4><li>此时会收到一个带有 Pod-B IP 的 MAC 地址应答，这条消息会被存储在桥接 ARP 缓存(查找表)中。</li></ol><p><img src=/blog/images/2022/09/k8s-network-15.svg alt></p><ol start=5><li>IP 地址和 MAC 地址的映射关系存储之后，网桥就在表中查找，并将数据包转发到正确的端点。数据包到达根命名空间内 Pod-B 的 veth 之后，很快又到达 Pod-B 命名空间内的 eth0 接口。</li></ol><p><img src=/blog/images/2022/09/k8s-network-16.svg alt></p><p>至此，Pod-A 和 Pod-B 之间的通信就成功了。</p><h2 id=跟踪不同节点上的-pod-到-pod-通信>跟踪不同节点上的 Pod 到 Pod 通信</h2><p>对于跨节点 Pod 之间的通信，会经过额外的通信跳跃。</p><ol><li>前几个步骤保持不变，直到数据包到达根命名空间并需要发送到 Pod-B。</li></ol><p><img src=/blog/images/2022/09/k8s-network-17.svg alt></p><ol start=2><li>当目的 IP 不在本地网络中时，报文被转发到节点的默认网关。节点的出口网关或默认网关，通常位于节点与网络相连的物理接口 eth0 上。</li></ol><p><img src=/blog/images/2022/09/k8s-network-18.svg alt></p><p>此时 不会发生 ARP 解析，因为源 IP 和目标 IP 不在同一个网段中。</p><p>网段的检查是使用按位运算完成的。</p><p>当目的 IP 不在当前网络段时，数据包被转发到节点的默认网关。</p><h2 id=按位运算的工作原理>按位运算的工作原理</h2><p>在确定数据包的转发位置时，源节点必须执行位运算</p><p><a href=https://en.wikipedia.org/wiki/Bitwise_operation#AND>这也称为与操作。</a></p><p>复习一下，按位与运算的规则：</p><pre tabindex=0><code>0 AND 0 = 0
0 AND 1 = 0
1 AND 0 = 0
1 AND 1 = 1
</code></pre><p>除了 1 与 1 以外的都是 false。</p><p>如果源节点的 IP 为 192.168.1.1，子网掩码为 /24，目标 IP 为 172.16.1.1/16，则按位与运算将得知它们位于不同的网段上。</p><p>这意味着目标 IP 与数据包的源不在同一个网络上，数据包将通过默认网关转发。</p><p>数学时间。</p><p>我们必须从二进制的 32 位地址开始进行 AND 操作。</p><p>先找出源 IP 网络和目标 IP 网段。</p><table><thead><tr><th>Type</th><th>Binary</th><th>Converted</th></tr></thead><tbody><tr><td>Src. IP Address</td><td>11000000.10101000.00000001.00000001</td><td>192.168.1.1</td></tr><tr><td>Src. Subnet Mask</td><td>11111111.11111111.11111111.00000000</td><td>255.255.255.0(/24)</td></tr><tr><td>Src. Network</td><td>11000000.10101000.00000001.00000000</td><td>192.168.1.0</td></tr><tr><td></td><td></td><td></td></tr><tr><td>Dst. IP Address</td><td>10101100.00010000.00000001.00000001</td><td>172.16.1.1</td></tr><tr><td>Dst. Subnet Mask</td><td>11111111.11111111.00000000.00000000</td><td>255.255.0.0(/16)</td></tr><tr><td>Dst. Network</td><td>10101100.00010000.00000000.00000000</td><td>172.16.0.0</td></tr></tbody></table><p>按位运算之后，需要将目标 IP 与数据包源节点的子网进行比较。</p><table><thead><tr><th>Type</th><th>Binary</th><th>Converted</th></tr></thead><tbody><tr><td>Dst. IP Address</td><td>10101100.00010000.00000001.00000001</td><td>172.16.1.1</td></tr><tr><td>Src. Subnet Mask</td><td>11111111.11111111.11111111.00000000</td><td>255.255.255.0(/24)</td></tr><tr><td>Network Result</td><td>10101100.00010000.00000001.00000000</td><td>172.16.1.0</td></tr></tbody></table><p>运算的结果是 172.16.1.0，不等于 192.168.1.0（源节点的网络）。说明源 IP 地址和目标 IP 地址不在同一个网络上。</p><p>如果目标 IP 是 192.168.1.2，即与发送 IP 在同一子网中，则 AND 操作将得到节点的本地网络。</p><table><thead><tr><th>Type</th><th>Binary</th><th>Converted</th></tr></thead><tbody><tr><td>Dst. IP Address</td><td>11000000.10101000.00000001.00000010</td><td>192.168.1.2</td></tr><tr><td>Src. Subnet Mask</td><td>11111111.11111111.11111111.00000000</td><td>255.255.255.0(/24)</td></tr><tr><td>Network</td><td>11000000.10101000.00000001.00000000</td><td>192.168.1.0</td></tr></tbody></table><p>进行逐位比较后，ARP 通过查找表查找默认网关的 MAC 地址。</p><p>如果有条目，将立即转发数据包。</p><p>否则，先进行广播以找到网关的 MAC 地址。</p><ol><li>现在，数据包路由到另一个节点的默认接口，我们称为 Node-B。</li></ol><p><img src=/blog/images/2022/09/k8s-network-19.svg alt></p><ol start=2><li>以相反的顺序。现在，数据包位于 Node-B 的根命名空间，并到达网桥，这里会进行 ARP 解析。</li></ol><p><img src=/blog/images/2022/09/k8s-network-20.svg alt></p><ol start=3><li>路由系统将返回与 Pod-B 相连的接口的 MAC 地址。</li></ol><p><img src=/blog/images/2022/09/k8s-network-21.svg alt></p><ol start=4><li>网桥通过 Pod-B 的 <code>veth</code> 设备转发帧，并到达 Pod-B 的命名空间。</li></ol><p><img src=/blog/images/2022/09/k8s-network-22.svg alt></p><p>至此，你应该已经熟悉了 Pod 之间的流量是如何流转的。下面，让我们花点时间来看看 CNI 如何管理上述内容。</p><h2 id=容器网络接口---cni>容器网络接口 - CNI</h2><p><a href=https://github.com/containernetworking/cni/blob/main/SPEC.md>容器网络接口（CNI）主要关注的是当前节点中的网络。</a></p><p><img src=/blog/images/2022/09/k8s-network-23.svg alt></p><p>可以将 CNI 看作为解决 Kubernetes 网络需求，而遵循的一组规则。</p><p>有这些 CNI 实现可供使用：</p><ul><li><a href=https://www.tigera.io/project-calico/>Calico</a></li><li><a href=https://cilium.io/>Cillium</a></li><li><a href=https://github.com/flannel-io/flannel>Flannel</a></li><li><a href=https://www.weave.works/docs/net/latest/overview/>Weave Net</a></li><li>其他网络插件</li></ul><p>他们都遵循相同的 CNI 标准。</p><p>如果没有 CNI，你需要人工完成如下操作：</p><ul><li>创建接口。</li><li>创建 veth 对。</li><li>设置网络命名空间。</li><li>设置静态路由。</li><li>配置以太网桥。</li><li>分配 IP 地址。</li><li>创建 NAT 规则。</li><li>还有其他大量事情。</li></ul><p>这还不包括，在删除或重启 Pod 时，需要进行类似的全部操作。</p><p>CNI 必须支持<a href=https://github.com/containernetworking/cni/blob/main/SPEC.md#cni-operations>四种不同的操作</a>：</p><ul><li>ADD - 向网络添加一个容器。</li><li>DEL - 从网络中删除一个容器。</li><li>CHECK - 如果容器的网络出现问题，则返回错误。</li><li>VERSION - 显示插件的版本。</li></ul><p>我们一起看下，CNI 是如何工作的。</p><p>当 Pod 被分配到特定节点时，Kubelet 自身不会初始化网络。</p><p>相反，Kubelet 将这个任务交给 CNI。</p><p><em>但是，Kubelet 以 JSON 格式指定配置并发送至 CNI 插件。</em></p><p>你可以进入节点上的 <code>/etc/cni/net.d</code> 文件夹，使用以下命令查看当前的 CNI 配置文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat 10-calico.conflist
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;name&#34;</span>: <span class=s2>&#34;k8s-Pod-network&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;cniVersion&#34;</span>: <span class=s2>&#34;0.3.1&#34;</span>,
</span></span><span class=line><span class=cl>  <span class=s2>&#34;plugins&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;calico&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;datastore_type&#34;</span>: <span class=s2>&#34;kubernetes&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;mtu&#34;</span>: 0,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;nodename_file_optional&#34;</span>: false,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;log_level&#34;</span>: <span class=s2>&#34;Info&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;log_file_path&#34;</span>: <span class=s2>&#34;/var/log/calico/cni/cni.log&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;ipam&#34;</span>: <span class=o>{</span> <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;calico-ipam&#34;</span>, <span class=s2>&#34;assign_ipv4&#34;</span> : <span class=s2>&#34;true&#34;</span>, <span class=s2>&#34;assign_ipv6&#34;</span> : <span class=s2>&#34;false&#34;</span><span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;container_settings&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;allow_ip_forwarding&#34;</span>: <span class=nb>false</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;policy&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;k8s&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;kubernetes&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>          <span class=s2>&#34;k8s_api_root&#34;</span>:<span class=s2>&#34;https://10.96.0.1:443&#34;</span>,
</span></span><span class=line><span class=cl>          <span class=s2>&#34;kubeconfig&#34;</span>: <span class=s2>&#34;/etc/cni/net.d/calico-kubeconfig&#34;</span>
</span></span><span class=line><span class=cl>      <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;bandwidth&#34;</span>,
</span></span><span class=line><span class=cl>      <span class=s2>&#34;capabilities&#34;</span>: <span class=o>{</span><span class=s2>&#34;bandwidth&#34;</span>: true<span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>,
</span></span><span class=line><span class=cl>    <span class=o>{</span><span class=s2>&#34;type&#34;</span>: <span class=s2>&#34;portmap&#34;</span>, <span class=s2>&#34;snat&#34;</span>: true, <span class=s2>&#34;capabilities&#34;</span>: <span class=o>{</span><span class=s2>&#34;portMappings&#34;</span>: true<span class=o>}}</span>
</span></span><span class=line><span class=cl>  <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>每个 CNI 插件都会使用不同类型的网络配置。</p><p>例如，Calico 使用基于 BGP 的三层网络连接 Pod</p><p>Cilium 从三层到七层使用的是基于 eBPF 的 overlay 网络</p><p>与 Calico 一样，Cilium 也支持通过配置网络策略来限制流量。</p><p>那么你应该使用哪一个呢？主要有两类 CNI。</p><p>在第一类中，使用基本网络设置（也称为平面网络），从集群的 IP 池为 Pod 分配 IP 地址的 CNI。</p><p>这种方式可能很快耗尽 IP 地址，而成为负担。</p><p>相反，另一类是使用 overlay 网络。</p><p>简单来说，overlay 网络是主（底层）网络之上的重建网络。</p><p>overlay 网络通过封装来自底层网络的数据包工作，这些数据包被发送到另一个节点上的 Pod。</p><p>overlay 网络的一种流行技术是 VXLAN，它可以在 L3 网络上建立 L2 域的隧道。</p><p>那么哪个更好呢？</p><p>没有单一的答案，这取决于你的需求。</p><p>你是否正在构建具有数万个节点的大型集群？</p><p>也许 overlay 网络更好。</p><p>你是否在意更简单的配置和审查网络流量，而不会愿意在复杂网络中丢失这种能力？</p><p>扁平网络更适合你。</p><p>现在我们讨论完了 CNI，接着让我们来看看 Pod 到服务的通信是如何连接的。</p><h2 id=检查-pod-到-service-的流量>检查 Pod 到 Service 的流量</h2><p>由于 Pod 在 Kubernetes 中是动态的，分配给 Pod 的 IP 地址不是静态的。</p><p>Pod 的 IP 是短暂的，每次创建或删除 Pod 时都会发生变化。</p><p>Kubernetes 中的 Service 解决了这个问题，为连接一组 Pod 提供了可靠的机制。</p><p><img src=/blog/images/2022/09/k8s-network-24.svg alt></p><p>默认情况下，在 Kubernetes 中创建 Service 时，<a href=https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies>被分配一个虚拟 IP</a>。</p><p>在 Service 中，可以使用选择器将 Service 与目标 Pod 相关联。</p><p>当删除或添加一个 Pod 时会发生什么呢？</p><p><code>Service 的虚拟 IP 保持静态不变。</code></p><p>但流量可以再无需干预的情况下，到达新创建的 Pod。</p><p>换句话说，Kubernetes 中的 Service 类似于负载均衡器。</p><p>但它们是如何工作的？</p><h2 id=使用-netfilter-和-iptables-拦截和重写流量>使用 Netfilter 和 Iptables 拦截和重写流量</h2><p>Kubernetes 中的 Service 是基于 Linux 内核中的两个组件构建的：</p><ol><li><a href=https://en.wikipedia.org/wiki/Netfilter>网络过滤器</a></li><li><a href=https://en.wikipedia.org/wiki/Iptables>iptables</a></li></ol><p><code>Netfilter 是一个可以配置数据包过滤、创建 NAT 、端口转发规则以及管理网络中流量的框架</code></p><p>此外，它可以屏蔽和禁止未经同意的访问。</p><p>另一方面，iptables 是一个用户态程序，可以用来配置 Linux 内核防火墙的 IP 数据包过滤规则。</p><p>iptables 是作为不同的 Netfilter 模块实现的。</p><p>可以使用 iptables CLI 即时修改过滤规则，并将它们插入 netfilters 挂载点。</p><p>过滤器配置在不同的表中，其中包含用于处理网络流量数据包的链。</p><p>不同的协议使用不同的内核模块和程序。</p><blockquote><p>当提到 iptables 时，通常指的是 IPv4。对于 IPv6 ，终端工具是 ip6tables。</p></blockquote><p>iptables 有五种链，每一种链都直接映射到 Netfilter 的钩子上。</p><p>从 iptables 的角度来看，它们是：</p><ul><li><code>PRE_ROUTING</code></li><li><code>INPUT</code></li><li><code>FORWARD</code></li><li><code>OUTPUT</code></li><li><code>POST_ROUTING</code></li></ul><p>它们对应地映射到 Netfilter 钩子：</p><ul><li><code>NF_IP_PRE_ROUTING</code></li><li><code>NF_IP_LOCAL_IN</code></li><li><code>NF_IP_FORWARD</code></li><li><code>NF_IP_LOCAL_OUT</code></li><li><code>NF_IP_POST_ROUTING</code></li></ul><p>当一个数据包到达时，根据它所处的阶段，将 “触发” 一个 Netfilter 钩子。这个钩子会执行特定的 iptables 过滤规则。</p><p><img src=/blog/images/2022/09/k8s-network-25.svg alt></p><p>哎呀！看起来很复杂！</p><p>不过没什么好担心的。</p><p>这就是我们使用 Kubernetes 的原因，以上所有内容都是通过使用 Service 抽象出来的，并且一个简单的 YAML 定义可以自动设置这些规则。</p><p>如果你有兴趣查看 iptables 规则，可以连接到节点并运行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>iptables-save
</span></span></code></pre></td></tr></table></div></div><p>你还可以使用<a href=https://github.com/Nudin/iptable_vis>这个工具来可视化</a>节点上的 iptables 链。</p><p>这是来自 GKE 节点上的可视化 iptables 链的示例图：</p><p><img src=/blog/images/2022/09/k8s-network-26.svg alt></p><p>注意，这里可能配置了几百条规则，想想一下自己动手怎么配置！</p><p>至此，我们已经了解了，相同节点上的 Pod 和不同节点上 Pod 之间是如何通信的。</p><p>在 Pod 与 Service 的通信中，链路的前半部分是一样的。</p><p><img src=/blog/images/2022/09/k8s-network-27.svg alt></p><p>当请求从 Pod-A 走向 Pod-B 时，由于 Pod-B 在 Service 的 &ldquo;后面&rdquo;，在传输的过程中，会有一些不一样。</p><p>原始的请求，在 Pod-A 命名空间的 eth0 接口发出。</p><p>接着，请求通过 <code>veth</code>到达根名称空间的网桥。</p><p>一旦到达网桥，数据包就会立即通过默认网关转发。</p><p>与 Pod-to-Pod 部分一样，主机进行按位比较。由于服务的虚拟 IP 不是节点 CIDR 的一部分，因此数据包将立即通过默认网关转发。</p><p>如果默认网关的 MAC 地址尚未出现在查找表中，则会进行 ARP 解析找出默认网关的 MAC 地址。</p><p>现在神奇的事情发生了。</p><p>在数据包通过节点的路由之前，Netfilter 的 <code>NF_IP_PRE_ROUTING</code> 挂钩被触发，并执行 iptables 规则。这个规则会修改 Pod-A 数据包的目标 IP 地址 DNAT。</p><p><img src=/blog/images/2022/09/k8s-network-28.svg alt></p><p>前面服务的虚拟 IP 地址被重写为 Pod-B 的 IP 地址。</p><p>接下来，数据包路由过程与 Pod 到 Pod 的通信一样。</p><p><img src=/blog/images/2022/09/k8s-network-29.svg alt></p><p>数据包重写后，通信是 Pod 到 Pod。</p><p>然而，在所有这些通信中，使用了一个第三方的功能。</p><p><a href=https://www.linuxtopia.org/Linux_Firewall_iptables/x1298.html>此功能称为 conntrack</a> 或链路跟踪。</p><p>当 Pod-B 发回响应时，conntrack 会将数据包与链路相关联，并跟踪其来源。</p><p>NAT 严重依赖于 conntrack。</p><p>如果没有链路跟踪，将不知道将包含响应的数据包发回何处。</p><p>使用 conntrack 时，数据包的返回路径很容易设置为相同的源或目标 NAT 更改。</p><p>通信的另一部分与现在的链路相反。</p><p>Pod-B 接收并处理了请求，现在将数据发送回 Pod-A。</p><p>现在会发生什么呢？</p><h2 id=检查来自服务的响应>检查来自服务的响应</h2><p>Pod-B 发送响应，将其 IP 地址设置为源地址，并将 Pod-A 的 IP 地址设置为目标地址。</p><p><img src=/blog/images/2022/09/k8s-network-30.svg alt></p><p>当数据包到达 Pod-A 所在节点的接口时，会发生另一个 NAT。</p><p><img src=/blog/images/2022/09/k8s-network-31.svg alt></p><p>这时，conntrack 开始工作，修改源 IP 地址，iptables 规则执行 SNAT，并将 Pod-B 的源 IP 地址修改为原始服务的虚拟 IP。</p><p><img src=/blog/images/2022/09/k8s-network-32.svg alt></p><p>对于 Pod-A 来说，响应是来自于 Service 而不是 Pod-B。</p><p>其余的都是一样的。一旦 SNAT 完成，数据包就会到达根命名空间中的网桥，并通过 <code>veth</code> 对转发到 <code>Pod-A</code>。</p><h2 id=总结一下>总结一下</h2><p>让我们一起回顾下本文相关要点</p><ul><li>容器如何在本地或 Pod 内通信。</li><li>在相同节点和不同节点上的 Pod 如何通信。</li><li>Pod-to-Service - Pod 如何将流量发送到 Kubernetes 中服务后面的 Pod 时。</li><li>什么是命名空间、veth、iptables、chains、conntrack、Netfilter、CNI、overlay 网络，以及 Kubernetes 网络工具箱中所需的一切。</li></ul></article><script defer src=/js/clipboard.min.1626706afc88d95ebe1173b553ec732c6dc82a576989315fdf5e7779af738a44.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script>"use strict";document.addEventListener("DOMContentLoaded",function(){var e=!1,t=document.querySelectorAll("pre.chroma"),n=document.querySelectorAll(".language-code"),s=document.querySelectorAll("div.language-\\$"),o=document.querySelectorAll("div.language-\\>"),i=function(t){var s,o,i,a,r,c,l,d=t,n=t.textContent;if(n.length>15){e||(a=new ClipboardJS(".copy-to-clipboard",{text:function(e){var t=prev(e).querySelectorAll("code");return t.length>1?n=prev(e).querySelector('code[class^="language-"]').textContent:n=prev(e).querySelector("code").textContent,n.replace(/^\$\s/gm,"")}}),a.on("success",function(e){e.clearSelection(),l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label","Copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),a.on("error",function(e){l=prop(e.trigger.parentNode,"tagName")=="PRE",e.trigger.setAttribute("aria-label",e.action.toString()),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-w")}),e=!0),r=["language-mermaid","language-viz","language-wave","language-chart","language-msc","language-flowchart"],c=!1,s=d.getAttribute("class");for(o=0;o<r.length;o++)if(s&&s.startsWith(r[o])){c=!0;break}c||s&&(i=document.createElement("span"),i.setAttribute("class","copy-to-clipboard"),i.setAttribute("title","Copy to clipboard"),t.parentNode.parentNode.insertBefore(i,t.parentNode.nextElementSibling))}},a=function(e){var t=document.createElement("span");t.setAttribute("class","copy-to-clipboard"),t.setAttribute("title","Copy to clipboard"),e.parentNode.parentNode.insertBefore(t,e.parentNode.nextElementSibling)};t?t.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,n?n.forEach(function(e){e.querySelectorAll("code").forEach(function(e){i(e)})}):null,s?s.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null,o?o.forEach(function(e){e.querySelectorAll("code").forEach(function(e){a(e)})}):null})</script><script>"use strict";function wrap(e,t){e.parentNode.insertBefore(t,e),t.appendChild(e)}(function(){var e=document.querySelector(".single__contents");e?e.querySelectorAll("pre > code").forEach(function(e){var t=e.getAttribute("data-lang"),n=document.createElement("div"),o=null,s=null;t&&t.includes(":")?(o=t.split(":")[0],s=t.split(":")[1],n.className="language-"+o,n.setAttribute("data-lang",s),e.className="language-"+o,e.setAttribute("data-lang",s),e.setAttribute("id",s)):t||(n.setAttribute("data-lang","Code"),n.className="language-code"),(!t||s)&&wrap(e.parentNode,n)}):null})();var langCodeElem=document.querySelectorAll(".language-code"),dollarCodeElem,gtCodeElem;langCodeElem?langCodeElem.forEach(function(e){var t=document.createElement("span");t.className="copy-to-clipboard",t.setAttribute("title","Copy to clipboard"),e.append(t)}):null,dollarCodeElem=document.querySelectorAll("div.language-\\$"),gtCodeElem=document.querySelectorAll("div.language-\\>"),dollarCodeElem?dollarCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="$<br/>"}):null}):null,gtCodeElem?gtCodeElem.forEach(function(e){var t=e.parentNode.parentNode?e.parentNode.parentNode.querySelectorAll(".lnt"):null;t?t.forEach(function(e){e.innerHTML="><br/>"}):null}):null</script><div class=whoami__gutter></div><hr class="hr-slash whoami-hr"><section class=whoami><div class=whoami__image-wrapper><img data-src=/static/images/chenshaowen.jpg src="data:image/svg+xml,%0A%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='none' d='M0 0h24v24H0V0z'/%3E%3Cpath fill='%23aaa' d='M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h12c.55 0 1 .45 1 1v12c0 .55-.45 1-1 1zm-4.44-6.19l-2.35 3.02-1.56-1.88c-.2-.25-.58-.24-.78.01l-1.74 2.23c-.26.33-.02.81.39.81h8.98c.41 0 .65-.47.4-.8l-2.55-3.39c-.19-.26-.59-.26-.79 0z'/%3E%3C/svg%3E" alt=微信公众号 class="lazyload whoami__image"></div><div class=whoami__contents><div class=whoami__written-by>作者</div><div class=whoami__title>微信公众号</div><div class=whoami__desc></div><div class=whoami__social></div></div></section><hr class="hr-slash whoami-hr"><section class=related><h1 class=related__title><hr class=hr-dots><div>相关内容</div><hr class=hr-dots></h1><ul class=related-ul><li><a href=/blog/insight-kubernetes-network-by-kindling.html class=related__link>使用 Kindling 观测 Kubernetes 的网络连接</a></li><li><a href=/blog/a-global-images-distribution-network.html class=related__link>面向全球的镜像分发网络</a></li><li><a href=/blog/how-to-use-cilium-to-replace-calico.html class=related__link>使用 Cilium 替换 Calico</a></li><li><a href=/blog/how-to-switch-data-plane-to-ebpf.html class=related__link>Calico 下如何切换数据面到 eBPF</a></li><li><a href=/blog/how-to-configure-networkpolicy-for-nodeport.html class=related__link>在 Kubernetes 中如何给 NodePort 配置 NetworkPolicy</a></li></ul></section><div class=grow></div><nav class=pagination-single><a href=https://www.chenshaowen.com/blog/sre-to-left-devops-to-right.html class=pagination-single__left><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M19 11H7.83l4.88-4.88c.39-.39.39-1.03.0-1.42s-1.02-.39-1.41.0l-6.59 6.59c-.39.39-.39 1.02.0 1.41l6.59 6.59c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L7.83 13H19c.55.0 1-.45 1-1s-.45-1-1-1z"/></svg></div><div class=pagination-single__left-title>SRE 向左，DevOps 向右</div></a><div class=grow></div><a href=https://www.chenshaowen.com/blog/how-to-repair-the-kubernetes-cluster-after-changing-ip.html class=pagination-single__right><div class=pagination-single__right-title>如何修复变更 IP 之后的 Kubernetes 集群</div><div class=pagination-single__icon><svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path fill="currentcolor" d="M5 13h11.17l-4.88 4.88c-.39.39-.39 1.03.0 1.42.39.39 1.02.39 1.41.0l6.59-6.59c.39-.39.39-1.02.0-1.41l-6.58-6.6c-.39-.39-1.02-.39-1.41.0s-.39 1.02.0 1.41L16.17 11H5c-.55.0-1 .45-1 1s.45 1 1 1z"/></svg></div></a></nav><div class="modal micromodal-slide" id=modal aria-hidden=true><div class=modal__overlay tabindex=-1 data-micromodal-close><div class=modal__container role=dialog aria-modal=true aria-labelledby=modal-title><div class=modal__content id=modal-content><div id=mySwipe class=swipe><div class=swipe-wrap></div></div></div><span class=modal__items><span class=modal__header><div class=modal__paging title="Page Info" aria-label="Current Page"></div><div class="modal__icon modal__toolbar modal__toolbar--close" title=Close aria-label="Close Button" data-micromodal-close><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="25" height="25"><path fill="currentcolor" d="M21.734375 19.640625l-2.097656 2.09375C19.253906 22.121094 18.628906 22.121094 18.242188 21.734375L13 16.496094 7.761719 21.734375C7.375 22.121094 6.746094 22.121094 6.363281 21.734375l-2.097656-2.09375c-.386719-.386718999999999-.386719-1.011719.0-1.398437L9.503906 13 4.265625 7.761719c-.382812-.390625-.382812-1.019531.0-1.398438L6.363281 4.265625C6.746094 3.878906 7.375 3.878906 7.761719 4.265625L13 9.507813l5.242188-5.242188c.386718000000002-.386719 1.015625-.386719 1.394531.0l2.097656 2.09375C22.121094 6.746094 22.121094 7.375 21.738281 7.761719L16.496094 13l5.238281 5.242188C22.121094 18.628906 22.121094 19.253906 21.734375 19.640625z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--full" title="Full Screen" aria-label="Full Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="25" height="25"><path fill="currentcolor" d="M5 3C3.9069372 3 3 3.9069372 3 5V8A1.0001 1.0001.0 105 8V5H8A1.0001 1.0001.0 108 3H5zM16 3a1.0001 1.0001.0 100 2h3V8a1.0001 1.0001.0 102 0V5C21 3.9069372 20.093063 3 19 3H16zM3.984375 14.986328A1.0001 1.0001.0 003 16v3c0 1.093063.9069372 2 2 2H8a1.0001 1.0001.0 100-2H5V16A1.0001 1.0001.0 003.984375 14.986328zm16 0A1.0001 1.0001.0 0019 16v3H16a1.0001 1.0001.0 100 2h3C20.093063 21 21 20.093063 21 19V16a1.0001 1.0001.0 00-1.015625-1.013672z"/></svg></div><div class="modal__icon modal__toolbar modal__toolbar--normal" title="Normal Screen" aria-label="Normal Screen Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="25" height="25"><path fill="currentcolor" d="M16.96875 4.972656C15.867188 4.988281 14.984375 5.894531 15 7v8H7C6.277344 14.988281 5.609375 15.367188 5.246094 15.992188 4.878906 16.613281 4.878906 17.386719 5.246094 18.007813 5.609375 18.632813 6.277344 19.011719 7 19H19V7C19.007813 6.460938 18.796875 5.941406 18.414063 5.558594 18.03125 5.175781 17.511719 4.964844 16.96875 4.972656zm16 0c-1.046875.015625-1.90625.839844-1.964844 1.886719C31 6.90625 31 6.953125 31 7V19H43C43.066406 19 43.132813 19 43.199219 18.992188 44.269531 18.894531 45.070313 17.972656 45.015625 16.902344 44.964844 15.828125 44.074219 14.988281 43 15H35V7C35.007813 6.460938 34.796875 5.941406 34.414063 5.558594 34.03125 5.175781 33.511719 4.964844 32.96875 4.972656zM7 31C6.277344 30.988281 5.609375 31.367188 5.246094 31.992188 4.878906 32.613281 4.878906 33.386719 5.246094 34.007813 5.609375 34.632813 6.277344 35.011719 7 35h8v8C14.988281 43.722656 15.367188 44.390625 15.992188 44.753906 16.613281 45.121094 17.386719 45.121094 18.007813 44.753906 18.632813 44.390625 19.011719 43.722656 19 43V31zm24 0V43C30.988281 43.722656 31.367188 44.390625 31.992188 44.753906 32.613281 45.121094 33.386719 45.121094 34.007813 44.753906 34.632813 44.390625 35.011719 43.722656 35 43V35h8C43.722656 35.011719 44.390625 34.632813 44.753906 34.007813 45.121094 33.386719 45.121094 32.613281 44.753906 31.992188 44.390625 31.367188 43.722656 30.988281 43 31z"/></svg></div></span><div class="modal__icon modal__arrow modal__arrow--left" title="Arrow Left" aria-label="Arrow Left Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M23.28125 11 10 10V6.851563C10 6.523438 9.839844 6.277344 9.519531 6.03125 9.199219 5.949219 8.878906 5.949219 8.640625 6.113281c-3.28125 2.296875-6.402344 6.144532-6.480469 6.308594-.078125.15625-.152343.390625-.15625.554688000000001C2.003906 12.980469 2 12.988281 2 12.992188 2 13.15625 2.078125 13.402344 2.160156 13.484375 2.238281 13.648438 5.28125 17.507813 8.640625 19.804688 8.960938 19.96875 9.28125 20.050781 9.519531 19.886719 9.839844 19.722656 10 19.476563 10 19.148438V16l13.28125-1C23.679688 14.679688 24 13.875 24 12.992188 24 12.195313 23.761719 11.320313 23.28125 11z"/></svg></div><div class="modal__icon modal__arrow modal__arrow--right" title="Arrow Right" aria-label="Arrow Right Button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="28" height="28"><path fill="currentcolor" d="M2.71875 11.023438l13.28125-1V6.875C16 6.546875 16.160156 6.300781 16.480469 6.054688 16.800781 5.972656 17.121094 5.972656 17.359375 6.136719c3.28125 2.296875 6.402344 6.144531 6.480469 6.308594.078125.15625.152343999999999.390625.15625.554687C23.996094 13.003906 24 13.011719 24 13.015625 24 13.179688 23.921875 13.425781 23.839844 13.507813 23.761719 13.671875 20.71875 17.53125 17.359375 19.828125 17.039063 19.992188 16.71875 20.074219 16.480469 19.910156 16.160156 19.746094 16 19.5 16 19.171875V16.023438L2.71875 15.023438C2.320313 14.703125 2 13.898438 2 13.015625c0-.796875.238281-1.671875.71875-1.992187z"/></svg></div><div class=modal__caption><div class=modal__caption--text></div></div></span></div></div></div><script defer src=/js/swipe.min.feb438efb7ca009ecd7fc2ac3ad2fced4840990b2798d81f87137f2dc6281f05.js></script>
<script defer src=/js/micromodal.min.de01b44b2f383056bbcaf6ee921fd385d79108ec1129afd0eb2f3f5a07e11f45.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script>document.addEventListener("DOMContentLoaded",function(){var e,t,n,o,i,a,r,c,l,d,u,h,f,p,g,v,b,s=document.documentElement;function j(){s.requestFullscreen?s.requestFullscreen():s.mozRequestFullScreen?s.mozRequestFullScreen():s.webkitRequestFullscreen?s.webkitRequestFullscreen():s.msRequestFullscreen&&s.msRequestFullscreen()}function m(){(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)&&(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen())}c=document.getElementById("modal"),i=document.querySelector(".gallery__container"),v=document.querySelector(".swipe-wrap"),b=document.getElementById("mySwipe"),u=document.querySelector(".modal__arrow--left"),f=document.querySelector(".modal__arrow--right"),h=document.querySelector(".modal__toolbar--close"),t=document.querySelector(".modal__toolbar--full"),n=document.querySelector(".modal__toolbar--normal"),r=document.querySelector(".modal__caption"),d=document.querySelector(".modal__paging"),o=document.querySelector(".modal__items"),a=null,l=null,e=null,p=function(t){t.key==="ArrowRight"?c&&c.classList.contains("is-open")&&e.next():t.key==="ArrowLeft"&&c&&c.classList.contains("is-open")&&e.prev()},i?a=i.querySelectorAll("img").length:(i=document.querySelector(".single__contents"),a=i.querySelectorAll("img").length),MicroModal.init({onClose:function(){e&&(e.kill(),e=null,m()),window.removeEventListener("keydown",p)},disableScroll:!0,disableFocus:!0,awaitOpenAnimation:!1,awaitCloseAnimation:!1,debugMode:!1}),g=function(e){return new Promise(function(t,n){var s=new Image;s.onload=function(){t(s)},s.onerror=n,s.src=e})},i.querySelectorAll("img").forEach(function(s,i){s.style.cursor="pointer";var c,u=s.cloneNode(!0);u.style.maxHeight="100%",u.style.maxWidth="100%",u.onclick=function(e){e.stopPropagation()},c=document.createElement("div"),c.style.width="100%",c.style.height="100vh",c.setAttribute("data-micromodal-close",""),c.onclick=function(){e&&(e.kill(),e=null)},c.onmouseenter=function(){clearTimeout(l),fadeIn(o,200)},c.onmouseleave=function(){l=setTimeout(function(){fadeOut(o,200)},2500)},c.ontouchstart=function(){fadeIn(o,200)},c.append(u),v.append(c),s.addEventListener("click",async function(s){MicroModal.show("modal"),e&&(e.kill(),e=null);var c,m=s.target.getAttribute("data-src")||s.target.getAttribute("src"),h=await g(m);u.style.width=h.width+"px",u.style.height=h.height+"px",e=new Swipe(b,{startSlide:i,draggable:!0,autoRestart:!1,continuous:!1,disableScroll:!0,stopPropagation:!0,callback:async function(e,t){var s,n=t.querySelector("img"),c=n.getAttribute("data-src")||n.getAttribute("src"),i=await g(c);n.style.width=i.width+"px",n.style.height=i.height+"px",r&&n&&(s=null,n.getAttribute("data-caption")?s=n.getAttribute("data-caption"):n.getAttribute("title")?s=n.getAttribute("title"):n.getAttribute("alt")?s=n.getAttribute("alt"):s=n.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=s,d.innerText=e+1+" / "+a,clearTimeout(l),fadeIn(o,200))}}),fadeIn(o),r&&(c=null,s.target.getAttribute("data-caption")?c=s.target.getAttribute("data-caption"):s.target.getAttribute("title")?c=s.target.getAttribute("title"):s.target.getAttribute("alt")?c=s.target.getAttribute("alt"):c=s.target.getAttribute("src"),r.querySelector(".modal__caption--text").innerText=c,d.innerText=i+1+" / "+a),n&&t&&(n.style.zIndex=-1,n.style.opacity=0,t.style.zIndex=25,t.style.opacity=1)}),window.addEventListener("keydown",p)}),u?u.addEventListener("click",function(){e&&e.prev()}):null,f?f.addEventListener("click",function(){e&&e.next()}):null,h?h.addEventListener("click",function(){e&&(e.kill(),e=null),m(),MicroModal.close("modal")}):null,t?t.addEventListener("click",function(){j(),n&&(n.style.zIndex=25,n.style.opacity=1,t.style.zIndex=-1,t.style.opacity=0)}):null,n?n.addEventListener("click",function(){m(),t&&(t.style.zIndex=25,t.style.opacity=1,n.style.zIndex=-1,n.style.opacity=0)}):null})</script><div class=hide><div class=search><span class=icon><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentcolor" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0V0z"/><path d="M15.5 14h-.79l-.28-.27c1.2-1.4 1.82-3.31 1.48-5.34-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.79 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59 2.03.34 3.94-.28 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49.0s.41-1.08.0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg></span><input id=search aria-label="Site Search" class=input type=text placeholder=搜索 autocomplete=off><div id=search-results class=dropdown><div id=search-menu class=dropdown-menu role=menu></div></div></div></div></div></main><aside class="single__side main-side"><section class="sidebar hide"><script>document.querySelector(".sidebar").classList.remove("hide")</script><div class=toc__flexbox data-position=fixed><h6 class=toc__title data-ani=true>目录</h6><label class=switch data-ani=true><input id=toggle-toc aria-label="Toggle TOC" type=checkbox checked>
<span class="slider round"></span></label></div><div class=toc data-dir=ltr data-folding=true data-ani=true><nav id=TableOfContents><ul><li><a href=#kubernetes-网络要求>Kubernetes 网络要求</a></li><li><a href=#linux-网络命名空间如何在-pod-中工作>Linux 网络命名空间如何在 Pod 中工作</a></li><li><a href=#在-pod-中pause-容器创建了网络命名空间>在 Pod 中，pause 容器创建了网络命名空间</a></li><li><a href=#分配一个-ip-地址给-pod>分配一个 IP 地址给 Pod</a></li><li><a href=#查看集群中-pod-到-pod-的流量>查看集群中 Pod 到 Pod 的流量</a></li><li><a href=#pod-网络命名空间连接到以太网桥>Pod 网络命名空间连接到以太网桥</a></li><li><a href=#跟踪在同一节点上-pod-到-pod-的流量>跟踪在同一节点上 Pod 到 Pod 的流量</a></li><li><a href=#跟踪不同节点上的-pod-到-pod-通信>跟踪不同节点上的 Pod 到 Pod 通信</a></li><li><a href=#按位运算的工作原理>按位运算的工作原理</a></li><li><a href=#容器网络接口---cni>容器网络接口 - CNI</a></li><li><a href=#检查-pod-到-service-的流量>检查 Pod 到 Service 的流量</a></li><li><a href=#使用-netfilter-和-iptables-拦截和重写流量>使用 Netfilter 和 Iptables 拦截和重写流量</a></li><li><a href=#检查来自服务的响应>检查来自服务的响应</a></li><li><a href=#总结一下>总结一下</a></li></ul></nav></div></section></aside><script>var enableToc=JSON.parse("true"),toc=JSON.parse("null"),tocPosition=JSON.parse('"inner"'),singleMainElem=document.querySelector(".single__main"),singleSideElem=document.querySelector(".single__side");enquire.register("screen and (max-width: 769px)",{match:function(){(enableToc||toc)&&tocPosition!=="outer"?singleMainElem&&singleSideElem&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main"),singleSideElem.classList.remove("main-side"),singleSideElem.classList.add("hide")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"))},unmatch:function(){(enableToc||toc)&&tocPosition!=="outer"?(singleMainElem.classList.remove("main"),singleMainElem.classList.add("main-main"),singleSideElem.classList.remove("hide"),singleSideElem.classList.add("main-side")):tocPosition==="outer"&&(singleMainElem&&!singleMainElem.classList.contains("main-main")&&(singleMainElem.classList.remove("main-main"),singleMainElem.classList.add("main")),singleSideElem&&!singleSideElem.classList.contains("hide")&&singleSideElem.classList.add("hide"));var t=document.querySelector(".navbar__burger"),e=document.getElementsByClassName("navbarm__collapse")[0];e&&(e.setAttribute("data-open",!1),e.style.maxHeight=0,t.classList.remove("is-active")),document.getElementsByClassName("navbar__menu")[0].classList.remove("is-active"),document.getElementsByClassName("mobile-search")[0].classList.add("hide")},setup:function(){},deferSetup:!0,destroy:function(){}})</script><script defer src=/js/helper/getParents.min.js></script>
<script defer src=/js/helper/closest.min.js></script>
<script defer src=/js/helper/prev.min.js></script>
<script defer src=/js/helper/prop.min.js></script>
<script defer src=/js/helper/fadeinout.min.js></script>
<script defer src=/js/helper/throttle.min.js></script>
<script>"use strict";window.onload=function(){var e,t,n,s,o,i,r,c,l,d,u,h,m,f,p,g,v,b,j,y,_,w,O,x,C,E,k,A,S,M,F,T,z,D,N,H,a=document.querySelector(".navbar"),P=document.querySelector(".single__contents"),R=JSON.parse("false"),L=JSON.parse("true");R&&L&&(y=document.querySelector("#busuanzi_value_page_pv"),y.textContent=y.textContent.replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")),S=JSON.parse("true"),z=JSON.parse("null"),D=JSON.parse("false"),d=document.querySelector(".toc__flexbox"),u=document.querySelector(".toc__flexbox--outer"),x=JSON.parse("true"),(S||z)&&document.querySelector(".toc")&&(i=document.querySelector(".toc").querySelector("#TableOfContents"),i.onmouseenter=function(){a.classList.contains("scrolling")&&a.classList.remove("scrolling")},i.onmouseleave=function(){a.classList.contains("scrolling")||a.classList.add("scrolling")},!1===x||(i.querySelectorAll("ul")?i.querySelectorAll("ul").forEach(function(e){e.querySelectorAll("li").forEach(function(e){e.querySelectorAll("ul").forEach(function(e){e.style.display="none"})})}):null),i&&(i.querySelectorAll("a").length>0?i.querySelectorAll("a").forEach(function(e){e.addEventListener("click",function(){var t,n=e.getAttribute("id");a.classList.contains("scrolling")||(a.classList.remove("navbar--show"),a.classList.remove("navbar--hide"),a.classList.add("navbar--hide")),document.querySelector(".toc").querySelectorAll("a").forEach(function(e){e.classList.remove("active")}),e.classList.add("active"),t=i.querySelector('[href="#'+n+'"]'),t&&t.nextElementSibling&&(t.nextElementSibling.style.display="block"),t&&(getParents(t,"ul")?getParents(t,"ul").forEach(function(e){e.style.display="block"}):null)})}):(d&&(d.setAttribute("data-position",""),d.classList.contains("hide")||d.classList.add("hide")),u&&(u.setAttribute("data-position",""),u.classList.contains("hide")||u.classList.add("hide")))),b=document.getElementById("toggle-toc"),v=document.getElementById("visible-toc"),s=document.querySelector(".toc"),o=document.querySelector("main"),l=document.querySelector("side"),c=document.querySelector(".toc__flexbox"),b?b.addEventListener("change",function(e){e.target.checked?(s&&fadeIn(s,200),c&&c.setAttribute("data-position","fixed"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main-main")),l&&l.classList.remove("main-side")):(s&&fadeOut(s,200),c&&c.setAttribute("data-position","absolute"),o&&(o.classList.remove("main-main"),o.classList.remove("main"),o.classList.add("main")),l&&l.classList.remove("main-side"))}):null,v?v.addEventListener("change",function(e){e.target.checked?s&&fadeIn(s,200):s&&fadeOut(s,200)}):null),C=120,M=70,A=function(){s&&(s.style.maxHeight=window.innerHeight-C-M+"px")},w=throttle(A,300),w(),window.addEventListener("resize",w),E=new ClipboardJS(".anchor"),j=P.querySelectorAll("h1, h2, h3, h4"),F=JSON.parse('"ltr"'),j?j.forEach(function(e){var t,s=parseInt(e.tagName.substr(1),10)*2,o=encodeURI(document.location.origin+document.location.pathname),i=o+"#"+e.getAttribute("id"),n=document.createElement("span");n.classList.add("anchor"),n.classList.add("hide"),n.setAttribute("data-clipboard-text",decodeURI(i)),n.style.position="relative",t=document.createElement("span"),t.style.position="absolute",t.style.top="50%",t.style.left="0.75rem",t.style.transform="translateY(-50%)",t.innerHTML=`
<svg fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${32-s}px" height="${32-s}px"><path d="M 5.5625 0 C 4.136719 0 2.707031 0.542969 1.625 1.625 C -0.539063 3.789063 -0.539063 7.335938 1.625 9.5 L 5.28125 13.15625 C 5.667969 13.554688 6.304688 13.558594 6.703125 13.171875 C 7.101563 12.785156 7.105469 12.148438 6.71875 11.75 L 3.03125 8.0625 C 1.632813 6.664063 1.632813 4.429688 3.03125 3.03125 C 4.429688 1.632813 6.664063 1.632813 8.0625 3.03125 L 12.96875 7.9375 C 14.367188 9.335938 14.367188 11.570313 12.96875 12.96875 C 12.804688 13.132813 12.621094 13.25 12.4375 13.375 C 11.980469 13.6875 11.859375 14.308594 12.171875 14.765625 C 12.484375 15.222656 13.105469 15.34375 13.5625 15.03125 C 13.847656 14.835938 14.125 14.625 14.375 14.375 C 16.539063 12.210938 16.539063 8.664063 14.375 6.5 L 9.5 1.625 C 8.417969 0.542969 6.988281 0 5.5625 0 Z M 10.78125 8.875 C 10.738281 8.882813 10.695313 8.894531 10.65625 8.90625 C 10.507813 8.9375 10.371094 9 10.25 9.09375 C 10.039063 9.253906 9.820313 9.429688 9.625 9.625 C 7.460938 11.789063 7.460938 15.335938 9.625 17.5 L 14.5 22.375 C 16.664063 24.539063 20.210938 24.539063 22.375 22.375 C 24.539063 20.210938 24.539063 16.664063 22.375 14.5 L 18.71875 10.875 C 18.476563 10.578125 18.089844 10.441406 17.714844 10.527344 C 17.34375 10.613281 17.050781 10.90625 16.964844 11.277344 C 16.878906 11.652344 17.015625 12.039063 17.3125 12.28125 L 20.96875 15.9375 C 22.367188 17.335938 22.367188 19.570313 20.96875 20.96875 C 19.570313 22.367188 17.335938 22.367188 15.9375 20.96875 L 11.03125 16.0625 C 9.632813 14.664063 9.632813 12.429688 11.03125 11.03125 C 11.152344 10.90625 11.300781 10.820313 11.4375 10.71875 C 11.839844 10.472656 12.015625 9.976563 11.855469 9.53125 C 11.699219 9.085938 11.25 8.8125 10.78125 8.875 Z"/></svg>`,F==="rtl"?t.style.left="-2rem":t.style.right="-2rem",n.append(t),e.append(n),e.addEventListener("mouseenter",function(){this.querySelector(".anchor").classList.remove("hide")}),e.addEventListener("mouseleave",function(){this.querySelector(".anchor").classList.add("hide")})}):null,document.querySelectorAll(".anchor").forEach(function(e){e.addEventListener("mouseleave",function(){e.setAttribute("aria-label",null),e.classList.remove("tooltipped"),e.classList.remove("tooltipped-s"),e.classList.remove("tooltipped-w")})}),E.on("success",function(e){e.clearSelection(),e.trigger.setAttribute("aria-label","Link copied to clipboard!"),e.trigger.classList.add("tooltipped"),e.trigger.classList.add("tooltipped-s")}),t=JSON.parse("null"),t&&t.includes("mermaid")&&(O=localStorage.getItem("theme")||JSON.parse('"light"'),O==="dark"||O==="hacker"?mermaid.initialize({theme:"dark"}):mermaid.initialize({theme:"default"}),_=[],[].push.apply(_,document.getElementsByClassName("language-mermaid")),_.forEach(function(e){var n,t=e.parentNode;t!==document.body&&(t.parentNode.insertBefore(e,t),t.parentNode.removeChild(t)),n=document.createElement("div"),n.classList.add("mermaid"),n.style.padding="34px 4px 6px",n.innerHTML=e.innerHTML,e.replaceWith(n)})),t&&t.includes("katex")&&(N=document.getElementsByClassName("math"),r={delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]},renderMathInElement(document.querySelector(".single__contents"),r)),t&&t.includes("flowchartjs")&&(r=JSON.parse('{"arrow-end":"block","element-color":"black","fill":"white","flowstate":{"approved":{"fill":"#58C4A3","font-size":12,"no-text":"n/a","yes-text":"APPROVED"},"current":{"fill":"yellow","font-color":"red","font-weight":"bold"},"future":{"fill":"#FFFF99"},"invalid":{"fill":"#444444"},"past":{"fill":"#CCCCCC","font-size":12},"rejected":{"fill":"#C45879","font-size":12,"no-text":"REJECTED","yes-text":"n/a"},"request":{"fill":"blue"}},"font-color":"black","font-size":14,"line-color":"black","line-length":50,"line-width":3,"no-text":"no","scale":1,"symbols":{"end":{"class":"end-element"},"start":{"element-color":"green","fill":"yellow","font-color":"red"}},"text-margin":10,"x":0,"y":0,"yes-text":"yes"}'),n=null,T="language-flowchart",e=0,Array.prototype.forEach.call(document.querySelectorAll("[class^="+T+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="flowchart"+e,t.parentNode.insertBefore(s,t),o=flowchart.parse(n),o.drawSVG("flowchart"+e,r),e+=1})),document.querySelectorAll("mjx-container").forEach(function(e){e.parentElement.classList+="has-jax"}),t&&t.includes("msc")&&(r=JSON.parse('{"theme":"hand"}'),n=null,e=0,h="language-msc",Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var o,s=document.createElement("div");s.id="msc"+e,t.parentNode.insertBefore(s,t),o=Diagram.parse(n),o.drawSVG("msc"+e,r),e+=1})),t&&t.includes("chart")&&(m="#666",f="#ddd",p=2,Chart.defaults.global.elements.rectangle.borderWidth=p,Chart.defaults.global.elements.rectangle.borderColor=m,Chart.defaults.global.elements.rectangle.backgroundColor=f,Chart.defaults.global.elements.line.borderWidth=p,Chart.defaults.global.elements.line.borderColor=m,Chart.defaults.global.elements.line.backgroundColor=f,Chart.defaults.global.elements.point.borderWidth=p,Chart.defaults.global.elements.point.borderColor=m,Chart.defaults.global.elements.point.backgroundColor=f,h="language-chart",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+h+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var i,a,s=document.createElement("canvas"),o=null;s.height=200,s.style.height=200,s.id="myChart"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),i=document.getElementById("myChart"+e).getContext("2d"),a=new Chart(i,o),e+=1})),t&&t.includes("wavedrom")&&(k="language-wave",e=0,n=null,Array.prototype.forEach.call(document.querySelectorAll("[class^="+k+"]"),function(t){t.style.display="none",t.parentNode.style.backgroundColor="transparent",n=t.innerText;var s=document.createElement("div"),o=null;s.id="WaveDrom_Display_"+e,o=JSON.parse(n),t.parentNode.insertBefore(s,t),WaveDrom.RenderWaveForm(e,o,"WaveDrom_Display_"),e+=1})),t&&t.includes("viz")&&(g="language-viz-",Array.prototype.forEach.call(document.querySelectorAll("[class^="+g+"]"),function(e){e.style.display="none",e.parentNode.style.backgroundColor="transparent",e.getAttribute("class").split(" ").forEach(function(e){e.startsWith(g)&&(t=e.substr(g.length))});var t,n=new Viz;n.renderSVGElement(e.innerText,{engine:t}).then(function(t){t.style.width="100%",e.parentNode.insertBefore(t,e)})}))}</script><footer class=footer><div id=gtt><div class=gtt><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"><path fill="currentcolor" d="M8.12 14.71 12 10.83l3.88 3.88c.39.39 1.02.39 1.41.0s.39-1.02.0-1.41L12.7 8.71c-.39-.39-1.02-.39-1.41.0L6.7 13.3c-.39.39-.39 1.02.0 1.41.39.38 1.03.39 1.42.0z"/></svg></div></div><hr><div class="basicflex flexwrap"><a href=https://beian.miit.gov.cn/ class=footer__link target=_blank rel=noreferrer>鄂ICP备15009848号-4</a></div><div class=footer__poweredby><p class=caption>©2016 - 2025, All Rights Reserved.</p></div></footer></div><div class="wrapper__right hide" data-pad=true dir=ltr><script>document.querySelector(".wrapper__right").classList.remove("hide")</script></div></div></body></html>